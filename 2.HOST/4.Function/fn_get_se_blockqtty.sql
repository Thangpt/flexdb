CREATE OR REPLACE FUNCTION FN_GET_SE_BLOCKQTTY(PV_AFACCTNO IN VARCHAR2, PV_CODEID IN VARCHAR2, PV_TYPE IN VARCHAR2)
    RETURN NUMBER IS
-- Purpose: LAY SO LUONG CK BLOCK CO THE SU DUNG ( TRU DI SL CAM CO)
-- MODIFICATION HISTORY
-- Person      Date         Comments
-- ---------   ------       -------------------------------------------
-- THANHNM   01/02/2012     Created
    V_RESULT NUMBER;
	V_BLOCKQTTY NUMBER;
BEGIN
SELECT BLOCKED INTO V_BLOCKQTTY
    FROM SEMAST
    WHERE AFACCTNO = REPLACE(PV_AFACCTNO,'.','')
	AND CODEID = PV_CODEID;

SELECT SUM(QTTY - DFQTTY) INTO V_RESULT  FROM SEMASTDTL WHERE
	ACCTNO = REPLACE(PV_AFACCTNO,'.','') || PV_CODEID
	AND QTTYTYPE = PV_TYPE AND DELTD ='N'
	GROUP BY ACCTNO, QTTYTYPE;
IF V_RESULT<= V_BLOCKQTTY THEN
	RETURN V_RESULT;
	ELSE
	RETURN 0;
END IF;
RETURN V_RESULT;
EXCEPTION
   WHEN OTHERS THEN
    RETURN 0;
END;
/

