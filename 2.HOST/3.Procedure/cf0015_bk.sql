CREATE OR REPLACE PROCEDURE CF0015_bk (
   PV_REFCURSOR           IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   F_DATE         IN       VARCHAR2,
   T_DATE         IN       VARCHAR2,
   AFACCTNO       IN       VARCHAR2,
   ONL       VARCHAR2  DEFAULT  NULL,
   CURRENT_INDEX	 	 NUMBER  DEFAULT NULL,
   OFFSET_NUMBER	 	 NUMBER  DEFAULT NULL

  )
IS
--
-- PURPOSE: BRIEFLY EXPLAIN THE FUNCTIONALITY OF THE PROCEDURE
-- BAO CAO TAI KHOAN TIEN TONG HOP CUA NGUOI DAU TU
-- MODIFICATION HISTORY
-- PERSON      DATE    COMMENTS
-- NAMNT   20-DEC-06  CREATED
-- ---------   ------  -------------------------------------------

   CUR            PKG_REPORT.REF_CURSOR;
   V_STROPTION    VARCHAR2 (5);            -- A: ALL; B: BRANCH; S: SUB-BRANCH
   V_STRBRID      VARCHAR2 (4);                   -- USED WHEN V_NUMOPTION > 0
   V_STRAFACCTNO  VARCHAR2 (20);
   V_NUMSDDK      NUMBER (20, 2);
   V_NUMCTT       NUMBER (20, 2);
   V_NUMKQ        NUMBER (20, 2);
   V_NUMPT        NUMBER (20, 2);
   V_STRFULLNAME       VARCHAR2 (100);
   V_STRMOBILE         VARCHAR2 (20);
   V_STRLG              VARCHAR2 (20);
   V_DATE          DATE;
   V_D_CUR         DATE;

BEGIN

   V_STROPTION := OPT;

   IF (V_STROPTION <> 'A') AND (BRID <> 'ALL')
   THEN
      V_STRBRID := BRID;
   ELSE
      V_STRBRID := '%%';
   END IF;

   -- GET REPORT'S PARAMETERS

       V_STRAFACCTNO :=  AFACCTNO;

   -- END OF GETTING REPORT'S PARAMETERS
 --TINH THONG TIN KHACH HANG

 OPEN    CUR

FOR

SELECT CF.FULLNAME , CF.MOBILE,SUBSTR(CF.CUSTODYCD,4,1) LG
FROM AFMAST AF, CFMAST CF
WHERE AF.CUSTID =CF.CUSTID
AND AF.ACCTNO LIKE V_STRAFACCTNO
;

LOOP
  FETCH    CUR
  INTO V_STRFULLNAME, V_STRMOBILE ,V_STRLG;
  EXIT WHEN    CUR%NOTFOUND;
END LOOP;
CLOSE    CUR;

IF  ONL   IS NULL THEN

---XAC DINH NGAY HIEN TAI CO LA NGAY T_DATE KHONG
OPEN    CUR
FOR
SELECT TO_DATE(VARVALUE,'DD/MM/YYYY') FROM SYSVAR  WHERE VARNAME='CURRDATE';

LOOP
  FETCH    CUR
  INTO V_D_CUR ;
  EXIT WHEN    CUR%NOTFOUND;
END LOOP;
CLOSE    CUR;

--NGAY TINH TIEN CHO NHAN VE

IF  TO_DATE(T_DATE,'DD/MM/YYYY') < V_D_CUR THEN

OPEN    CUR
FOR
SELECT A.SBDATE
FROM(SELECT ROWNUM DAY,SBDATE
FROM(SELECT  SBDATE FROM SBCLDR
WHERE CLDRTYPE='001' AND HOLIDAY='N' AND
SBDATE < TO_DATE(T_DATE  ,'DD/MM/YYYY')   ORDER BY SBDATE  DESC )SBCLDR )A
WHERE A.DAY = 3;
--WHERE A.DAY = 4;

ELSE

OPEN    CUR
FOR
SELECT A.SBDATE
FROM(SELECT ROWNUM DAY,SBDATE
FROM(SELECT  SBDATE FROM SBCLDR
WHERE CLDRTYPE='001' AND HOLIDAY='N' AND
SBDATE < TO_DATE(T_DATE  ,'DD/MM/YYYY')   ORDER BY SBDATE  DESC )SBCLDR )A
--WHERE A.DAY = 3;
WHERE A.DAY = 4;

END IF;



--TINH NGAY NHAN THANH TOAN BU TRU

LOOP
  FETCH    CUR
  INTO V_DATE ;
  EXIT WHEN    CUR%NOTFOUND;
END LOOP;
CLOSE    CUR;


OPEN    CUR
    FOR
  SELECT NVL(SUM(STS.AMT),0) STS FROM
(
SELECT ACCTNO, AMT  AMT FROM STSCHD
WHERE DUETYPE ='RM' AND  TXDATE <= TO_DATE (T_DATE ,'DD/MM/YYYY')
AND TXDATE >V_DATE
AND ACCTNO LIKE V_STRAFACCTNO
and status ='N'
UNION ALL
SELECT ACCTNO,AMT  FROM STSCHDHIST
WHERE DUETYPE ='RM'  AND TXDATE <= TO_DATE (T_DATE  ,'DD/MM/YYYY')
AND TXDATE >  V_DATE
AND ACCTNO LIKE V_STRAFACCTNO
)STS
GROUP BY  STS.ACCTNO
;

LOOP
      FETCH    CUR
       INTO V_NUMCTT;
      EXIT WHEN    CUR%NOTFOUND;
   END LOOP;
   CLOSE    CUR;

-- TINH SO TIEN KY QUY
OPEN    CUR
    FOR
     SELECT  CI.BAMT  -  NVL(DTL.B,0)
      FROM (SELECT * FROM  CIMAST WHERE AFACCTNO  LIKE V_STRAFACCTNO)  CI
LEFT JOIN
      (
         SELECT SUM(A.AMT) B,A.ACCTNO  ACCTNO
         FROM (SELECT   SUM ((CASE WHEN APP.TXTYPE = 'D'THEN -TR.NAMT
                                   WHEN APP.TXTYPE = 'C' THEN TR.NAMT
                                   ELSE 0   END )) AMT,TR.ACCTNO ACCTNO
               FROM APPTX APP, CITRAN TR ,TLLOG TL
               WHERE TR.TXCD = APP.TXCD
                    AND TL.TXNUM =TR.TXNUM
                    AND TL.DELTD <>'Y'
                    AND TR.NAMT<>0
                    AND APP.APPTYPE = 'CI'
                    AND APP.TXTYPE IN ('C', 'D')
                    AND TRIM (APP.FIELD) IN ('BAMT')
                    AND  TL.BUSDATE  > TO_DATE (T_DATE ,'DD/MM/YYYY')
               GROUP BY TR.ACCTNO
           UNION ALL
              SELECT   SUM ((CASE WHEN APP.TXTYPE = 'D'THEN -TR.NAMT
                                 WHEN  APP.TXTYPE = 'C'THEN TR.NAMT
                                 ELSE 0 END )) AMT,TR.ACCTNO ACCTNO
              FROM APPTX APP, CITRANA TR,TLLOGALL TL
              WHERE TR.TXCD = APP.TXCD
                    AND TL.TXNUM =TR.TXNUM
                    AND TL.DELTD <>'Y'
                    AND TR.NAMT<>0
                    AND TL.TXDATE =TR.TXDATE
                    AND APP.APPTYPE = 'CI'
                    AND APP.TXTYPE IN ('C', 'D')
                    AND TRIM (APP.FIELD) IN ('BAMT')
                    AND  TL.BUSDATE  > TO_DATE (T_DATE ,'DD/MM/YYYY')
              GROUP BY TR.ACCTNO
                ) A
                  GROUP BY A.ACCTNO)DTL
       ON DTL.ACCTNO = CI.AFACCTNO
       ;

   LOOP
      FETCH    CUR
       INTO  V_NUMKQ  ;
      EXIT WHEN    CUR%NOTFOUND;
   END LOOP;
   CLOSE    CUR;

-- SO TIEN PHONG TOA
OPEN    CUR
    FOR
     SELECT  CI.EMKAMT  - NVL(DTL.B,0)
      FROM (SELECT * FROM  CIMAST WHERE AFACCTNO  LIKE V_STRAFACCTNO)  CI
    LEFT JOIN
      (
         SELECT SUM(A.AMT) B,A.ACCTNO  ACCTNO
         FROM (SELECT   SUM ((CASE WHEN APP.TXTYPE = 'D'THEN -TR.NAMT
                                   WHEN APP.TXTYPE = 'C' THEN TR.NAMT
                                   ELSE 0   END )) AMT,TR.ACCTNO ACCTNO
               FROM APPTX APP, CITRAN TR ,TLLOG TL
               WHERE TR.TXCD = APP.TXCD
                    AND TL.TXNUM =TR.TXNUM
                    AND TL.DELTD <>'Y'
                    AND TR.NAMT<>0
                    AND APP.APPTYPE = 'CI'
                    AND APP.TXTYPE IN ('C', 'D')
                    AND TRIM (APP.FIELD) IN ('EMKAMT')
                    AND  TL.BUSDATE  > TO_DATE (T_DATE ,'DD/MM/YYYY')
               GROUP BY TR.ACCTNO
           UNION ALL
              SELECT   SUM ((CASE WHEN APP.TXTYPE = 'D'THEN -TR.NAMT
                                 WHEN  APP.TXTYPE = 'C'THEN TR.NAMT
                                 ELSE 0 END )) AMT,TR.ACCTNO ACCTNO
              FROM APPTX APP, CITRANA TR,TLLOGALL TL
              WHERE TR.TXCD = APP.TXCD
                    AND TL.TXNUM =TR.TXNUM
                    AND TL.DELTD <>'Y'
                    AND TR.NAMT<>0
                    AND TL.TXDATE =TR.TXDATE
                    AND APP.APPTYPE = 'CI'
                    AND APP.TXTYPE IN ('C', 'D')
                    AND TRIM (APP.FIELD) IN ('EMKAMT')
                    AND  TL.BUSDATE  >  TO_DATE (T_DATE ,'DD/MM/YYYY')
              GROUP BY TR.ACCTNO
                ) A
                  GROUP BY A.ACCTNO)DTL
 ON DTL.ACCTNO = CI.AFACCTNO
;

   LOOP
      FETCH    CUR
       INTO  V_NUMPT  ;
      EXIT WHEN    CUR%NOTFOUND;
   END LOOP;
   CLOSE    CUR;


   ---SO DU DAU KY
   OPEN    CUR
    FOR
     SELECT  CI.BALANCE + CI.BAMT  -  NVL(DTL.B,0)
      FROM (SELECT * FROM  CIMAST WHERE AFACCTNO  LIKE V_STRAFACCTNO)  CI
    LEFT JOIN
      (
         SELECT SUM(A.AMT) B,A.ACCTNO  ACCTNO
         FROM (SELECT   SUM ((CASE WHEN APP.TXTYPE = 'D'THEN -TR.NAMT
                                   WHEN APP.TXTYPE = 'C' THEN TR.NAMT
                                   ELSE 0   END )) AMT,TR.ACCTNO ACCTNO
               FROM APPTX APP, CITRAN TR ,TLLOG TL
               WHERE TR.TXCD = APP.TXCD
                    AND TL.TXNUM =TR.TXNUM
                    AND TL.DELTD <>'Y'
                    AND TR.NAMT<>0
                    AND APP.APPTYPE = 'CI'
                    AND APP.TXTYPE IN ('C', 'D')
                    AND TRIM (APP.FIELD) IN ('BALANCE','BAMT')
                    AND  TL.BUSDATE  >= TO_DATE (F_DATE ,'DD/MM/YYYY')
                    --AND  TL.TLTXCD NOT IN('1145' ,'1144')
               GROUP BY TR.ACCTNO
           UNION ALL
              SELECT   SUM ((CASE WHEN APP.TXTYPE = 'D'THEN -TR.NAMT
                                 WHEN  APP.TXTYPE = 'C'THEN TR.NAMT
                                 ELSE 0 END )) AMT,TR.ACCTNO ACCTNO
              FROM APPTX APP, CITRANA TR,TLLOGALL TL
              WHERE TR.TXCD = APP.TXCD
                    AND TL.TXNUM =TR.TXNUM
                    AND TL.DELTD <>'Y'
                    AND TR.NAMT<>0
                    AND TL.TXDATE =TR.TXDATE
                    AND APP.APPTYPE = 'CI'
                    AND APP.TXTYPE IN ('C', 'D')
                    AND TRIM (APP.FIELD) IN ('BALANCE','BAMT')
                    AND  TL.BUSDATE  >= TO_DATE (F_DATE ,'DD/MM/YYYY')
                    --AND  TL.TLTXCD NOT IN('1145' ,'1144')
              GROUP BY TR.ACCTNO
                ) A
                  GROUP BY A.ACCTNO
                  )DTL
       ON DTL.ACCTNO = CI.AFACCTNO;

   LOOP
      FETCH    CUR
       INTO V_NUMSDDK;
      EXIT WHEN    CUR%NOTFOUND;
   END LOOP;
   CLOSE    CUR;

   END IF;




 OPEN PV_REFCURSOR
       FOR
       SELECT * FROM
   (SELECT ROWNUM ROWN,AFACCTNO  AFACCTNO,NVL(V_NUMSDDK,0) V_NUMSDDK,NVL(V_NUMCTT,0) V_NUMCTT, NVL(V_NUMKQ,0) V_NUMKQ , NVL(V_NUMPT,0) V_NUMPT,V_STRFULLNAME V_STRFULLNAME, V_STRMOBILE V_STRMOBILE,
             V_STRLG LG,V.*
          FROM (
--  GIAO DICH CI KHAC LENH
        SELECT   TL.TXDATE TXDATE,TL.BUSDATE, TL.TXNUM TXNUM, TO_CHAR(TL.TXDESC) DESCRIPTION,
                 (CASE WHEN APP.TXTYPE='C' THEN CITR.NAMT ELSE 0 END)CRAMT_CI,
                 (CASE WHEN APP.TXTYPE='D' THEN CITR.NAMT ELSE 0 END)DRAMT_CI,0 CRAMT_SE, 0 DRAMT_SE,'' SYMBOL
         FROM (SELECT * FROM TLLOG WHERE BUSDATE >= TO_DATE (F_DATE, 'DD/MM/YYYY')  AND BUSDATE <= TO_DATE (T_DATE, 'DD/MM/YYYY')
               AND TLTXCD IN
            ( SELECT  TLTXCD FROM TLTX  WHERE  SUBSTR(TLTXCD,1,2) <> '88' AND TLTXCD <>'1196'  OR TLTXCD  IN('8878' ,'8879')  )
                )  TL,APPTX APP,CITRAN CITR
         WHERE TL.TXNUM = CITR.TXNUM
             AND TL.DELTD <>'Y'
             AND CITR.TXCD = APP.TXCD
             AND APP.APPTYPE = 'CI'
             AND APP.TXTYPE IN ('C', 'D')
             AND TRIM (APP.FIELD) IN ('BALANCE','BAMT')
             AND  CITR.NAMT<>0
             AND TL.TXDATE =CITR.TXDATE
             AND CITR.ACCTNO LIKE V_STRAFACCTNO
        AND    INSTR( (CASE WHEN NVL(ONL,'ALL' )='ALL' THEN TL.TLTXCD  ELSE ONL END )  ,TL.TLTXCD )>0
      UNION ALL
         SELECT  TL.TXDATE TXDATE,TL.BUSDATE, TL.TXNUM TXNUM, TO_CHAR(TL.TXDESC) DESCRIPTION,
             (CASE WHEN APP.TXTYPE='C' THEN CITR.NAMT ELSE 0 END)CRAMT_CI,
             (CASE WHEN APP.TXTYPE='D' THEN CITR.NAMT ELSE 0 END)DRAMT_CI,0 CRAMT_SE, 0 DRAMT_SE,'' SYMBOL
          FROM (SELECT * FROM TLLOGALL WHERE BUSDATE >= TO_DATE (F_DATE, 'DD/MM/YYYY') AND
                                             BUSDATE <= TO_DATE (T_DATE, 'DD/MM/YYYY')
          AND TLTXCD IN ( SELECT  TLTXCD FROM TLTX  WHERE  SUBSTR(TLTXCD,1,2) <> '88' AND TLTXCD <>'1196'  OR TLTXCD  IN('8878' ,'8879')
                    )
                 ) TL,APPTX APP,CITRANA CITR
          WHERE  TL.TXNUM = CITR.TXNUM
             AND TL.DELTD <>'Y'
             AND CITR.TXCD = APP.TXCD
             AND APP.APPTYPE = 'CI'
             AND APP.TXTYPE IN ('C', 'D')
             AND TRIM (APP.FIELD) IN ('BALANCE','BAMT')
             AND  CITR.NAMT<>0
             AND TL.TXDATE =CITR.TXDATE
             AND CITR.ACCTNO LIKE V_STRAFACCTNO
        AND    INSTR( (CASE WHEN NVL(ONL,'ALL' )='ALL' THEN TL.TLTXCD  ELSE ONL END )  ,TL.TLTXCD )>0

   --  GIAO DICH CI LENH
               UNION ALL

           SELECT
             MAX(TL.TXDATE) TXDATE,MAX(TL.BUSDATE) BUSDATE, MAX(TL.TXNUM) TXNUM, MAX(TO_CHAR(TL.TXDESC)) DESCRIPTION,
             SUM(CASE WHEN APP.TXTYPE='C' THEN CITR.NAMT ELSE 0 END)CRAMT_CI,
             SUM(CASE WHEN APP.TXTYPE='D' THEN CITR.NAMT ELSE 0 END)DRAMT_CI,0 CRAMT_SE, 0 DRAMT_SE,'' SYMBOL
            FROM (SELECT * FROM TLLOG WHERE BUSDATE >= TO_DATE (F_DATE, 'DD/MM/YYYY') AND
                                            BUSDATE <= TO_DATE (T_DATE, 'DD/MM/YYYY')
                             AND TLTXCD  IN ( '8821','8865','8866','8822','8861','8855','8856')
                 ) TL,APPTX APP,CITRAN CITR
            WHERE    TL.TXNUM = CITR.TXNUM
                 AND TL.DELTD <>'Y'
                 AND CITR.TXCD = APP.TXCD
                 AND APP.APPTYPE = 'CI'
                 AND APP.TXTYPE IN ('C', 'D')
                 AND TRIM (APP.FIELD) IN  ('BALANCE','BAMT')
                 AND  CITR.NAMT<>0
                 AND TL.TXDATE =CITR.TXDATE
                 AND  CITR.ACCTNO LIKE V_STRAFACCTNO
        AND    INSTR( (CASE WHEN NVL(ONL,'ALL' )='ALL' THEN TL.TLTXCD  ELSE ONL END )  ,TL.TLTXCD )>0
                  GROUP BY CITR.REF  ,APP.TXTYPE,TL.TLTXCD

      UNION ALL
          SELECT
             MAX(TL.TXDATE) TXDATE,MAX(TL.BUSDATE) BUSDATE, MAX(TL.TXNUM) TXNUM, MAX(TO_CHAR(TL.TXDESC)) DESCRIPTION,
             SUM(CASE WHEN APP.TXTYPE='C' THEN CITR.NAMT ELSE 0 END)CRAMT_CI,
             SUM(CASE WHEN APP.TXTYPE='D' THEN CITR.NAMT ELSE 0 END)DRAMT_CI,0 CRAMT_SE, 0 DRAMT_SE,'' SYMBOL
           FROM (SELECT * FROM TLLOGALL WHERE BUSDATE >= TO_DATE (F_DATE, 'DD/MM/YYYY') AND
                                              BUSDATE <= TO_DATE (T_DATE, 'DD/MM/YYYY')
                                       AND TLTXCD  IN ( '8821','8865','8866','8822','8861','8855','8856')
                 ) TL,APPTX APP,CITRANA CITR
           WHERE TL.TXNUM = CITR.TXNUM
                 AND TL.DELTD <>'Y'
                 AND CITR.TXCD = APP.TXCD
                 AND APP.APPTYPE = 'CI'
                 AND APP.TXTYPE IN ('C', 'D')
                 AND TRIM (APP.FIELD) IN  ('BALANCE','BAMT')
                 AND  CITR.NAMT<>0
                 AND TL.TXDATE =CITR.TXDATE
                 AND CITR.ACCTNO LIKE V_STRAFACCTNO
        AND    INSTR( (CASE WHEN NVL(ONL,'ALL' )='ALL' THEN TL.TLTXCD  ELSE ONL END )  ,TL.TLTXCD )>0
                        GROUP BY CITR.REF,APP.TXTYPE,TL.TLTXCD
--GIAO DICH SE KHAC LENH

 UNION ALL


  SELECT    TL.TXDATE TXDATE,TL.BUSDATE BUSDATE, TL.TXNUM TXNUM,TO_CHAR(TL.TXDESC) DESCRIPTION,0 CRAMT_CI,0 DRAMT_CI,
          (CASE WHEN APP.TXTYPE='C' THEN SETR.NAMT ELSE 0 END)CRAMT_SE,
          (CASE WHEN APP.TXTYPE='D' THEN SETR.NAMT ELSE 0 END)DRAMT_SE,
          TO_CHAR(SB.SYMBOL) SYMBOL

     FROM (SELECT * FROM TLLOG WHERE BUSDATE >= TO_DATE (F_DATE, 'DD/MM/YYYY') AND BUSDATE <= TO_DATE (T_DATE, 'DD/MM/YYYY')
                 AND TLTXCD IN ( SELECT  TLTXCD FROM TLTX  WHERE  SUBSTR(TLTXCD,1,2) <> '88' AND TLTXCD NOT IN ('2297','2298') OR TLTXCD  IN('8878' ,'8879')
         ) ) TL, APPTX APP,( SELECT * FROM  SETRAN WHERE SUBSTR(ACCTNO,1,10) LIKE V_STRAFACCTNO  )SETR, SBSECURITIES SB
     WHERE
         TL.TXNUM = SETR.TXNUM
         AND SETR.TXCD = APP.TXCD
         AND SB.CODEID=SUBSTR (SETR.ACCTNO, 11, 6)
         AND APP.APPTYPE = 'SE'
         AND APP.TXTYPE IN ('C', 'D')
         AND TRIM (APP.FIELD) IN('TRADE','SECURED')
         AND  SETR.NAMT<>0
         AND TL.DELTD<>'Y'
         AND TL.TXDATE =SETR.TXDATE
        AND    INSTR( (CASE WHEN NVL(ONL,'ALL' )='ALL' THEN TL.TLTXCD  ELSE ONL END )  ,TL.TLTXCD )>0

  UNION ALL

  SELECT     TL.TXDATE TXDATE,TL.BUSDATE BUSDATE, TL.TXNUM TXNUM,TO_CHAR(TL.TXDESC) DESCRIPTION,0 CRAMT_CI,0 DRAMT_CI,
          (CASE WHEN APP.TXTYPE='C' THEN SETR.NAMT ELSE 0 END)CRAMT_SE,
          (CASE WHEN APP.TXTYPE='D' THEN SETR.NAMT ELSE 0 END)DRAMT_SE,
          TO_CHAR(SB.SYMBOL) SYMBOL
 FROM (SELECT * FROM TLLOGALL WHERE BUSDATE >= TO_DATE (F_DATE, 'DD/MM/YYYY') AND BUSDATE <= TO_DATE (T_DATE, 'DD/MM/YYYY')
                   AND TLTXCD IN ( SELECT  TLTXCD FROM TLTX  WHERE  SUBSTR(TLTXCD,1,2) <> '88' AND TLTXCD NOT IN ('2297','2298') OR TLTXCD  IN('8878' ,'8879')

         )) TL, APPTX APP,( SELECT * FROM  SETRANA WHERE SUBSTR(ACCTNO,1,10) LIKE V_STRAFACCTNO  ) SETR,
              SBSECURITIES SB
 WHERE   TL.TXNUM = SETR.TXNUM
         AND SETR.TXCD = APP.TXCD
         AND SB.CODEID=SUBSTR (SETR.ACCTNO, 11, 6)
         AND APP.APPTYPE = 'SE'
         AND APP.TXTYPE IN ('C', 'D')
         AND TRIM (APP.FIELD) IN('TRADE','SECURED')
         AND  SETR.NAMT<>0
         AND TL.DELTD<>'Y'
          AND TL.TXDATE =SETR.TXDATE
        AND    INSTR( (CASE WHEN NVL(ONL,'ALL' )='ALL' THEN TL.TLTXCD  ELSE ONL END )  ,TL.TLTXCD )>0

 --GIAO DICH SE LENH
 UNION ALL


    SELECT       MAX(TL.TXDATE) TXDATE,MAX(TL.BUSDATE) BUSDATE, MAX(TL.TXNUM) TXNUM,MAX(TO_CHAR(TL.TXDESC)) DESCRIPTION,0 CRAMT_CI,0 DRAMT_CI,
          SUM(CASE WHEN APP.TXTYPE='C' THEN SETR.NAMT ELSE 0 END)CRAMT_SE,
          SUM(CASE WHEN APP.TXTYPE='D' THEN SETR.NAMT ELSE 0 END)DRAMT_SE,
          MAX(TO_CHAR(SB.SYMBOL)) SYMBOL
  FROM (SELECT * FROM TLLOG WHERE BUSDATE >= TO_DATE (F_DATE, 'DD/MM/YYYY') AND BUSDATE <= TO_DATE (T_DATE, 'DD/MM/YYYY')
                    AND TLTXCD  IN( '8824' ,'8823', '8868', '8867')) TL,
     APPTX APP,( SELECT * FROM  SETRAN WHERE SUBSTR(ACCTNO,1,10) LIKE V_STRAFACCTNO  ) SETR,
     SBSECURITIES SB

  WHERE   TL.TXNUM = SETR.TXNUM
     and  SETR.TXCD = APP.TXCD
     AND SB.CODEID=SUBSTR (SETR.ACCTNO, 11, 6)
     AND APP.TXTYPE IN ('C', 'D')
     AND TRIM (APP.FIELD) IN('TRADE','SECURED')
     AND  SETR.NAMT<>0
     AND TL.DELTD<>'Y'
     AND TL.TXDATE =SETR.TXDATE
        AND    INSTR( (CASE WHEN NVL(ONL,'ALL' )='ALL' THEN TL.TLTXCD  ELSE ONL END )  ,TL.TLTXCD )>0
      GROUP BY SETR.REF,APP.TXTYPE,TL.TLTXCD
          UNION ALL

     SELECT  MAX(TL.TXDATE) TXDATE,MAX(TL.BUSDATE) BUSDATE, MAX(TL.TXNUM) TXNUM,MAX(TO_CHAR(TL.TXDESC)) DESCRIPTION,0 CRAMT_CI,0 DRAMT_CI,
          SUM(CASE WHEN APP.TXTYPE='C' THEN SETR.NAMT ELSE 0 END)CRAMT_SE,
          SUM(CASE WHEN APP.TXTYPE='D' THEN SETR.NAMT ELSE 0 END)DRAMT_SE,
          MAX(TO_CHAR(SB.SYMBOL)) SYMBOL
  FROM (SELECT * FROM TLLOGALL WHERE BUSDATE >= TO_DATE (F_DATE, 'DD/MM/YYYY') AND BUSDATE <= TO_DATE (T_DATE, 'DD/MM/YYYY')
                    AND TLTXCD  IN( '8824' ,'8823', '8868', '8867')) TL,
     APPTX APP,( SELECT * FROM  SETRANA WHERE SUBSTR(ACCTNO,1,10) LIKE V_STRAFACCTNO  ) SETR,
     SBSECURITIES SB

  WHERE   TL.TXNUM = SETR.TXNUM
      AND SETR.TXCD = APP.TXCD
     AND SB.CODEID=SUBSTR (SETR.ACCTNO, 11, 6)
     AND APP.APPTYPE = 'SE'
     AND APP.TXTYPE IN ('C', 'D')
     AND TRIM (APP.FIELD) IN('TRADE','SECURED')
     AND  SETR.NAMT<>0
     AND TL.DELTD<>'Y'
     AND TL.TXDATE =SETR.TXDATE
        AND    INSTR( (CASE WHEN NVL(ONL,'ALL' )='ALL' THEN TL.TLTXCD  ELSE ONL END )  ,TL.TLTXCD )>0
      GROUP BY SETR.REF,APP.TXTYPE,TL.TLTXCD
                              ) V
     ORDER BY V.BUSDATE)DT
   WHERE DT.ROWN BETWEEN (NVL(CURRENT_INDEX,1)-1)*NVL(OFFSET_NUMBER,1000000) +1 AND NVL(CURRENT_INDEX,1)*NVL(OFFSET_NUMBER,1000000)

 ;


EXCEPTION
   WHEN OTHERS
   THEN
      RETURN;
END;                                                              -- PROCEDURE
/

