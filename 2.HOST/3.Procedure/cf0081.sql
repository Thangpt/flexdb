CREATE OR REPLACE PROCEDURE cf0081 (
   PV_REFCURSOR     IN OUT   PKG_REPORT.REF_CURSOR,
   OPT              IN       VARCHAR2,
   BRID             IN       VARCHAR2,
   PV_CUSTODYCD     IN       VARCHAR2,
   CI0088KEY        IN       VARCHAR2
       )
IS



    V_STROPTION         VARCHAR2  (5);
    V_STRBRID           VARCHAR2(100);
    V_BRID              VARCHAR2(4);
    V_CUSTODYCD          VARCHAR2(20);

BEGIN
    -- GET REPORT'S PARAMETERS
    V_STROPTION := OPT;
    V_BRID := BRID;

    IF PV_CUSTODYCD = 'ALL' then
        V_CUSTODYCD:= '%%';
    else
        V_CUSTODYCD:= PV_CUSTODYCD;
    end if;



    OPEN PV_REFCURSOR FOR
/*
    SELECT SUM(BALANCE) BALANCE, SUM(PBALANCE) PBALANCE, SUM(RQTTY) RQTTY, SUM(QTTY) QTTY, SUM(AMT) AMT, SUM(TRADE) TRADE,
    CATYPE , REPORTDATE, EXRATE,INTERESTRATE, EXPRICE, RIGHTOFFRATE, DEVIDENTRATE, DEVIDENTSHARES , SYMBOL, TRADEPLACE,
    CATYPENAME, CA_GROUP, CAMASTID FROM
    (
        SELECT CAS.CAMASTID,CAS.BALANCE, CAS.PBALANCE, CAS.RQTTY, CAS.QTTY, CAS.AMT, CAS.TRADE,
            CA.CATYPE , CA.REPORTDATE, CA.EXRATE,CA.INTERESTRATE, CA.EXPRICE, CA.RIGHTOFFRATE, CA.DEVIDENTRATE,
            CA.DEVIDENTSHARES , SB.SYMBOL, A1.CDCONTENT TRADEPLACE,
            CASE WHEN CA.CATYPE = '011' THEN 'A. QUY?N NH?N C? T?C B?NG C? PHI?U'
                 WHEN CA.CATYPE = '010' THEN 'C. QUY?N NH?N C? T?C B?NG TI?N'
                 WHEN CA.CATYPE = '021' THEN 'B. QUY?N C? PHI?U THU?NG'
                 WHEN CA.CATYPE = '014' THEN 'D. QUY?N MUA'
                 WHEN CA.CATYPE = '020' THEN 'E. QUY?N HOÁN Ð?I C? PHI?U'
                 WHEN CA.CATYPE in ('017','023') THEN 'F. QUY?N CHUY?N Ð?I TRÁI PHI?U'
                 WHEN CA.CATYPE IN ('022','005','006') THEN 'G. QUY?N BI?U QUY?T'
                 ELSE 'H. QUY?N KHÁC'
            end CATYPENAME,
            CASE WHEN CA.CATYPE IN ('011','021') THEN 1
                 WHEN CA.CATYPE IN ('010') THEN 2
                 WHEN CA.CATYPE IN ('014') THEN 3
                 WHEN CA.CATYPE IN ('020') THEN 4
                 WHEN CA.CATYPE IN ('017','023') THEN 5
                 WHEN CA.CATYPE IN ('022','005','006')  THEN 6 ELSE 7
            END CA_GROUP
            FROM CASCHD CAS, CAMAST CA, SBSECURITIES SB, ALLCODE A1, ALLCODE A2, AFMAST AF, CFMAST CF
        WHERE CAS.CAMASTID = CA.CAMASTID AND CAS.CODEID=SB.CODEID AND CAS.AFACCTNO = AF.ACCTNO
        AND AF.CUSTID= CF.CUSTID
        AND A1.CDNAME='TRADEPLACE' AND A1.CDTYPE='SE' AND A1.CDVAL=SB.TRADEPLACE
        AND A2.CDNAME='CATYPE' AND A2.CDTYPE='CA' AND CA.CATYPE = A2.CDVAL
        AND CF.CUSTODYCD like  V_CUSTODYCD
        AND AF.STATUS='N'
        AND CAS.DELTD <> 'Y'
        AND (CASE WHEN CA.CATYPE = '010' AND CAS.STATUS IN ('C','J') THEN 0 ELSE 1 END) > 0
   ) A
GROUP BY
    CATYPE , REPORTDATE, EXRATE,INTERESTRATE, EXPRICE, RIGHTOFFRATE, DEVIDENTRATE, DEVIDENTSHARES , SYMBOL, TRADEPLACE,
    CATYPENAME, CA_GROUP,CAMASTID
ORDER BY A.CATYPENAME;
*/

SELECT * FROM CF0081_LOG WHERE CUSTODYCD like  V_CUSTODYCD AND TO_CHAR(TXDATE,'DD/MM/RRRR')||TXNUM = CI0088KEY
       ORDER BY CATYPENAME;

EXCEPTION
   WHEN OTHERS
   THEN
      RETURN;
END;
/

