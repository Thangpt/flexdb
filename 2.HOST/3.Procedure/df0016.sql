CREATE OR REPLACE PROCEDURE df0016 (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   F_DATE         IN       VARCHAR2,
   T_DATE         IN       VARCHAR2,
   CUSTODYCD      IN       VARCHAR2,
   I_RRTYPE       IN       VARCHAR2,
   N_DATE         IN       VARCHAR2,
   BRGID          IN       VARCHAR2
   )
IS
--
-- PURPOSE: BRIEFLY EXPLAIN THE FUNCTIONALITY OF THE PROCEDURE
-- BAO CAO SU DU TK VAY BAO LANH TINH THEO KHACH HANG
-- MODIFICATION HISTORY
-- PERSON      DATE    COMMENTS
-- DUNGNH   17-MAY-10  CREATED
-- ---------   ------  -------------------------------------------

   V_STROPTION    VARCHAR2 (5);            -- A: ALL; B: BRANCH; S: SUB-BRANCH
   V_STRBRID      VARCHAR2 (4);            -- USED WHEN V_NUMOPTION > 0
   V_STRCIACCTNO  VARCHAR2 (20);

   V_FROMDATE     DATE;
   V_TODATE       DATE;
   V_INDATE       DATE;

   V_STRCUSTODYCD VARCHAR2 (20);
   V_STRBRGID     VARCHAR2 (20);

BEGIN
   V_STROPTION := OPT;

   IF V_STROPTION = 'A' THEN     -- TOAN HE THONG
      V_STRBRID := '%';
   ELSIF V_STROPTION = 'B' THEN
      V_STRBRID := SUBSTR(BRID,1,2) || '__' ;
   ELSE
      V_STRBRID := BRID;
   END IF;

   IF(CUSTODYCD <> 'ALL') THEN
     V_STRCUSTODYCD := CUSTODYCD;
   ELSE
     V_STRCUSTODYCD := '%';
   END IF;

   IF(BRGID <> 'ALL') THEN
     V_STRBRGID := BRGID ;
   ELSE
     V_STRBRGID := '%';
   END IF;


   V_FROMDATE  :=    TO_DATE(F_DATE,'DD/MM/YYYY');
   V_TODATE    :=    TO_DATE(T_DATE,'DD/MM/YYYY');
   V_INDATE    :=    TO_DATE(T_DATE,'DD/MM/YYYY');

OPEN PV_REFCURSOR
FOR

SELECT  (V_TODATE-1) T_DATE, '001' GRTYPE, CF.CUSTODYCD || '001' MGRTYPE, DF.ACCTNO, DF.TXDATE, LN.OVERDUEDATE, CF.CUSTODYCD, CF.FULLNAME, CF.IDCODE, CF.IDDATE,
    CF.IDPLACE, CF.ADDRESS, CF.MOBILE, SB.SYMBOL,
    (DF.DFQTTY + DF.RCVQTTY + DF.BLOCKQTTY + DF.CARCVQTTY + NVL(RLSQTTY.QTTY,0)) QTTY,
    (DF.AMT - DF.RLSAMT + NVL(TN2.AMT,0)) LENDED_BY_SBS, ROUND((MST.RATE3/12),2) RATE,
    I_RRTYPE TLGOPVON,
    NULL FEEOVD, NULL INTAMT,
    N_DATE DESCRIPTION

FROM VW_DFMAST_ALL DF, AFMAST AF, CFMAST CF, SBSECURITIES SB, VW_LNMAST_ALL MST,
    TLPROFILES TLPR,
    (
        SELECT ACCTNO LNACCTNO, OVERDUEDATE FROM LNSCHD
            WHERE REFTYPE IN ('P','GP')
        UNION ALL
        SELECT ACCTNO LNACCTNO, OVERDUEDATE FROM LNSCHDHIST
            WHERE REFTYPE IN ('P','GP')
    )LN,
--THU NO
    (
        SELECT TR.ACCTNO LNACCTNO,
            SUM(CASE WHEN TX.TXTYPE = 'D'  THEN -TR.NAMT ELSE TR.NAMT END ) AMT
        FROM VW_LNTRAN_ALL TR, APPTX TX
        WHERE TR.TXCD = TX.TXCD
            AND TX.APPTYPE = 'LN'
            AND TX.FIELD IN ('PRINPAID')
            AND TX.TXTYPE IN ('C','D')
            AND TR.DELTD <> 'Y'
            AND TR.TXDATE >= V_INDATE
            AND TR.NAMT <> 0
        GROUP BY TR.ACCTNO
    )TN2,
--SO LUONG THANH LY
    (
        SELECT ACCTNO DFACCTNO, SUM(NAMT) QTTY
        FROM(
                SELECT DFA.ACCTNO, DFA.NAMT
                FROM VW_DFTRAN_ALL DFA, APPTX
                WHERE APPTX.FIELD = 'RLSQTTY'
                    AND DFA.TXCD = APPTX.TXCD
                    AND APPTX.APPTYPE = 'DF'
                    AND DFA.DELTD <> 'Y'
                    AND DFA.TXDATE >= V_INDATE
                    AND DFA.NAMT <> 0
                    AND APPTX.TXTYPE = 'C'
            )
        GROUP BY ACCTNO
    )RLSQTTY
    WHERE DF.LNACCTNO = TN2.LNACCTNO(+)
        AND (
                (DF.DFQTTY + DF.RCVQTTY + DF.BLOCKQTTY + DF.CARCVQTTY + NVL(RLSQTTY.QTTY,0)) > 0
                OR
                (DF.AMT - DF.RLSAMT + NVL(TN2.AMT,0)) > 2
             )
        AND DF.ACCTNO = RLSQTTY.DFACCTNO(+)
        AND DF.LNACCTNO = LN.LNACCTNO
        AND DF.AFACCTNO = AF.ACCTNO
        AND AF.CUSTID = CF.CUSTID
        AND DF.CODEID = SB.CODEID
        AND DF.LNACCTNO = MST.ACCTNO
        AND MST.FTYPE = 'DF'
        AND CF.TLID = TLPR.TLID
        AND TLPR.BRID LIKE V_STRBRGID
        AND (CASE WHEN NVL(DF.CIACCTNO,'') LIKE  '0011026699'  THEN '11' ELSE '10' END) LIKE I_RRTYPE
        AND DF.TXDATE < V_TODATE
        AND CF.CUSTODYCD LIKE fn_get_companycd||'%'
        AND CF.CUSTODYCD LIKE V_STRCUSTODYCD

UNION ALL

SELECT (V_TODATE-1) T_DATE, '001' GRTYPE, CF.CUSTODYCD || '001' MGRTYPE,  A.ACCTNO, A.RLSDATE TXDATE, A.OVERDUEDATE, CF.CUSTODYCD, CF.FULLNAME, CF.IDCODE, CF.IDDATE,
    CF.IDPLACE, CF.ADDRESS, CF.MOBILE, NULL SYMBOL, NULL QTTY, (A.PRINPAID + NVL(B.PAID,0)) LENDED_BY_SBS,
    ROUND((MST.RATE3/12),2) RATE, I_RRTYPE TLGOPVON,
    NULL FEEOVD, NULL INTAMT, N_DATE DESCRIPTION

FROM AFMAST AF, CFMAST CF, VW_LNMAST_ALL MST, TLPROFILES TLPR,
    (--THONG TIN KHACH HANG VAY BAO LANH.
        SELECT SCHD.AUTOID, SCHD.RLSDATE, SCHD.ACCTNO, MST.TRFACCTNO, SCHD.OVERDUEDATE,
            (SCHD.NML+SCHD.OVD)  PRINPAID
        FROM (SELECT * FROM LNSCHD UNION ALL SELECT * FROM LNSCHDHIST) SCHD, VW_LNMAST_ALL MST
        WHERE MST.ACCTNO = SCHD.ACCTNO
            AND SCHD.REFTYPE IN ('P','GP')
            AND MST.FTYPE = 'AF'
    ) A,
    (
        SELECT TR.AUTOID, TR.TXNUM, TR.TXDATE, SUM(TR.PAID) PAID
        FROM LNSCHDLOGHIST TR
        WHERE TXNUM IS NOT NULL
            AND PAID > 1
            AND TR.TXDATE >= V_INDATE
        GROUP BY TR.AUTOID, TR.TXNUM, TR.TXDATE
        ORDER BY TXDATE
    ) B
WHERE A.AUTOID = B.AUTOID(+)
    AND A.ACCTNO = MST.ACCTNO
    AND A.TRFACCTNO = AF.ACCTNO
    AND AF.CUSTID = CF.CUSTID
    AND I_RRTYPE LIKE '10'
    AND CF.TLID = TLPR.TLID
    AND TLPR.BRID LIKE V_STRBRGID
    AND A.RLSDATE < V_TODATE
    AND CF.CUSTODYCD LIKE fn_get_companycd||'%'
    AND (A.PRINPAID + NVL(B.PAID,0)) > 1
    AND CF.CUSTODYCD LIKE V_STRCUSTODYCD

UNION ALL

SELECT (V_TODATE-1) T_DATE, '002' GRTYPE, CF.CUSTODYCD || '002' MGRTYPE,  DF.ACCTNO , DF.TXDATE TXDATE, TN.TXDATE OVERDUEDATE,
    CF.CUSTODYCD, CF.FULLNAME, CF.IDCODE, CF.IDDATE, CF.IDPLACE, CF.ADDRESS, CF.MOBILE,
    SB.SYMBOL SYMBOL, TN.RLSQTTY QTTY,
    TN.RLSAMT LENDED_BY_SBS,
    --(((TN.INTPAID-TN.INTOVDACR)/(TN.RLSAMT*(TO_NUMBER(TN.TXDATE-DF.TXDATE))))*30*100) RATE,
    NULL RATE,
    I_RRTYPE TLGOPVON,
    TN.INTOVDACR FEEOVD, (TN.INTPAID-TN.INTOVDACR) INTAMT,
    N_DATE DESCRIPTION
FROM VW_DFMAST_ALL DF, AFMAST AF, CFMAST CF, SBSECURITIES SB, TLPROFILES TLPR,
    (
        SELECT TXNUM, TXDATE, DFACCTNO,
            SUM(RLSAMT) RLSAMT,
            SUM(RLSQTTY) RLSQTTY,
            SUM(INTPAID) INTPAID,
            SUM(INTOVDACR) INTOVDACR
        FROM
            (
                --- TRA NO GOC
                SELECT TO_CHAR(TR.TXNUM) TXNUM, TR.TXDATE, TR.ACCTNO DFACCTNO,
                    TR.NAMT RLSAMT,
                    0 RLSQTTY,
                    0 INTPAID,
                    0 INTOVDACR
                FROM VW_DFTRAN_ALL TR, APPTX TX, VW_DFMAST_ALL DF
                WHERE TR.TXCD = TX.TXCD AND TR.ACCTNO = DF.ACCTNO
                    AND TX.FIELD = 'RLSAMT' AND TX.APPTYPE = 'DF' AND TX.TXTYPE = 'C'
                    AND TR.NAMT <> 0
                    AND TR.TXDATE >= V_FROMDATE
                    AND TR.TXDATE < V_TODATE
                --- SO LUONG CK HOAN TRA
                UNION ALL
                SELECT TO_CHAR(TR.TXNUM) TXNUM, TR.TXDATE, TR.ACCTNO DFACCTNO,
                    0 RLSAMT,
                    TR.NAMT RLSQTTY,
                    0 INTPAID,
                    0 INTOVDACR
                FROM VW_DFTRAN_ALL TR, APPTX TX, VW_DFMAST_ALL DF
                WHERE TR.TXCD = TX.TXCD AND TR.ACCTNO = DF.ACCTNO
                    AND TX.FIELD = 'RLSQTTY' AND TX.APPTYPE = 'DF' AND TX.TXTYPE = 'C'
                    AND TR.NAMT <> 0
                    AND TR.TXDATE >= V_FROMDATE
                    AND TR.TXDATE < V_TODATE
                UNION ALL
                --TRA LAI
               SELECT TO_CHAR(TR.TXNUM) TXNUM, TR.TXDATE, DF.ACCTNO DFACCTNO,
                    0 RLSAMT,
                    0 RLSQTTY,
                    SUM(CASE WHEN TX.FIELD = 'INTPAID' AND TX.TXTYPE = 'C' THEN TR.NAMT ELSE 0 END) INTPAID,
                    SUM(CASE WHEN TX.FIELD IN ('INTOVDACR','INTNMLOVD') AND TX.TXTYPE = 'D' THEN TR.NAMT ELSE 0 END)INTOVDACR
                FROM VW_LNTRAN_ALL TR, APPTX TX, VW_DFMAST_ALL DF, VW_LNMAST_ALL LN
                WHERE TR.TXCD = TX.TXCD AND DF.LNACCTNO = LN.ACCTNO
                    AND TR.ACCTNO = LN.ACCTNO AND DF.LNACCTNO = LN.ACCTNO
                    AND TX.FIELD IN ('INTPAID','INTOVDACR','INTNMLOVD')
                    AND TX.APPTYPE = 'LN'
                    AND TX.TXTYPE IN ('C','D')
                    AND TR.NAMT <> 0
                    AND TR.TXDATE >= V_FROMDATE
                    AND TR.TXDATE < V_TODATE
                GROUP BY TO_CHAR(TR.TXNUM), TR.TXDATE, DF.ACCTNO
            ) TR
        WHERE ( RLSAMT > 10 OR
                RLSQTTY > 1 OR
                INTPAID > 1 OR
                INTOVDACR > 1 )
        GROUP BY TXNUM, TXDATE, DFACCTNO
    )TN
WHERE DF.ACCTNO = TN.DFACCTNO
    AND DF.AFACCTNO = AF.ACCTNO
    AND AF.CUSTID = CF.CUSTID
    AND DF.CODEID = SB.CODEID
    AND CF.TLID = TLPR.TLID
    AND TLPR.BRID LIKE V_STRBRGID
--    AND (CASE WHEN I_RRTYPE LIKE '10' THEN '' ELSE DF.CIACCTNO END) LIKE '0011026699'
    AND (CASE WHEN NVL(DF.CIACCTNO,'') LIKE  '0011026699'  THEN '11' ELSE '10' END) LIKE I_RRTYPE
    AND CF.CUSTODYCD LIKE fn_get_companycd||'%'
    AND CF.CUSTODYCD LIKE V_STRCUSTODYCD

UNION ALL

SELECT (V_TODATE-1) T_DATE, '002' GRTYPE, CF.CUSTODYCD || '002' MGRTYPE, MST.ACCTNO, SCHD.RLSDATE TXDATE, B.TXDATE OVERDUEDATE,
    CF.CUSTODYCD, CF.FULLNAME, CF.IDCODE, CF.IDDATE, CF.IDPLACE, CF.ADDRESS, CF.MOBILE,
    NULL SYMBOL, NULL QTTY,
    B.PAID LENDED_BY_SBS,
--        ((B.INTOVDPRIN + B.INTPAID)/(B.PAID*(TO_NUMBER(B.TXDATE-SCHD.RLSDATE)))*30*100) RATE,
    NULL RATE,
    I_RRTYPE TLGOPVON, ABS(B.INTOVDPRIN)  FEEOVD, (B.INTOVDPRIN + B.INTPAID) INTAMT,
    N_DATE DESCRIPTION

FROM (SELECT * FROM LNSCHD UNION ALL SELECT * FROM LNSCHDHIST) SCHD, VW_LNMAST_ALL MST, AFMAST AF, CFMAST CF,
    TLPROFILES TLPR,
    (
        SELECT TR.AUTOID, TR.TXNUM, TR.TXDATE,
            SUM(TR.PAID) PAID,
            SUM(TR.INTOVDPRIN) INTOVDPRIN,
            SUM(TR.INTPAID) INTPAID
        FROM LNSCHDLOGHIST TR
        WHERE TXNUM IS NOT NULL
            AND (PAID > 1  OR INTOVDPRIN > 1 OR INTPAID > 1)
            AND TR.TXDATE >= V_FROMDATE
            AND TR.TXDATE < V_TODATE
        GROUP BY TR.AUTOID, TR.TXNUM, TR.TXDATE
        ORDER BY TXDATE
    ) B
WHERE SCHD.AUTOID = B.AUTOID
    AND SCHD.ACCTNO = MST.ACCTNO
    AND MST.TRFACCTNO = AF.ACCTNO
    AND AF.CUSTID = CF.CUSTID
    AND SCHD.REFTYPE IN ('P','GP')
    AND MST.FTYPE = 'AF'
    AND CF.TLID = TLPR.TLID
    AND TLPR.BRID LIKE V_STRBRGID
    AND I_RRTYPE LIKE '10'
    AND CF.CUSTODYCD LIKE fn_get_companycd||'%'
    AND CF.CUSTODYCD LIKE V_STRCUSTODYCD
;

EXCEPTION
   WHEN OTHERS
   THEN
      RETURN;
END;                                                              -- PROCEDURE
/

