CREATE OR REPLACE PROCEDURE cf0096 (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   F_DATE         IN       VARCHAR2,
   T_DATE         IN       VARCHAR2,
   CUSTODYCD      IN       VARCHAR2,
   CIACCTNO       IN       VARCHAR2,
   SYMBOL         IN       VARCHAR2
   )
IS
--
-- PURPOSE: TONG HOP LAI LO CHUNG KHOAN NIEM YET
-- MODIFICATION HISTORY
-- PERSON      DATE    COMMENTS
-- DUNGNH   28-07-2010  CREATED
-- ---------   ------  -------------------------------------------
   V_STROPTION          VARCHAR2 (5);
   V_STRBRID            VARCHAR2 (4);

   V_STRSYMBOL          VARCHAR2 (10);
   V_STRCIACCTNO        VARCHAR2 (20);
   V_STRCUSTODYCD       VARCHAR2 (20);
   V_FROM_DATE          DATE;
   V_TO_DATE            DATE;
   V_CUR_DATE           DATE;


BEGIN
   V_STROPTION := OPT;

   IF V_STROPTION = 'A' THEN     -- TOAN HE THONG
      V_STRBRID := '%';
   ELSIF V_STROPTION = 'B' THEN
      V_STRBRID := SUBSTR(BRID,1,2) || '__' ;
   ELSE
      V_STRBRID := BRID;
   END IF;

    -- GET REPORT'S PARAMETERS
   --
   IF (SYMBOL = 'ALL' OR SYMBOL IS NULL)
   THEN
      V_STRSYMBOL := '%';
   ELSE
      V_STRSYMBOL := SYMBOL;
   END IF;
   --
   V_STRCUSTODYCD := CUSTODYCD;
   --
   IF (CIACCTNO <> 'ALL')
   THEN
      V_STRCIACCTNO := CIACCTNO;
   ELSE
      V_STRCIACCTNO := '%';
   END IF;
   --
   V_FROM_DATE  := TO_DATE(F_DATE,'DD/MM/YYYY');
   V_TO_DATE    := TO_DATE(T_DATE,'DD/MM/YYYY');
   SELECT TO_DATE(VARVALUE,'dd/mm/yyyy') INTO V_CUR_DATE FROM sysvar WHERE GRNAME = 'SYSTEM' AND VARNAME = 'CURRDATE';

OPEN PV_REFCURSOR
FOR
SELECT SB.CODEID, STS.AFACCTNO, SB.SYMBOL, STS.QTTY SELLQUANTITY,
    STS.QTTY*STS.COSTPRICE COSTAMT, STS.AMT SELLAMT, OD.FEEACR FEEAMT,
    TO_CHAR(OD.TXNUM) TXNUM, OD.TXDATE,
    GETDUEDATE(OD.TXDATE, OD.CLEARCD, SB.TRADEPLACE, OD.CLEARDAY) CLEARDAY,
    STS.ORGORDERID ORGORDERID
FROM SBSECURITIES SB, AFMAST AF, CFMAST CF,
    (
        SELECT MAX(st.AFACCTNO) AFACCTNO, ORGORDERID, SUM(QTTY) QTTY,
            NVL(MAX(CASE WHEN ST.TXDATE = V_CUR_DATE
                THEN (case when mst.TOTALSELLQTTY > 0 then round(mst.totalbuyamt/mst.totalsellqtty, 4)
                    else 0 end )
                ELSE SE.costprice END),0) COSTPRICE,
            SUM(AMT) AMT
        FROM  VW_STSCHD_ALL ST, SECOSTPRICE SE, SEMAST MST
        WHERE DUETYPE ='SS'
            AND ST.TXDATE BETWEEN V_FROM_DATE AND V_TO_DATE
            AND ST.ACCTNO = SE.ACCTNO
            AND ST.TXDATE = SE.TXDATE
            AND ST.ACCTNO = MST.ACCTNO
            AND MST.AFACCTNO LIKE  V_STRCIACCTNO
        GROUP BY ORGORDERID
    ) STS,
     VW_ODMAST_ALL  OD
WHERE OD.CODEID = SB.CODEID
    AND STS.ORGORDERID = OD.ORDERID
    AND STS.AFACCTNO = AF.ACCTNO
    AND AF.CUSTID = CF.CUSTID
    AND SB.TRADEPLACE IN ('001','002')
    AND CF.CUSTODYCD = V_STRCUSTODYCD
    AND AF.ACCTNO LIKE  V_STRCIACCTNO
    AND SB.SYMBOL LIKE V_STRSYMBOL

UNION ALL

SELECT SB.CODEID, SE.AFACCTNO ,SB.SYMBOL,
    TRA.NAMT SELLQUANTITY,
    (TRA.NAMT*NVL(GETCOSTPRICE(TRA.ACCTNO, TO_CHAR(TL.TXDATE,'DD/MM/YYYY')),0)) COSTAMT,
    TL.MSGAMT*TRA.NAMT SELLAMT, 0 FEEAMT,
    TL.TXNUM, TL.TXDATE, NULL CLEARDAY,
    NULL ORGORDERID
FROM SEMAST SE, SBSECURITIES SB, AFMAST AF, CFMAST CF,
    (SELECT * FROM VW_TLLOG_ALL WHERE TXDATE BETWEEN V_FROM_DATE AND V_TO_DATE) TL,
    (SELECT * FROM VW_SETRAN_ALL WHERE TXDATE BETWEEN V_FROM_DATE AND V_TO_DATE) TRA
WHERE TL.TLTXCD = '8878'
    AND TL.TXNUM = TRA.TXNUM
    AND TL.TXDATE = TRA.TXDATE
    AND TRA.TXCD = '0011'
    AND TRA.ACCTNO = SE.ACCTNO
    AND SB.TRADEPLACE IN ('001','002')
    AND SE.CODEID = SB.CODEID
    AND SE.AFACCTNO = AF.ACCTNO
    AND AF.CUSTID = CF.CUSTID
    AND CF.CUSTODYCD = V_STRCUSTODYCD
    AND AF.ACCTNO LIKE  V_STRCIACCTNO
    AND SB.SYMBOL LIKE V_STRSYMBOL
ORDER BY TXNUM
;
EXCEPTION
   WHEN OTHERS
   THEN
      RETURN;
END;
/

