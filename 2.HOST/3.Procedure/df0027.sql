CREATE OR REPLACE PROCEDURE df0027 (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   I_DATE         IN       VARCHAR2,
   BRGID          IN       VARCHAR2
   )
IS
--
-- PURPOSE: BRIEFLY EXPLAIN THE FUNCTIONALITY OF THE PROCEDURE
-- BANG KE HOP DONG GIAI NGAN
-- MODIFICATION HISTORY
-- PERSON      DATE    COMMENTS
-- DUNGNH    16/07/10
-- ---------   ------  -------------------------------------------

   V_STROPTION      VARCHAR2 (5);            -- A: ALL; B: BRANCH; S: SUB-BRANCH
   V_STRBRID        VARCHAR2 (4);            -- USED WHEN V_NUMOPTION > 0


   V_STRBRGID  VARCHAR2 (10);


   V_INDATE     DATE;

BEGIN
   V_STROPTION := OPT;

   IF V_STROPTION = 'A' THEN     -- TOAN HE THONG
      V_STRBRID := '%';
   ELSIF V_STROPTION = 'B' THEN
      V_STRBRID := SUBSTR(BRID,1,2) || '__' ;
   ELSE
      V_STRBRID := BRID;
   END IF;

   IF(BRGID <> 'ALL') THEN
     V_STRBRGID := BRGID;
   ELSE
     V_STRBRGID := '%';
   END IF;


   V_INDATE  :=  TO_DATE(I_DATE,'DD/MM/YYYY');

OPEN PV_REFCURSOR
FOR
SELECT DF.ACCTNO , DF.TXNUM, DF.TXDATE, TO_NUMBER(LN.OVERDUEDATE-DF.TXDATE) SONGAY,
    LN.OVERDUEDATE, DF.AMT, BR.BRNAME, DF.ACTYPE
FROM VW_DFMAST_ALL DF, BRGRP BR,
    (
        SELECT ACCTNO, RLSDATE, OVERDUEDATE
        FROM LNSCHD
        WHERE REFTYPE IN ('GP','P')
        UNION ALL
        SELECT ACCTNO, RLSDATE, OVERDUEDATE
        FROM LNSCHDHIST
        WHERE REFTYPE IN ('GP','P')
    )LN
WHERE DF.LNACCTNO = LN.ACCTNO
    AND SUBSTR(DF.TXNUM,1,4) = BR.BRID
    AND DF.CIACCTNO LIKE '0011026699'
    AND DF.TXDATE = V_INDATE
    AND BR.BRID LIKE V_STRBRGID
;
EXCEPTION
   WHEN OTHERS
   THEN
      RETURN;
END;                                                              -- PROCEDURE
/

