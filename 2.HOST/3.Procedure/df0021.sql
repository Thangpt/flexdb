CREATE OR REPLACE PROCEDURE df0021 (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   CUSTODYCD      IN       VARCHAR2,
   SYMBOL         IN      VARCHAR2
   )
IS
--
-- PURPOSE: BRIEFLY EXPLAIN THE FUNCTIONALITY OF THE PROCEDURE
-- BAO CAO TAI KHOAN TIEN TONG HOP CUA NGUOI DAU TU
-- MODIFICATION HISTORY
-- PERSON      DATE    COMMENTS
-- HUYNQ
-- ---------   ------  -------------------------------------------

   V_STROPTION      VARCHAR2 (5);            -- A: ALL; B: BRANCH; S: SUB-BRANCH
   V_STRBRID          VARCHAR2 (4);            -- USED WHEN V_NUMOPTION > 0

   V_STRI_BRID       VARCHAR2 (5);
   V_STRI_TYPE       VARCHAR2 (5);
   V_STRCUSTODYCD    VARCHAR2 (20);
   V_STRSYMBOL       VARCHAR2 (5);

BEGIN
   V_STROPTION := OPT;

   IF V_STROPTION = 'A' then
    V_STRBRID := '%';
ELSIF V_STROPTION = 'B' then
    V_STRBRID := substr(BRID,1,2) || '__' ;
else
    V_STRBRID:=BRID;
END IF;

  IF (CUSTODYCD = 'ALL' or CUSTODYCD is null)
   THEN
       V_STRSYMBOL  := '%';
   ELSE
       V_STRSYMBOL  := SYMBOL;
   END IF;




   IF (CUSTODYCD = 'ALL' or CUSTODYCD is null)
   THEN
      V_STRCUSTODYCD := '%';
   ELSE
      V_STRCUSTODYCD := CUSTODYCD;
   END IF;


OPEN PV_REFCURSOR
FOR
   SELECT SUBSTR(M.TRFACCTNO,1,4) BRID, DF.ACTYPE, (CASE WHEN DF.CIACCTNO IS NOT NULL THEN 'TL' ELSE 'SBS' END) NGUON,DF.DESCRIPTION,CF.CUSTODYCD , CF.FULLNAME , S.RLSDATE,
       S.OVERDUEDATE,SB.SYMBOL, ROUND( DF.DFQTTY+ DF.RCVQTTY+ DF.BQTTY +DF.RLSQTTY) QTTY , DF.REFPRICE, DF.TRIGGERPRICE ,
       DF.DFPRICE ,  DF.AMT,ROUND (M.RATE1/360,4) rate1, M.INTNMLACR
FROM (SELECT * FROM LNSCHD UNION ALL SELECT * FROM LNSCHDHIST) S,
(SELECT * FROM LNMAST UNION SELECT * FROM LNMASTHIST) M, (
 SELECT * FROM DFMAST UNION ALL SELECT * FROM DFMASTHIST) DF , CFMAST CF , SBSECURITIES SB, DFTYPE
WHERE S.ACCTNO = M.ACCTNO AND DF.ACTYPE = DFTYPE.ACTYPE
  AND M.TRFACCTNO = CF.CUSTID AND S.ACCTNO = DF.LNACCTNO
  AND SB.CODEID = DF.CODEID
  AND S.REFTYPE ='P'
  AND SUBSTR(M.TRFACCTNO,1,4) like V_STRBRID
  and CF.CUSTODYCD  like V_STRCUSTODYCD
  AND SB.SYMBOL LIKE V_STRSYMBOL

;
EXCEPTION
   WHEN OTHERS
   THEN
      RETURN;
END;                                                              -- PROCEDURE
/

