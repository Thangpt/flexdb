CREATE OR REPLACE PROCEDURE CI0063
   (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   PV_BANKCODE    IN       VARCHAR2,
   PV_REF         IN       VARCHAR2
   )
   IS
   v_BANKCODE VARCHAR2(500);
   v_REF VARCHAR2(500);
   v_CUSTODYCD VARCHAR2(20);
   v_CUSTBANK VARCHAR2(20);

BEGIN

    IF PV_BANKCODE='ALL' THEN
        v_BANKCODE:='%%';
     ELSE
        SELECT DECODE(RRTYPE,'B', CUSTBANK, NULL) INTO v_CUSTBANK FROM ADTYPE WHERE ACTYPE= PV_BANKCODE  ;
        SELECT SHORTNAME INTO v_BANKCODE FROM CFMAST WHERE CUSTID=v_CUSTBANK;
    END IF;


    OPEN PV_REFCURSOR
    FOR
    SELECT PV_BANKCODE BCODE_IN, SCHD.CLEARDT DUEDATE,  LG.TXDATE, MST.OBJKEY, LG.AUTOID, A0.CDCONTENT DESC_STATUS, TLP.TLNAME TLID,  FN_CRB_GETVOUCHERNO(LG.TRFCODE, LG.TXDATE, LG.VERSION) VOUCHERNO,
    MST.AFACCTNO, MST.BANKCODE, MST.BANKACCT, MST.TXAMT, CF.CUSTODYCD, CF.FULLNAME, CF.ADDRESS, CF.IDCODE LICENSE, CF.IDDATE, CF.IDPLACE, RF.*
    FROM CFMAST CF, AFMAST AF, CRBTXREQ MST, CRBTRFLOG LG, CRBTRFLOGDTL LGDTL, ALLCODE A0, TLPROFILES TLP,
     (
                   select * from adschd
                   union all
                   select * from adschdhist
     ) SCHD,  vw_tllogfld_all LOG,
      (SELECT *
      FROM   (SELECT DTL.REQID, DTL.FLDNAME, NVL(DTL.CVAL,DTL.NVAL) REFVAL
              FROM   CRBTXREQ MST, CRBTXREQDTL DTL WHERE  MST.REQID=DTL.REQID AND MST.TRFCODE='TRFADV2BANK')
              PIVOT  (MAX(REFVAL) AS R FOR (FLDNAME) IN  ('ORDATE' as ORDATE, 'DAYS' as DAYS))
              ORDER BY REQID) RF
    WHERE CF.CUSTID=AF.CUSTID AND AF.ACCTNO=MST.AFACCTNO AND MST.REQID=RF.REQID
    AND LG.VERSION = LGDTL.VERSION
    AND LG.TXDATE = LGDTL.TXDATE
    AND LG.TRFCODE = LGDTL.TRFCODE
    AND LGDTL.REFREQID = MST.REQID
    AND LG.TRFCODE = 'TRFADV2BANK'
    AND A0.CDTYPE='RM' AND A0.CDNAME='TRFLOGSTS' AND A0.CDVAL=LG.STATUS
    AND LG.TLID = TLP.TLID
    AND LOG.TXNUM = MST.OBJKEY
    AND LOG.TXDATE = MST.TXDATE
    AND LOG.FLDCD = '09'
    AND LOG.NVALUE = SCHD.AUTOID
    AND lpad(LGDTL.VERSION, 3,'0') = SUBSTR(PV_REF,15,3)
    AND LGDTL.TXDATE = TO_DATE((SUBSTR(PV_REF,9,2) || '/' || SUBSTR(PV_REF,11,2)  || '/' || '20' || SUBSTR(PV_REF,13,2)),'DD/MM/YYYY')
    AND MST.BANKCODE LIKE v_BANKCODE;



EXCEPTION
    WHEN OTHERS THEN
        RETURN ;
END; -- Procedure
/

