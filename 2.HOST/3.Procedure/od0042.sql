CREATE OR REPLACE PROCEDURE od0042(
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   F_DATE         IN       VARCHAR2,
   T_DATE         IN       VARCHAR2,
   CUSTODYCD      IN       VARCHAR2,
   PV_AFACCTNO    IN       VARCHAR2,
   PV_TLID          IN      VARCHAR2

   )
IS
-- MODIFICATION HISTORY
-- BAO CAO PHI GIAO DICH CHO NHA DAU TU
-- PERSON   DATE  COMMENTS
-- THANHNNM 11-MAY-12  CREATED
-- ---------   ------  -------------------------------------------
   V_CUSTODYCD      VARCHAR2 (20);
   V_AFACCTNO       VARCHAR2(20);
   V_STROPTION        VARCHAR2 (5);       -- A: ALL; B: BRANCH; S: SUB-BRANCH
    V_STRBRID          VARCHAR2 (40);    -- USED WHEN V_NUMOPTION > 0
    V_INBRID     VARCHAR2 (5);
   V_TLID           VARCHAR2(4);

BEGIN

    V_STROPTION := upper(OPT);
    V_INBRID := BRID;
    V_TLID:= PV_TLID;

   if(V_STROPTION = 'A') then
        V_STRBRID := '%';
    else
        if(V_STROPTION = 'B') then
            select br.mapid into V_STRBRID from brgrp br where  br.brid = V_INBRID;
        else
            V_STRBRID := BRID;
        end if;
    end if;

   IF (CUSTODYCD <> 'ALL')
   THEN
      V_CUSTODYCD := CUSTODYCD;
   ELSE
      V_CUSTODYCD := '%';
   END IF;

      IF (PV_AFACCTNO <> 'ALL')
   THEN
      V_AFACCTNO := PV_AFACCTNO;
   ELSE
      V_AFACCTNO := '%';
   END IF;


 OPEN PV_REFCURSOR
       FOR

       SELECT  PV_AFACCTNO ACCTNO,OD.CUSTODYCD,IO.SYMBOL,OD.TXDATE ,OD.FULLNAME,OD.ADDRESS,
           NVL(SUM (CASE  WHEN OD.EXECTYPE IN('NB','BC')  THEN   NVL(IO.QTTY,0)  END),0)  B_QTTY,
           NVL(SUM (CASE  WHEN OD.EXECTYPE IN('NS','SS','MS')  THEN   NVL(IO.QTTY,0) END),0)  S_QTTY,
           NVL(SUM (CASE  WHEN  OD.EXECTYPE IN('NB','BC') THEN  NVL(IO.AMT,0) END ),0)  B_AMT,
           NVL(SUM (CASE  WHEN  OD.EXECTYPE IN('NS','SS','MS') THEN  NVL(IO.AMT,0) END ),0)  S_AMT,
           NVL(SUM (CASE  WHEN  OD.FEEACR>0 THEN  OD.FEEACR ELSE IO.AMT*(OD.BRATIO -100)/100 END),0) FEEAMT,
           NVL(SUM (CASE WHEN  OD.EXECTYPE IN('NS','SS','MS')   THEN
            (CASE WHEN OD.TAXSELLAMT>0 THEN OD.TAXSELLAMT ELSE OD.TAXRATE*IO.AMT/100 END)  ELSE 0 END ),0) SELLTAXAMT
       FROM
             (SELECT OD.ORDERID,OD.EXECTYPE,OD.BRATIO, OD.FEEACR,OD.TAXSELLAMT,OD.TAXRATE,
             AF.ACCTNO , CF.CUSTODYCD,OD.TXDATE, CF.FULLNAME,CF.ADDRESS FROM
              (SELECT * FROM ODMAST WHERE DELTD='N'
              UNION ALL SELECT * FROM ODMASTHIST WHERE DELTD='N') OD, CFMAST CF, AFMAST AF
              WHERE
                   CF.CUSTID  = AF.CUSTID AND OD.AFACCTNO = AF.ACCTNO
                   AND OD.TXDATE >= TO_DATE(F_DATE , 'DD/MM/YYYY')
                   AND OD.TXDATE <= TO_DATE(T_DATE , 'DD/MM/YYYY')
                   AND CF.CUSTODYCD  LIKE V_CUSTODYCD
                   AND AF.CAREBY IN (SELECT TLGRP.GRPID FROM TLGRPUSERS TLGRP WHERE TLID = V_TLID)
                   --AND (substr(af.acctno,1,4) LIKE V_STRBRID OR instr(V_STRBRID,substr(af.acctno,1,4))<> 0)
                   AND AF.ACCTNO LIKE V_AFACCTNO
             ) OD,
             (SELECT ORGORDERID, SYMBOL,SUM (MATCHQTTY) QTTY, SUM(MATCHQTTY*MATCHPRICE) AMT
              FROM IOD WHERE DELTD <> 'Y' GROUP BY ORGORDERID,SYMBOL
              UNION ALL
              SELECT ORGORDERID, SYMBOL,SUM (MATCHQTTY) QTTY, SUM(MATCHQTTY*MATCHPRICE) AMT
              FROM IODHIST WHERE DELTD <> 'Y' GROUP BY ORGORDERID,SYMBOL) IO
       WHERE
             OD.ORDERID=IO.ORGORDERID
             AND IO.QTTY> 0

       GROUP BY OD.CUSTODYCD,OD.FULLNAME,OD.ADDRESS,OD.TXDATE,IO.SYMBOL  ;

EXCEPTION
   WHEN OTHERS
   THEN
      RETURN;
END;
/

