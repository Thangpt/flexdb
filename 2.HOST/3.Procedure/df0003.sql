CREATE OR REPLACE PROCEDURE DF0003 (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   F_DATE         IN       VARCHAR2,
   T_DATE         IN       VARCHAR2,
   CIACCTNO       IN       VARCHAR2, --CUSTODYCD
   I_BRID         IN       VARCHAR2,
   ACTYPE         IN       VARCHAR2,
   RRTYPE         IN       VARCHAR2,
   CAREBY         IN       VARCHAR2
   )
IS
--
-- PURPOSE: BRIEFLY EXPLAIN THE FUNCTIONALITY OF THE PROCEDURE
-- BANG KE THANH LY
-- MODIFICATION HISTORY
-- PERSON      DATE    COMMENTS
-- DUNGNH   09-MAY-10  CREATED
-- ---------   ------  -------------------------------------------

   V_STROPTION    VARCHAR2 (5);            -- A: ALL; B: BRANCH; S: SUB-BRANCH
   V_STRBRID      VARCHAR2 (4);            -- USED WHEN V_NUMOPTION > 0
   V_STRCIACCTNO  VARCHAR2 (20);

   V_STRI_BRID               VARCHAR2(5);
   V_STRACTYPE               VARCHAR2(5);
   V_STRRRTYPE               VARCHAR2(5);
   V_STRCAREBY               VARCHAR2(5);
   V_FROMDATE DATE;
   V_TODATE DATE;
BEGIN
   V_STROPTION := OPT;
   V_FROMDATE:=TO_DATE(F_DATE,'DD/MM/RRRR');
   V_TODATE:=TO_DATE(T_DATE,'DD/MM/RRRR');

   IF (V_STROPTION <> 'A') AND (BRID <> 'ALL')
   THEN
      V_STRBRID := BRID;
   ELSE
      V_STRBRID := '%';
   END IF;

   IF(CIACCTNO = 'ALL' OR CIACCTNO IS NULL )
   THEN
        V_STRCIACCTNO := '%%';
   ELSE
        V_STRCIACCTNO := CIACCTNO;
   END IF;

   IF(I_BRID = 'ALL' OR I_BRID IS NULL)
    THEN
       V_STRI_BRID := '%';
   ELSE
       V_STRI_BRID := I_BRID;
   END IF;

   IF(ACTYPE = 'ALL' OR ACTYPE IS NULL)
    THEN
       V_STRACTYPE := '%';
   ELSE
       V_STRACTYPE := ACTYPE;
   END IF;

   IF(RRTYPE = 'ALL' OR RRTYPE IS NULL)
    THEN
       V_STRRRTYPE := '%';
   ELSE
       V_STRRRTYPE := RRTYPE;
   END IF;

   IF(CAREBY = 'ALL' OR CAREBY IS NULL)
    THEN
       V_STRCAREBY := '%';
   ELSE
       V_STRCAREBY := CAREBY;
   END IF;

OPEN PV_REFCURSOR
FOR

SELECT DF.ACCTNO, CF.CUSTODYCD, CF.FULLNAME, LN.RLSDATE OPNDATE, SB.SYMBOL,
    (DF.DFQTTY + DF.RCVQTTY + DF.BLOCKQTTY + DF.CARCVQTTY+DF.RLSQTTY) QTTY, DF.AMT,
    LN.OVERDUEDATE NGAYDENHANHD, LN2.RATE1 RATE2,
    CASE WHEN ABS(ROUND(DF.AMT - DF.RLSAMT,0)) < 2 THEN 0 ELSE ROUND(DF.AMT - DF.RLSAMT,0) END  CONLAI,
    BR.BRNAME BRNAME1,
    (RE.CDCONTENT ||' '|| DF.CIACCTNO ||' ' || DF.CUSTBANK) BRNAME,
    TYP.TYPENAME,
    TRALL.TXDATE NGAYHOANTRA,
    TRALL.RLSQTTY NAMT,
    TRALL.RLSAMT MSGAMT,
    (TRALL.TXDATE -  LN.RLSDATE) EXPDATE,
    CASE WHEN TRALL.TXDATE - LN.OVERDUEDATE < 0 THEN 0 ELSE TRALL.TXDATE - LN.OVERDUEDATE END OVERDUEDATE,
    -- TRALL.INTNMLACR LAITHEOHD,
    TRALL.INTPAID - TRALL.INTOVDACR LAITHEOHD,
    TRALL.INTOVDACR LAIQUAHAN,
    (TRALL.INTPAID - TRALL.INTOVDACR) +  TRALL.INTOVDACR TONGLAIKH,
    DF.DESCRIPTION, TRALL.TXNUM, TYP.ACTYPE

FROM VW_DFMAST_ALL DF, CFMAST CF, AFMAST AF, SBSECURITIES SB,
/*    (
        SELECT ACCTNO LNACCTNO, OVERDUEDATE FROM LNSCHD
            WHERE REFTYPE IN ('P','GP')
        UNION ALL
        SELECT ACCTNO LNACCTNO, OVERDUEDATE FROM LNSCHDHIST
            WHERE REFTYPE IN ('P','GP')
    )LN, */
    (
        SELECT  LN.ACCTNO LNACCTNO, MAX(LN.RLSDATE) RLSDATE, MAX(LNSC.OVERDUEDATE) OVERDUEDATE
        FROM VW_LNMAST_ALL LN ,
            (SELECT * FROM LNSCHD UNION ALL SELECT * FROM LNSCHDHIST)LNSC
        WHERE LN.ACCTNO = LNSC.ACCTNO
                    AND LNSC.REFTYPE IN ('P','GP')
        GROUP BY LN.ACCTNO
    )LN,

    LNTYPE LN2, BRGRP BR, DFTYPE TYP, ALLCODE RE ,
    (
    SELECT TXNUM, TXDATE, DFACCTNO,
        SUM(RLSAMT) RLSAMT,
        SUM(RLSQTTY) RLSQTTY,
        SUM(INTNMLACR) INTNMLACR,
        SUM(INTOVDACR) INTOVDACR,
        SUM(INTPAID) INTPAID
    FROM
    (
        --- TRA NO GOC
        SELECT TO_CHAR(TR.TXNUM) TXNUM, TR.TXDATE, TR.ACCTNO DFACCTNO,
            TR.NAMT RLSAMT,
            0 RLSQTTY,
            0 INTNMLACR,
            0 INTOVDACR,
            0 INTPAID
        FROM VW_DFTRAN_ALL TR, APPTX TX, VW_DFMAST_ALL DF
        WHERE TR.TXCD = TX.TXCD AND TR.ACCTNO = DF.ACCTNO
            AND TX.FIELD = 'RLSAMT' AND TX.APPTYPE = 'DF' AND TX.TXTYPE = 'C'
            AND TR.NAMT <> 0
            AND TR.TXDATE BETWEEN V_FROMDATE AND V_TODATE

        --- SO LUONG CK HOAN TRA
        UNION ALL
        SELECT TO_CHAR(TR.TXNUM) TXNUM, TR.TXDATE, TR.ACCTNO DFACCTNO,
            0 RLSAMT,
            TR.NAMT RLSQTTY,
            0 INTNMLACR,
            0 INTOVDACR,
            0 INTPAID
        FROM VW_DFTRAN_ALL TR, APPTX TX, VW_DFMAST_ALL DF
        WHERE TR.TXCD = TX.TXCD AND TR.ACCTNO = DF.ACCTNO
            AND TX.FIELD = 'RLSQTTY' AND TX.APPTYPE = 'DF' AND TX.TXTYPE = 'C'
            AND TR.NAMT <> 0
            AND TR.TXDATE BETWEEN V_FROMDATE AND V_TODATE
        --- TRA NO LAI TRONG HAN
        UNION ALL
        SELECT TO_CHAR(TR.TXNUM) TXNUM, TR.TXDATE, DF.ACCTNO DFACCTNO,
            0 RLSAMT,
            0 RLSQTTY,
            SUM(TR.NAMT) INTNMLACR,
            0 INTOVDACR,
            0 INTPAID
        FROM VW_LNTRAN_ALL TR, APPTX TX, VW_DFMAST_ALL DF, VW_LNMAST_ALL LN
        WHERE TR.TXCD = TX.TXCD AND DF.LNACCTNO = LN.ACCTNO
            AND TR.ACCTNO = LN.ACCTNO AND DF.LNACCTNO = LN.ACCTNO
            AND TX.FIELD IN ( 'INTNMLACR','INTDUE') AND TX.APPTYPE = 'LN' AND TX.TXTYPE = 'D'
            AND TR.NAMT <> 0
            AND TR.TXDATE BETWEEN V_FROMDATE AND V_TODATE
        GROUP BY TO_CHAR(TR.TXNUM), TR.TXDATE, DF.ACCTNO
        --- TRA NO LAI TREN GOC QUA HAN
        UNION ALL
        SELECT TO_CHAR(TR.TXNUM) TXNUM, TR.TXDATE, DF.ACCTNO DFACCTNO,
            0 RLSAMT,
            0 RLSQTTY,
            0 INTNMLACR,
            SUM(TR.NAMT) INTOVDACR,
            0 INTPAID
        FROM VW_LNTRAN_ALL TR, APPTX TX, VW_DFMAST_ALL DF, VW_LNMAST_ALL LN
        WHERE TR.TXCD = TX.TXCD AND DF.LNACCTNO = LN.ACCTNO
            AND TR.ACCTNO = LN.ACCTNO AND DF.LNACCTNO = LN.ACCTNO
            AND TX.FIELD IN ('INTOVDACR','INTNMLOVD') AND TX.APPTYPE = 'LN' AND TX.TXTYPE = 'D'
            AND TR.NAMT <> 0
            AND TR.TXDATE BETWEEN V_FROMDATE AND V_TODATE
        GROUP BY TO_CHAR(TR.TXNUM), TR.TXDATE, DF.ACCTNO
        --- TRA NO LAI TREN GOC QUA HAN
        UNION ALL
        SELECT TO_CHAR(TR.TXNUM) TXNUM, TR.TXDATE, DF.ACCTNO DFACCTNO,
            0 RLSAMT,
            0 RLSQTTY,
            0 INTNMLACR,
            0 INTOVDACR,
            SUM(TR.NAMT) INTPAID
        FROM VW_LNTRAN_ALL TR, APPTX TX, VW_DFMAST_ALL DF, VW_LNMAST_ALL LN
        WHERE TR.TXCD = TX.TXCD AND DF.LNACCTNO = LN.ACCTNO
            AND TR.ACCTNO = LN.ACCTNO AND DF.LNACCTNO = LN.ACCTNO
            AND TX.FIELD IN ('INTPAID') AND TX.APPTYPE = 'LN' AND TX.TXTYPE = 'C'
            AND TR.NAMT <> 0
            AND TR.TXDATE BETWEEN V_FROMDATE AND V_TODATE
        GROUP BY TO_CHAR(TR.TXNUM), TR.TXDATE, DF.ACCTNO
    ) TR
    GROUP BY TXNUM, TXDATE, DFACCTNO
    ) TRALL
WHERE CF.CUSTID = AF.CUSTID AND DF.AFACCTNO = AF.ACCTNO
    AND DF.CODEID = SB.CODEID
    AND DF.LNACCTNO = LN.LNACCTNO
    AND DF.LNTYPE = LN2.ACTYPE
    AND DF.ACCTNO = TRALL.DFACCTNO
    AND BR.BRID = SUBSTR(DF.ACCTNO,1,4)
    AND RE.CDVAL = DF.RRTYPE AND CDNAME = 'RRTYPE' AND CDTYPE = 'DF'
    AND TYP.ACTYPE = DF.ACTYPE
    AND ABS(TRALL.RLSQTTY)  + ABS(TRALL.RLSAMT) + ROUND(ABS(TRALL.INTPAID),0) > 0
    AND CF.CUSTODYCD LIKE V_STRCIACCTNO
    AND BR.BRID LIKE V_STRI_BRID
    AND DF.ACTYPE LIKE V_STRACTYPE
    AND DF.RRTYPE LIKE V_STRRRTYPE
    AND CF.CAREBY LIKE V_STRCAREBY
ORDER BY TRALL.TXDATE, DF.ACCTNO, TRALL.TXNUM
;
EXCEPTION
   WHEN OTHERS
   THEN
      RETURN;
END;
/

