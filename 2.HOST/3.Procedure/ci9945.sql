CREATE OR REPLACE PROCEDURE CI9945
 (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   F_DATE         IN       VARCHAR2,
   T_DATE         IN       VARCHAR2,
   PV_CUSTODYCD   IN       VARCHAR2,
   PV_AFACCTNO    IN       VARCHAR2,
   TLID IN VARCHAR2
  )
IS
--

-- BANG KE CHI TIET PHONG TOA TIEN
-- MODIFICATION HISTORY
-- PERSON       DATE                COMMENTS
-- ---------   ------  -------------------------------------------
-- HUONG.TTD    08-OCT-2010           CREATED


   CUR            PKG_REPORT.REF_CURSOR;
   V_STROPTION    VARCHAR2 (5);            -- A: ALL; B: BRANCH; S: SUB-BRANCH
   V_STRBRID      VARCHAR2 (4);                   -- USED WHEN V_NUMOPTION > 0
   V_FROMDATE DATE;
   V_TODATE DATE;
   V_CURRDATE DATE;
   V_CUSTODYCD VARCHAR2(20);
   V_AFACCTNO VARCHAR2(20);
   V_TLID VARCHAR2(4);


BEGIN

V_TLID := TLID;
V_STROPTION := OPT;
IF V_STROPTION = 'A' THEN
    V_STRBRID := '%';
ELSIF V_STROPTION = 'B' THEN
    V_STRBRID := SUBSTR(BRID,1,2) || '__' ;
ELSE
    V_STRBRID:=BRID;
END IF;

V_FROMDATE  := TO_DATE(F_DATE,'DD/MM/RRRR');
V_TODATE    := TO_DATE(T_DATE,'DD/MM/RRRR');
V_CUSTODYCD := UPPER(REPLACE(PV_CUSTODYCD,'.',''));
V_AFACCTNO  := UPPER(REPLACE(PV_AFACCTNO,'.',''));
dbms_output.put_line('V_CUSTODYCD'||V_CUSTODYCD);
dbms_output.put_line('F_DATE'||F_DATE);
dbms_output.put_line('T_DATE'||T_DATE);

OPEN PV_REFCURSOR FOR

SELECT T.TXDATE, T.TXDESC, T.TXNUM,CF.FULLNAME, CF.CUSTODYCD, A.ACCTNO,
       CI.EMKAMT+ A.NAMT BEGIN_AMT,T.AMT_C,T.AMT_D

FROM CFMAST CF, CIMAST CI,
(
---- Phat sinh tu ngay fromdate den ngay hien tai

  SELECT TR.custodycd,TR.ACCTNO, ROUND(SUM(CASE WHEN TR.TXTYPE = 'C' THEN -TR.NAMT ELSE TR.NAMT END),0) NAMT
    FROM VW_CITRAN_GEN TR
    WHERE TR.FIELD = 'EMKAMT'
        AND TR.TXTYPE IN ('C','D')
        AND TR.TXDATE >= V_FROMDATE
        AND TR.CUSTODYCD LIKE V_CUSTODYCD
   GROUP BY TR.custodycd, TR.ACCTNO
) a,

(
-- Phat sinh tang, giam tu ngay fromdate den todate

  SELECT TR.custodycd,TR.ACCTNO,TR.TXNUM,TR.TXDATE,TR.TXDESC,
         ROUND(SUM(CASE WHEN TR.TXTYPE = 'C' THEN TR.NAMT ELSE 0 END),0) AMT_C,
         ROUND(SUM(CASE WHEN TR.TXTYPE = 'D' THEN TR.NAMT ELSE 0 END),0) AMT_D
    FROM VW_CITRAN_GEN TR
    WHERE TR.FIELD = 'EMKAMT'
        AND TR.TXTYPE IN ('C','D')
        AND TR.TXDATE BETWEEN V_FROMDATE AND V_TODATE
        AND TR.CUSTODYCD LIKE V_CUSTODYCD
   GROUP BY TR.custodycd, TR.ACCTNO,TR.TXNUM,TR.TXDATE,TR.TXDESC
) T
WHERE CF.CUSTODYCD=A.CUSTODYCD
AND CI.ACCTNO= A.ACCTNO
AND CI.ACCTNO=T.ACCTNO
AND CF.CUSTODYCD LIKE V_CUSTODYCD
ORDER BY T.TXDATE, T.TXNUM
;


END;
/

