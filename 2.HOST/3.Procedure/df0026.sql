CREATE OR REPLACE PROCEDURE df0026 (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   I_DATE         IN       VARCHAR2,
   ACTYPE         IN       VARCHAR2,
   BRGID          IN       VARCHAR2
   )
IS
--
-- PURPOSE: BRIEFLY EXPLAIN THE FUNCTIONALITY OF THE PROCEDURE
-- BANG KE HOAN TRA GUI THANG LONG
-- MODIFICATION HISTORY
-- PERSON      DATE    COMMENTS
-- DUNGNH    16/07/10
-- ---------   ------  -------------------------------------------

   V_STROPTION      VARCHAR2 (5);            -- A: ALL; B: BRANCH; S: SUB-BRANCH
   V_STRBRID        VARCHAR2 (4);            -- USED WHEN V_NUMOPTION > 0


   V_STRACTYPE  VARCHAR2 (10);
   V_STRBRGID  VARCHAR2 (10);


   V_INDATE     DATE;

BEGIN
   V_STROPTION := OPT;

   IF V_STROPTION = 'A' THEN     -- TOAN HE THONG
      V_STRBRID := '%';
   ELSIF V_STROPTION = 'B' THEN
      V_STRBRID := SUBSTR(BRID,1,2) || '__' ;
   ELSE
      V_STRBRID := BRID;
   END IF;

   IF(ACTYPE <> 'ALL') THEN
     V_STRACTYPE := ACTYPE;
   ELSE
     V_STRACTYPE := '%';
   END IF;


   IF(BRGID <> 'ALL') THEN
     V_STRBRGID := BRGID;
   ELSE
     V_STRBRGID := '%';
   END IF;

   V_INDATE  :=  TO_DATE(I_DATE,'DD/MM/YYYY');

OPEN PV_REFCURSOR
FOR
SELECT DF.ACCTNO, CF.CUSTODYCD, TRALL.TXNUM, TRALL.RLSAMT, DF.TXDATE OPDATE,
    TRALL.TXDATE EXDATE, LN.OVERDUEDATE, (TRALL.INTPAID-TRALL.INTOVDACR) INTPAID,
    TRALL.INTOVDACR, BR.BRNAME,  DF.ACTYPE
FROM VW_DFMAST_ALL DF, CFMAST CF, AFMAST AF, BRGRP BR,
    (
        SELECT * FROM
        (
            SELECT ACCTNO LNACCTNO, OVERDUEDATE FROM LNSCHD
            WHERE REFTYPE IN ('P','GP')
            UNION ALL
            SELECT ACCTNO LNACCTNO, OVERDUEDATE FROM LNSCHDHIST
            WHERE REFTYPE IN ('P','GP')
        )
    )LN,
    (
        SELECT TXNUM, TXDATE, DFACCTNO,
            SUM(RLSAMT) RLSAMT,
            SUM(INTOVDACR) INTOVDACR,
            SUM(INTPAID) INTPAID
        FROM
        (
            --- TRA NO GOC
            SELECT TO_CHAR(TR.TXNUM) TXNUM, TR.TXDATE, TR.ACCTNO DFACCTNO,
                TR.NAMT RLSAMT,
                0 INTOVDACR,
                0 INTPAID
            FROM VW_DFTRAN_ALL TR, APPTX TX, VW_DFMAST_ALL DF
            WHERE TR.TXCD = TX.TXCD AND TR.ACCTNO = DF.ACCTNO
                AND TX.FIELD = 'RLSAMT' AND TX.APPTYPE = 'DF' AND TX.TXTYPE = 'C'
                AND TR.NAMT <> 0
                AND TR.TXDATE = V_INDATE
            --- TRA NO LAI
            UNION ALL
            SELECT TO_CHAR(TR.TXNUM) TXNUM, TR.TXDATE, DF.ACCTNO DFACCTNO,
                0 RLSAMT,
                SUM(TR.NAMT) INTOVDACR,
                0 INTPAID
            FROM VW_LNTRAN_ALL TR, APPTX TX, VW_DFMAST_ALL DF, VW_LNMAST_ALL LN
            WHERE TR.TXCD = TX.TXCD AND DF.LNACCTNO = LN.ACCTNO
                AND TR.ACCTNO = LN.ACCTNO AND DF.LNACCTNO = LN.ACCTNO
                AND TX.FIELD = 'INTOVDACR'
                AND TX.APPTYPE = 'LN' AND TX.TXTYPE = 'D'
                AND TR.NAMT <> 0
                AND TR.TXDATE = V_INDATE
            GROUP BY TO_CHAR(TR.TXNUM), TR.TXDATE, DF.ACCTNO
            --- TRA NO LAI TREN GOC QUA HAN
            UNION ALL
            SELECT TO_CHAR(TR.TXNUM) TXNUM, TR.TXDATE, DF.ACCTNO DFACCTNO,
                0 RLSAMT,
                0 INTOVDACR,
                SUM(TR.NAMT) INTPAID
            FROM VW_LNTRAN_ALL TR, APPTX TX, VW_DFMAST_ALL DF, VW_LNMAST_ALL LN
            WHERE TR.TXCD = TX.TXCD AND DF.LNACCTNO = LN.ACCTNO
                AND TR.ACCTNO = LN.ACCTNO AND DF.LNACCTNO = LN.ACCTNO
                AND TX.FIELD = 'INTPAID'
                AND TX.APPTYPE = 'LN'
                AND TX.TXTYPE = 'C'
                AND TR.NAMT <> 0
                AND TR.TXDATE = V_INDATE
            GROUP BY TO_CHAR(TR.TXNUM), TR.TXDATE, DF.ACCTNO
        ) TR
        GROUP BY TXNUM, TXDATE, DFACCTNO
    ) TRALL
WHERE DF.ACCTNO = TRALL.DFACCTNO
    AND DF.AFACCTNO = AF.ACCTNO
    AND AF.CUSTID = CF.CUSTID
    AND DF.LNACCTNO = LN.LNACCTNO
    AND (CASE WHEN SUBSTR(TRALL.TXNUM,1,2) = '99'
                THEN SUBSTR(DF.ACCTNO,1,4) ELSE SUBSTR(TRALL.TXNUM,1,4) END) = BR.BRID
    AND DF.ACTYPE LIKE V_STRACTYPE
    AND (CASE WHEN BR.BRID = '0021' THEN BR.BRID ELSE '1111' END) LIKE V_STRBRGID

ORDER BY DF.ACCTNO, DF.TXDATE
;
EXCEPTION
   WHEN OTHERS
   THEN
      RETURN;
END;                                                              -- PROCEDURE
/

