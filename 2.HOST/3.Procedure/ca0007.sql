CREATE OR REPLACE PROCEDURE ca0007 (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   I_DATE         IN       VARCHAR2,
   SYMBOL         IN       VARCHAR2
   )
IS
--
-- PURPOSE: BRIEFLY EXPLAIN THE FUNCTIONALITY OF THE PROCEDURE
-- BAO CAO TAI KHOAN TIEN TONG HOP CUA NGUOI DAU TU
-- MODIFICATION HISTORY
-- PERSON      DATE    COMMENTS
-- NAMNT   20-DEC-06  CREATE
-- ---------   ------  -------------------------------------------

    CUR             PKG_REPORT.REF_CURSOR;
    V_STROPTION    VARCHAR2 (5);            -- A: ALL; B: BRANCH; S: SUB-BRANCH
    V_STRBRID      VARCHAR2 (4);
    V_STRCACODE    VARCHAR2 (20);
    V_STRAFACCTNO     VARCHAR2 (20);
   V_STRSYMBOL     VARCHAR2 (20);
BEGIN
   V_STROPTION := OPT;

   IF (V_STROPTION <> 'A') AND (BRID <> 'ALL')
   THEN
      V_STRBRID := BRID;
   ELSE
      V_STRBRID := '%%';
   END IF;

 IF (SYMBOL <> 'ALL')
   THEN
      V_STRSYMBOL := replace(SYMBOL,' ','_');
   ELSE
      V_STRSYMBOL := '%%';
   END IF;

   -- GET REPORT'S PARAMETERS

OPEN PV_REFCURSOR
   FOR
SELECT MAX(CF.fullname) , MAX(SE.afacctno)afacctno , MAX(CF.address || AL.CDCONTENT)  address, MAX(CF.idcode) idcode   , SE.ACCTNO ,  max(se.trade) - SUM(NVL(NUM.AMT_TRADE,0)) trade
,max(se.MORTAGE) - SUM(NVL(NUM.AMT_MORTAGE,0)) MORTAGE
,max(se.BLOCKED) - SUM(NVL(NUM.AMT_BLOCKED,0)) blocked, MAX(SB.symbol)symbol, max(sb.parvalue) parvalue, MAX(nvl(AL1.CDCONTENT,' '))rol
FROM  SEMAST SE, SBSECURITIES SB, afmast af , cfmast cf, ALLCODE AL, ISSUER_MEMBER iss,ALLCODE AL1,
(SELECT (CASE WHEN APP.TXTYPE = 'D' AND APP.FIELD = 'TRADE' THEN -TR.NAMT WHEN APP.TXTYPE = 'C' AND APP.FIELD = 'TRADE'  THEN TR.NAMT ELSE 0  END ) AMT_TRADE,
        (CASE WHEN APP.TXTYPE = 'D' AND APP.FIELD = 'MORTAGE'  THEN -TR.NAMT WHEN APP.TXTYPE = 'C' AND APP.FIELD = 'MORTAGE'  THEN TR.NAMT ELSE 0  END ) AMT_MORTAGE,
        (CASE WHEN APP.TXTYPE = 'D' AND APP.FIELD = 'BLOCKED'  THEN -TR.NAMT WHEN APP.TXTYPE = 'C' AND APP.FIELD = 'BLOCKED'  THEN TR.NAMT ELSE 0  END ) AMT_BLOCKED
       ,TR.ACCTNO ACCTNO
          FROM APPTX APP, SETRAN TR, TLLOG TL
          WHERE TR.TXCD = APP.TXCD
               AND TL.TXNUM =TR.TXNUM
               AND APP.APPTYPE = 'SE'
               AND APP.TXTYPE IN ('C', 'D')
               AND TL.DELTD <>'Y'
               AND TL.BUSDATE > TO_DATE(I_DATE ,'DD/MM/YYYY' )
               AND APP.FIELD IN ('TRADE','MORTAGE','BLOCKED')
  UNION ALL
  SELECT (CASE WHEN APP.TXTYPE = 'D' AND APP.FIELD = 'TRADE' THEN -TR.NAMT WHEN APP.TXTYPE = 'C' AND APP.FIELD = 'TRADE'  THEN TR.NAMT ELSE 0  END ) AMT_TRADE,
        (CASE WHEN APP.TXTYPE = 'D' AND APP.FIELD = 'MORTAGE'  THEN -TR.NAMT WHEN APP.TXTYPE = 'C' AND APP.FIELD = 'MORTAGE'  THEN TR.NAMT ELSE 0  END ) AMT_MORTAGE,
        (CASE WHEN APP.TXTYPE = 'D' AND APP.FIELD = 'BLOCKED'  THEN -TR.NAMT WHEN APP.TXTYPE = 'C' AND APP.FIELD = 'BLOCKED'  THEN TR.NAMT ELSE 0  END ) AMT_BLOCKED
       ,TR.ACCTNO ACCTNO
          FROM APPTX APP, SETRANA TR, TLLOGALL TL
          WHERE TR.TXCD = APP.TXCD
               AND TL.TXNUM =TR.TXNUM
               AND APP.APPTYPE = 'SE'
               AND APP.TXTYPE IN ('C', 'D')
               AND TL.DELTD <>'Y'
             AND TL.BUSDATE > TO_DATE(I_DATE ,'DD/MM/YYYY' )
               AND APP.FIELD IN ('TRADE','MORTAGE','BLOCKED')
          )          NUM
WHERE SE.ACCTNO=NUM.ACCTNO (+)
AND SE.CODEID = SB.CODEID
AND SE.AFACCTNO = AF.ACCTNO
AND AF.CUSTID = CF.CUSTID
AND AL.CDNAME ='COUNTRY'
AND AL.CDTYPE ='CF'
AND AL.CDVAL = CF.COUNTRY
AND CF.CUSTID = iss.CUSTID(+)
AND AL1.CDNAME(+) ='ROLECD'
AND AL1.CDTYPE(+) ='SA'
AND iss.ROLECD= AL1.CDVAL(+)
AND SB.symbol LIKE V_STRSYMBOL
GROUP BY SE.ACCTNO
order by max(CF.COUNTRY)


 ;


EXCEPTION
   WHEN OTHERS
   THEN
      RETURN;
END;                                                              -- PROCEDURE
/

