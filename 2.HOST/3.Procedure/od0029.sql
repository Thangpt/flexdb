CREATE OR REPLACE PROCEDURE od0029 (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   F_DATE         IN       VARCHAR2,
   T_DATE         IN       VARCHAR2,
   AFACCTNO       IN       VARCHAR2,
   REFNAME       IN       VARCHAR2,
   CURRENT_INDEX	 	 NUMBER  DEFAULT NULL,
   OFFSET_NUMBER	 	 NUMBER  DEFAULT NULL,
   ONL                	 VARCHAR2  DEFAULT NULL
)
IS
--
-- PURPOSE: BRIEFLY EXPLAIN THE FUNCTIONALITY OF THE PROCEDURE
-- BAO CAO TINH HINH GIAO DICH CAU KHACH HANG
-- MODIFICATION HISTORY
-- PERSON      DATE    COMMENTS
-- NAMNT   20-DEC-06  CREATED
-- ---------   ------  -------------------------------------------
   V_STROPTION     VARCHAR2 (5);            -- A: ALL; B: BRANCH; S: SUB-BRANCH
   V_STRBRID       VARCHAR2 (4);                   -- USED WHEN V_NUMOPTION > 0
   V_STRAFACCTNO   VARCHAR2 (20);
   V_STRREFNAME   VARCHAR2 (20);
   PV_CUR     PKG_REPORT.REF_CURSOR;
   V_NUMSFEE       NUMBER;
   v_onl varchar2(20);

BEGIN
   V_STROPTION := OPT;

   IF (V_STROPTION <> 'A') AND (BRID <> 'ALL')
   THEN
      V_STRBRID := BRID;
   ELSE
      V_STRBRID := '%%';
   END IF;

   -- GET REPORT'S PARAMETERS

    IF  (AFACCTNO <> 'ALL')
   THEN
      V_STRAFACCTNO := AFACCTNO;
   ELSE
      V_STRAFACCTNO := '%%';
   END IF;

    IF  (REFNAME <> 'ALL')
   THEN
      V_STRREFNAME := REFNAME;
   ELSE
      V_STRREFNAME := '%%';
   END IF;

    IF  (nvl(ONL,'_') <> 'ALL')
   THEN
      V_ONL := ONL;
   ELSE
      V_ONL := '%%';
   END IF;


   -- END OF GETTING REPORT'S PARAMETERS

IF ONL IS NULL   THEN
   -- GET REPORT'S DATA
    OPEN PV_REFCURSOR
       FOR
SELECT DT.*, (CASE WHEN DT.EXECAMT = 0 THEN 0 ELSE  Round(DT.FEEACR*100/DT.EXECAMT,3)  END) PERFEE
FROM
(
    SELECT AFACCTNO, MAX(CF.FULLNAME) FULLNAME,
    SUM( CASE WHEN EXECAMT > MATCHAMT THEN EXECAMT ELSE MATCHAMT END  ) EXECAMT, SUM(FEEACR) FEEACR
    FROM CFMAST CF,
    ( SELECT * FROM  AFMAST
      WHERE ACCTNO LIKE  V_STRAFACCTNO
    )AF,
    (
        SELECT * FROM ODMAST
        WHERE DELTD<>'Y'
        AND  TXDATE >=TO_DATE(F_DATE ,'DD/MM/YYYY')
        AND  TXDATE <=TO_DATE(T_DATE ,'DD/MM/YYYY')
        AND EXECTYPE NOT IN ('CB','CS','AB','AS')
        UNION ALL
        SELECT * FROM ODMASTHIST
        WHERE DELTD<>'Y'
        AND  TXDATE >=TO_DATE(F_DATE ,'DD/MM/YYYY')
        AND  TXDATE <=TO_DATE(T_DATE ,'DD/MM/YYYY')
        AND EXECTYPE NOT IN ('CB','CS','AB','AS')
    )OD
    WHERE OD.AFACCTNO =AF.ACCTNO
    AND CF.CUSTID = AF.CUSTID
    AND nvl(CF.REFNAME,'-') LIKE V_STRREFNAME
    GROUP BY AFACCTNO
)DT

;

ELSE

OPEN PV_CUR
 FOR
SELECT  SUM(FEEACR) FEEACR
FROM AFMAST AF , CFMAST CF,
(
SELECT * FROM ODMAST
WHERE DELTD<>'Y'
AND  TXDATE >=TO_DATE(F_DATE ,'DD/MM/YYYY')
AND  TXDATE <=TO_DATE(T_DATE ,'DD/MM/YYYY')
AND EXECTYPE NOT IN ('CB','CS','AB','AS')
 UNION ALL
SELECT * FROM ODMASTHIST
WHERE DELTD<>'Y'
AND  TXDATE >=TO_DATE(F_DATE ,'DD/MM/YYYY')
AND  TXDATE <=TO_DATE(T_DATE ,'DD/MM/YYYY')
AND EXECTYPE NOT IN ('CB','CS','AB','AS')
)OD
WHERE OD.AFACCTNO = AF.ACCTNO
AND AF.CUSTID = CF.CUSTID
And ( (ONL = 'ALL' and af.acctno like  V_STRAFACCTNO )
     or( ONL <> 'ALL' AND CF.REFNAME LIKE v_ONL  )
    ) ;
LOOP
FETCH PV_CUR
INTO V_NUMSFEE;

EXIT WHEN PV_CUR%NOTFOUND;
END LOOP;
CLOSE PV_CUR;
V_NUMSFEE := nvl(V_NUMSFEE,0);

   OPEN PV_REFCURSOR
       FOR
SELECT ROWNUM, DT.*,
    (CASE WHEN DT.EXECAMT = 0 THEN 0 ELSE Round(DT.FEEACR*100/DT.EXECAMT,2)  END) PERFEE,
    (CASE WHEN  V_NUMSFEE = 0 THEN 0 ELSE Round(DT.FEEACR * 100/ V_NUMSFEE,2) END) PERFEES FROM
(
        SELECT  AFACCTNO, MAX(CF.FULLNAME) FULLNAME,
        SUM( CASE WHEN EXECAMT > MATCHAMT THEN EXECAMT ELSE MATCHAMT END  ) EXECAMT, SUM(FEEACR) FEEACR
        FROM CFMAST CF,  AFMAST AF,
        (SELECT * FROM ODMAST
        WHERE DELTD<>'Y'
        AND  TXDATE >=TO_DATE(F_DATE ,'DD/MM/YYYY')
        AND  TXDATE <=TO_DATE(T_DATE ,'DD/MM/YYYY')
       AND EXECTYPE NOT IN ('CB','CS','AB','AS')
         UNION ALL
        SELECT * FROM ODMASTHIST
        WHERE DELTD<>'Y'
        AND  TXDATE >=TO_DATE(F_DATE ,'DD/MM/YYYY')
        AND  TXDATE <=TO_DATE(T_DATE ,'DD/MM/YYYY')
         AND EXECTYPE NOT IN ('CB','CS','AB','AS')
        )OD
        WHERE OD.AFACCTNO =AF.ACCTNO
        AND CF.CUSTID = AF.CUSTID
        And ( (ONL = 'ALL' and af.acctno like  V_STRAFACCTNO )
              or( ONL <> 'ALL' AND CF.REFNAME LIKE v_ONL  )
            )
        GROUP BY AFACCTNO
)DT
WHERE ROWNUM BETWEEN (NVL(CURRENT_INDEX,1)-1)*NVL(OFFSET_NUMBER,1000000) +1 AND NVL(CURRENT_INDEX,1)*NVL(OFFSET_NUMBER,1000000)
ORDER BY DT.FULLNAME ;

END IF;




EXCEPTION
   WHEN OTHERS
   THEN
      RETURN;
END;                                                              -- PROCEDURE
/

