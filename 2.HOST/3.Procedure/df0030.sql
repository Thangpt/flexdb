CREATE OR REPLACE PROCEDURE DF0030 (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   F_DATE         IN       VARCHAR2,
   T_DATE         IN       VARCHAR2,
   CUSTODYCD      IN       VARCHAR2,
   BRGID          IN       VARCHAR2
   )
IS
--
-- PURPOSE: BRIEFLY EXPLAIN THE FUNCTIONALITY OF THE PROCEDURE
-- BAO CAO TAI KHOAN TIEN TONG HOP CUA NGUOI DAU TU
-- MODIFICATION HISTORY
-- PERSON      DATE    COMMENTS
-- DUNGNH
-- ---------   ------  -------------------------------------------

   V_STROPTION      VARCHAR2 (5);            -- A: ALL; B: BRANCH; S: SUB-BRANCH
   V_STRBRID          VARCHAR2 (4);            -- USED WHEN V_NUMOPTION > 0

  V_STRCUSTODYCD VARCHAR2 (20);
   V_STRBRGID  VARCHAR2 (10);


   V_FROMDATE     DATE;
   V_TODATE       DATE;

BEGIN
   V_STROPTION := OPT;

   IF V_STROPTION = 'A' THEN     -- TOAN HE THONG
      V_STRBRID := '%';
   ELSIF V_STROPTION = 'B' THEN
      V_STRBRID := SUBSTR(BRID,1,2) || '__' ;
   ELSE
      V_STRBRID := BRID;
   END IF;

   IF(CUSTODYCD <> 'ALL') THEN
     V_STRCUSTODYCD := CUSTODYCD;
   ELSE
     V_STRCUSTODYCD := '%';
   END IF;


   IF(BRGID <> 'ALL') THEN
     V_STRBRGID := BRGID;
   ELSE
     V_STRBRGID := '%';
   END IF;


   V_FROMDATE  :=  TO_DATE(F_DATE,'DD/MM/YYYY');
   V_TODATE    :=  TO_DATE(T_DATE,'DD/MM/YYYY');

OPEN PV_REFCURSOR
FOR
  SELECT ALLCODE.CDCONTENT, DF.ACCTNO, DF.TXNUM, CF.CUSTODYCD, DF.TXDATE, LN.OVERDUEDATE,
    DF.ACTYPE, SB.SYMBOL, DF.DFPRICE, ROUND(DF.DFPRICE*100/DF.REFPRICE,2) TLGOPVON,
    (CASE WHEN DF.TXDATE BETWEEN V_FROMDATE AND V_TODATE
        THEN DF.AMT ELSE 0 END) GIATRIGIAINGAN,
    (CASE WHEN DF.TXDATE BETWEEN V_FROMDATE AND V_TODATE
        THEN (DF.DFQTTY + DF.RCVQTTY + DF.BLOCKQTTY + DF.CARCVQTTY+DF.RLSQTTY) ELSE 0 END) SLGIAINGAN,
    NVL(TRALL.RLSAMT,0)GIATRITHANHLY,
    NVL(TRALL.RLSQTTY,0)SOLUONGTHANHLY,
    ROUND(DF.AMT-DF.RLSAMT+DF.NAMT) GIATRICONGLAI,
    (DF.DFQTTY + DF.RCVQTTY + DF.BLOCKQTTY + DF.CARCVQTTY + DF.QTTY) SL_CONLAI,
    NVL(TLPROFILES.TLNAME,'') TLNAME, NVL(BR.BRNAME,'') BRNAME,
    (A1.CDCONTENT ||' '|| DF.CIACCTNO || ' ' || DF.CUSTBANK) NGUONGIAINGAN
FROM ALLCODE , AFMAST AF, CFMAST CF, SBSECURITIES SB, ALLCODE A1,
    (SELECT * FROM (
        SELECT DF.*, NVL(DFA2.NAMT,0) NAMT, NVL(DFA2.QTTY,0) QTTY
        FROM (SELECT * FROM VW_DFMAST_ALL WHERE TXDATE <= V_TODATE)DF,
        (SELECT *
            FROM (
                SELECT DFA.ACCTNO,
                    SUM(CASE WHEN TX.FIELD = 'RLSAMT' THEN (CASE WHEN TX.TXTYPE = 'D' THEN -DFA.NAMT ELSE DFA.NAMT END)
                                ELSE 0 END) NAMT,
                    SUM(CASE WHEN TX.FIELD = 'RLSQTTY' THEN (CASE WHEN TX.TXTYPE = 'D' THEN -DFA.NAMT ELSE DFA.NAMT END)
                                ELSE 0 END) QTTY
                FROM VW_DFTRAN_ALL DFA, APPTX TX
                WHERE DFA.TXCD = TX.TXCD
                    AND TX.TXTYPE IN ('C','D')
                    AND TX.FIELD IN ('RLSAMT','RLSQTTY')
                    AND TX.APPTYPE = 'DF'
                    AND DFA.NAMT > 0
                    AND DFA.TXDATE >= V_FROMDATE
                GROUP BY DFA.ACCTNO
            )
        )DFA1,
        (
            SELECT *
            FROM (
                SELECT DFA.ACCTNO,
                    SUM(CASE WHEN TX.FIELD = 'RLSAMT' THEN (CASE WHEN TX.TXTYPE = 'D' THEN -DFA.NAMT ELSE DFA.NAMT END)
                                ELSE 0 END) NAMT,
                    SUM(CASE WHEN TX.FIELD = 'RLSQTTY' THEN (CASE WHEN TX.TXTYPE = 'D' THEN -DFA.NAMT ELSE DFA.NAMT END)
                                ELSE 0 END) QTTY
                FROM VW_DFTRAN_ALL DFA, APPTX TX
                WHERE DFA.TXCD = TX.TXCD
                    AND TX.TXTYPE IN ('C','D')
                    AND TX.FIELD IN ('RLSAMT','RLSQTTY')
                    AND TX.APPTYPE = 'DF'
                    AND DFA.NAMT > 0
                    AND DFA.TXDATE > V_TODATE
                GROUP BY DFA.ACCTNO
                )
        )DFA2
    WHERE DF.ACCTNO = DFA1.ACCTNO(+)
        AND DF.ACCTNO = DFA2.ACCTNO(+)
        AND ((DF.AMT-DF.RLSAMT+NVL(DFA1.NAMT,0)) > 2 ))
    ) DF,
    (
        SELECT DFACCTNO,
        SUM(RLSAMT) RLSAMT,
        SUM(RLSQTTY) RLSQTTY
        FROM
        (
            --- TRA NO GOC
            SELECT TO_CHAR(TR.TXNUM) TXNUM, TR.TXDATE, TR.ACCTNO DFACCTNO,
                TR.NAMT RLSAMT,
                0 RLSQTTY
            FROM VW_DFTRAN_ALL TR, APPTX TX, VW_DFMAST_ALL DF
            WHERE TR.TXCD = TX.TXCD AND TR.ACCTNO = DF.ACCTNO
                AND TX.FIELD = 'RLSAMT' AND TX.APPTYPE = 'DF' AND TX.TXTYPE = 'C'
                AND TR.NAMT > 0
                AND TR.TXDATE BETWEEN V_FROMDATE AND V_TODATE

            --- SO LUONG CK HOAN TRA
            UNION ALL
            SELECT TO_CHAR(TR.TXNUM) TXNUM, TR.TXDATE, TR.ACCTNO DFACCTNO,
                0 RLSAMT,
                TR.NAMT RLSQTTY
            FROM VW_DFTRAN_ALL TR, APPTX TX, VW_DFMAST_ALL DF
            WHERE TR.TXCD = TX.TXCD AND TR.ACCTNO = DF.ACCTNO
                AND TX.FIELD = 'RLSQTTY' AND TX.APPTYPE = 'DF' AND TX.TXTYPE = 'C'
                AND TR.NAMT > 0
                AND TR.TXDATE BETWEEN V_FROMDATE AND V_TODATE
        ) TR
        GROUP BY DFACCTNO
    )TRALL,
    (
        SELECT  * FROM
            (SELECT REFTYPE, ACCTNO LNACCTNO, OVERDUEDATE
            FROM LNSCHD
            WHERE REFTYPE IN ('P','GP')
            UNION ALL
            SELECT REFTYPE, ACCTNO LNACCTNO, OVERDUEDATE
            FROM LNSCHDHIST
            WHERE REFTYPE IN ('P','GP')
            )
    )LN,
    VW_TLLOG_ALL TL, TLPROFILES, BRGRP BR
WHERE DF.ACCTNO = TRALL.DFACCTNO(+)
    AND ALLCODE.CDNAME = 'DFTYPE'
    AND ALLCODE.CDTYPE = 'DF'
    AND DF.DFTYPE = ALLCODE.CDVAL
    AND DF.AFACCTNO = AF.ACCTNO
    AND AF.CUSTID = CF.CUSTID
    AND DF.LNACCTNO = LN.LNACCTNO
    AND DF.CODEID = SB.CODEID
    AND DF.RRTYPE = A1.CDVAL
    AND A1.CDNAME = 'RRTYPE'
    AND DF.TXNUM = TL.TXNUM(+)
    AND DF.TXDATE = TL.TXDATE(+)
    AND NVL(TL.TLID,'') = TLPROFILES.TLID(+)
    AND NVL(TL.BRID,'') = BR.BRID(+)
    AND CF.CUSTODYCD LIKE V_STRCUSTODYCD
    AND NVL(TL.TLID,'') LIKE V_STRBRGID
;
EXCEPTION
   WHEN OTHERS
   THEN
      RETURN;
END;                                                              -- PROCEDURE
/

