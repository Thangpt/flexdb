CREATE OR REPLACE PROCEDURE DF0019 (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   F_DATE         IN       VARCHAR2,
   T_DATE         IN       VARCHAR2,
   PV_CUSTODYCD   IN       VARCHAR2,
   PV_AFACCTNO    IN       VARCHAR2,
   TLID IN VARCHAR2
  )
IS
--

-- BAO CAO SAO KE TIEN CUA TAI KHOAN KHACH HANG
-- MODIFICATION HISTORY
-- PERSON       DATE                COMMENTS
-- ---------   ------  -------------------------------------------
-- DUNGNH     07-SEP-2010           CREATED


   CUR            PKG_REPORT.REF_CURSOR;
   V_STROPTION    VARCHAR2 (5);            -- A: ALL; B: BRANCH; S: SUB-BRANCH
   V_STRBRID      VARCHAR2 (4);                   -- USED WHEN V_NUMOPTION > 0
   V_FROMDATE DATE;
   V_TODATE DATE;
   V_CURRDATE DATE;
   V_CUSTODYCD VARCHAR2(20);
   V_AFACCTNO VARCHAR2(20);
   V_TLID VARCHAR2(4);
   BEGIN_AMT NUMBER(20);

BEGIN

V_TLID := TLID;
V_STROPTION := OPT;
IF V_STROPTION = 'A' THEN
    V_STRBRID := '%';
ELSIF V_STROPTION = 'B' THEN
    V_STRBRID := SUBSTR(BRID,1,2) || '__' ;
ELSE
    V_STRBRID:=BRID;
END IF;

V_FROMDATE  := TO_DATE(F_DATE,'DD/MM/RRRR');
V_TODATE    := TO_DATE(T_DATE,'DD/MM/RRRR');
V_CUSTODYCD := UPPER(REPLACE(PV_CUSTODYCD,'.',''));
V_AFACCTNO  := UPPER(REPLACE(PV_AFACCTNO,'.',''));

/*SELECT ROUND(CI.DFDEBTAMT+TR.NAMT,0) INTO BEGIN_AMT FROM CIMAST CI,
    (
    SELECT TR.ACCTNO, ROUND(SUM(CASE WHEN TR.TXTYPE = 'C' THEN -TR.NAMT ELSE TR.NAMT END),0) NAMT
    FROM VW_CITRAN_GEN TR, CFMAST CF
    -WHERE TR.FIELD LIKE 'DFDEBTAMT'
        AND TR.ACCTNO = V_AFACCTNO
        AND CF.CUSTODYCD = TR.CUSTODYCD
        AND TR.TXTYPE IN ('C','D')
        AND TR.TXDATE >= V_FROMDATE
    GROUP BY TR.ACCTNO
    )TR
WHERE CI.ACCTNO = TR.ACCTNO(+)
    AND CI.ACCTNO = V_AFACCTNO;

OPEN PV_REFCURSOR FOR

SELECT TR.ACCTNO,TR.CUSTODYCD, TR.TXNUM, TR.TXDATE, TR.TLTXCD,
    BEGIN_AMT NAMT_BEGIN, TR.TXTYPE, TR.TXDESC, CF.FULLNAME, CF.ADDRESS,
    (CASE WHEN TR.TXTYPE = 'C' THEN TR.NAMT ELSE 0 END) NAMT_C,
    (CASE WHEN TR.TXTYPE = 'D' THEN TR.NAMT ELSE 0 END) NAMT_D
FROM VW_CITRAN_GEN TR, CFMAST CF, AFMAST AF
WHERE TR.FIELD LIKE 'DFDEBTAMT'
    AND AF.ACCTNO = V_AFACCTNO
    AND TR.TXDATE BETWEEN V_FROMDATE AND V_TODATE
    AND AF.CUSTID = CF.CUSTID
    AND CF.CUSTODYCD = TR.CUSTODYCD(+)
    AND TR.TXTYPE IN ('C','D')
ORDER BY TR.TXDATE, TR.TXNUM
;*/


SELECT ROUND(CI.DFDEBTAMT+TR.NAMT,0) INTO BEGIN_AMT FROM CIMAST CI,
    (
    SELECT TR.ACCTNO, ROUND(SUM(CASE WHEN TR.TXTYPE = 'C' THEN -TR.NAMT ELSE TR.NAMT END),0) NAMT
    FROM VW_CITRAN_GEN TR, CFMAST CF
    WHERE TR.FIELD LIKE 'EMKAMT'
        AND TR.ACCTNO = V_AFACCTNO
        AND CF.CUSTODYCD = TR.CUSTODYCD
        AND TR.TXTYPE IN ('C','D')
        AND TR.TXDATE >= V_FROMDATE
    GROUP BY TR.ACCTNO
    )TR
WHERE CI.ACCTNO = TR.ACCTNO(+)
    AND CI.ACCTNO = V_AFACCTNO;

OPEN PV_REFCURSOR FOR

SELECT TR.ACCTNO,TR.CUSTODYCD, TR.TXNUM, TR.TXDATE, TR.TLTXCD,
    BEGIN_AMT NAMT_BEGIN, TR.TXTYPE, TR.TXDESC, CF.FULLNAME, CF.ADDRESS,
    (CASE WHEN TR.TXTYPE = 'C' THEN TR.NAMT  END) NAMT_C,
    (CASE WHEN TR.TXTYPE = 'D' THEN TR.NAMT END) NAMT_D
FROM VW_CITRAN_GEN TR, CFMAST CF, AFMAST AF
WHERE TR.FIELD LIKE 'EMKAMT'
    AND AF.ACCTNO = V_AFACCTNO
    AND TR.TXDATE BETWEEN V_FROMDATE AND V_TODATE
    AND AF.CUSTID = CF.CUSTID
    AND CF.CUSTODYCD = TR.CUSTODYCD(+)
    AND TR.TXTYPE IN ('C','D')
ORDER BY TR.TXDATE, TR.TXNUM
;

EXCEPTION
  WHEN OTHERS
   THEN
      RETURN;
END;
/

