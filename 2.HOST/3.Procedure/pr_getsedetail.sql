CREATE OR REPLACE PROCEDURE PR_GETSEDETAIL (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
    F_DATE         IN       VARCHAR2,
   T_DATE         IN       VARCHAR2,
   PV_CUSTODYCD   IN       VARCHAR2,
   PV_AFACCTNO    IN       VARCHAR2,
   PV_SYMBOL         IN       VARCHAR2,
   pv_datetype IN VARCHAR2
)
IS

   V_STRCUSTODYCD  VARCHAR2(20);                   -- USED WHEN V_NUMOPTION > 0
   V_STRAFACCTNO   VARCHAR2 (20);
   V_STRSYMBOL     VARCHAR2 (20);
   V_STRFULLNAME  VARCHAR2 (100);
   V_STRADDRESS    VARCHAR2 (500);
   CUR             PKG_REPORT.REF_CURSOR;
   V_FROMDATE DATE;
   V_TODATE DATE;

BEGIN


      V_STRCUSTODYCD :=  PV_CUSTODYCD;
   V_FROMDATE := TO_DATE(F_DATE,'DD/MM/RRRR');
      V_TODATE := TO_DATE(T_DATE,'DD/MM/RRRR');

   -- GET REPORT'S PARAMETERS
  IF (PV_AFACCTNO <> 'ALL')
   THEN
      V_STRAFACCTNO :=  PV_AFACCTNO;
   ELSE
      V_STRAFACCTNO := '%%';
   END IF;

 IF (PV_SYMBOL <> 'ALL')
   THEN
      V_STRSYMBOL := replace(PV_SYMBOL,' ','_');
   ELSE
      V_STRSYMBOL := '%%';
   END IF;

      -- END OF GETTING REPORT'S PARAMETERS


   -- GET REPORT'S DATA`

      OPEN PV_REFCURSOR
       FOR
SELECT   AF.ACCTNO AFACCTNO, BALANCE.TXDATE, BALANCE.BUSDATE, BALANCE.SYMBOL, tltx.tltxcd,
                       TLTX.TXDESC TLTXNAME, BALANCE.DESCRIPTION,  BALANCE.CAMT CREDIT, BALANCE.DAMT DEBIT
          FROM

(
SELECT  SETR.ACCTNO ACCTNO, TO_CHAR(SB.SYMBOL) SYMBOL,TL.BUSDATE BUSDATE,
 TL.TXDATE TXDATE, TL.TXNUM TXNUM, TO_CHAR(TL.TXDESC) DESCRIPTION, TL.TLTXCD,
(CASE WHEN APP.TXTYPE ='C' THEN SETR.NAMT ELSE 0 END)CAMT ,
(CASE WHEN APP.TXTYPE ='D' THEN SETR.NAMT ELSE 0 END)DAMT, '' orderid

 FROM
 (
    SELECT * FROM TLLOG
    WHERE  CASE WHEN pv_datetype =  'ALL' AND ((BUSDATE between v_FromDate and v_ToDate ) OR (TXDATE between v_FromDate and v_ToDate ) ) THEN 1
                          WHEN pv_datetype = 'txdate' AND  (TXDATE between v_FromDate and v_ToDate ) THEN 1
                           WHEN pv_datetype = 'busdate' AND  (BUSDATE between v_FromDate and v_ToDate ) THEN 1
                             ELSE 0 END  = 1
      AND TLTXCD IN
   ( SELECT  TLTXCD  FROM TLTX  WHERE  SUBSTR(TLTXCD,1,2) <> '88'
             and tltxcd not in ('2297','2298','2250','2252', '3384', '3382', '3383', '3386', '3353', '2202', '2203', '2232', '2251', '2233', '2253','3324') or  TLTXCD  IN('8878' ,'8879','2248'))

 ) TL, APPTX APP,SETRAN SETR, SBSECURITIES SB
WHERE
     TL.TXNUM = SETR.TXNUM
     AND TL.TXDATE =SETR.TXDATE
     AND SETR.TXCD = APP.TXCD
     AND SB.CODEID=SUBSTR (SETR.ACCTNO, 11, 6)
     AND APP.APPTYPE = 'SE'
     AND APP.TXTYPE IN ('C', 'D')
     AND TRIM (APP.FIELD) IN('TRADE','SECURED','MORTAGE')
     AND  SUBSTR(SETR.ACCTNO,1,10) LIKE V_STRAFACCTNO
     AND  SETR.NAMT<>0
     AND TL.DELTD<>'Y'
UNION ALL

 SELECT  SETR.ACCTNO ACCTNO, TO_CHAR(SB.SYMBOL) SYMBOL,TL.BUSDATE BUSDATE,
 TL.TXDATE TXDATE, TL.TXNUM TXNUM, TO_CHAR(TL.TXDESC) DESCRIPTION, TL.TLTXCD,
(CASE WHEN APP.TXTYPE ='C' THEN SETR.NAMT ELSE 0 END)CAMT ,
(CASE WHEN APP.TXTYPE ='D' THEN SETR.NAMT ELSE 0 END)DAMT, '' ORDERID

 FROM
 (
    SELECT * FROM TLLOGALL
    WHERE CASE WHEN PV_datetype =  'ALL' AND ((BUSDATE between v_FromDate and v_ToDate ) OR (TXDATE between v_FromDate and v_ToDate ) ) THEN 1
                          WHEN PV_DATETYPE = 'txdate' AND  (TXDATE between v_FromDate and v_ToDate ) THEN 1
                           WHEN PV_DATETYPE = 'busdate' AND  (BUSDATE between v_FromDate and v_ToDate ) THEN 1
                             ELSE 0 END  = 1
    AND TLTXCD IN
       ( SELECT  TLTXCD FROM TLTX  WHERE  SUBSTR(TLTXCD,1,2) <> '88'
                 and tltxcd not in ('2297','2298','2250','2252' , '3384', '3382', '3383', '3386', '3353', '2202', '2203', '2232', '2251', '2233', '2253','3324') or  TLTXCD  IN('8878' ,'8879','2248'))
 ) TL, APPTX APP,SETRANA SETR, SBSECURITIES SB
 WHERE   TL.TXNUM = SETR.TXNUM
         AND TL.TXDATE =SETR.TXDATE
         AND SETR.TXCD = APP.TXCD
         AND SB.CODEID=SUBSTR (SETR.ACCTNO, 11, 6)
         AND APP.APPTYPE = 'SE'
         AND APP.TXTYPE IN ('C', 'D')
         AND TRIM (APP.FIELD) IN('TRADE','SECURED','MORTAGE')
         AND  SUBSTR(SETR.ACCTNO,1,10) LIKE V_STRAFACCTNO
         AND  SETR.NAMT<>0
         AND TL.DELTD<>'Y'
  UNION ALL
-------NHUNG GIAO DICH LENH
  SELECT  MAX(SETR.ACCTNO) ACCTNO,TO_CHAR( MAX(SB.SYMBOL)) SYMBOL,  MAX(TL.BUSDATE) BUSDATE
  , MAX(TL.TXDATE) TXDATE, MAX(TL.TXNUM) TXNUM, TO_CHAR(MAX(TL.TXDESC)) DESCRIPTION, MAX(TL.TLTXCD) TLTXCD,
 sum(CASE WHEN APP.TXTYPE ='C' THEN SETR.NAMT ELSE 0 END)CAMT ,
 sum(CASE WHEN APP.TXTYPE ='D' THEN SETR.NAMT ELSE 0 END)DAMT, SETR.ref ORDERID

 FROM
 ( SELECT * FROM TLLOG
    WHERE CASE WHEN PV_datetype =  'ALL' AND ((BUSDATE between v_FromDate and v_ToDate ) OR (TXDATE between v_FromDate and v_ToDate ) ) THEN 1
                          WHEN PV_DATETYPE = 'txdate' AND  (TXDATE between v_FromDate and v_ToDate ) THEN 1
                           WHEN PV_DATETYPE = 'busdate' AND  (BUSDATE between v_FromDate and v_ToDate ) THEN 1
                             ELSE 0 END  = 1
    AND TLTXCD  IN( '8824' ,'8823', '8868', '8867','2248','8817')
 ) TL, APPTX APP,SETRAN SETR, SBSECURITIES SB
 WHERE   TL.TXNUM = SETR.TXNUM
     AND TL.TXDATE =SETR.TXDATE
     AND SETR.TXCD = APP.TXCD
     AND SB.CODEID=SUBSTR (SETR.ACCTNO, 11, 6)
     AND APP.APPTYPE = 'SE'
     AND APP.TXTYPE IN ('C', 'D')
     AND TRIM (APP.FIELD) IN('TRADE','SECURED','MORTAGE')
     AND  SUBSTR(SETR.ACCTNO,1,10) LIKE V_STRAFACCTNO
     AND  SETR.NAMT<>0
     AND TL.DELTD<>'Y'
  GROUP BY SETR.ref,APP.TXTYPE

UNION ALL

SELECT  MAX(SETR.ACCTNO) ACCTNO,TO_CHAR( MAX(SB.SYMBOL)) SYMBOL,  MAX(TL.BUSDATE) BUSDATE
  , MAX(TL.TXDATE) TXDATE, MAX(TL.TXNUM) TXNUM, TO_CHAR(MAX(TL.TXDESC)) DESCRIPTION, MAX(TL.TLTXCD) TLTXCD,
  sum(CASE WHEN APP.TXTYPE ='C' THEN SETR.NAMT ELSE 0 END)CAMT ,
  sum(CASE WHEN APP.TXTYPE ='D' THEN SETR.NAMT ELSE 0 END)DAMT, SETR.ref ORDERID

FROM
(
    SELECT * FROM TLLOGALL
    WHERE  CASE WHEN PV_datetype =  'ALL' AND ((BUSDATE between v_FromDate and v_ToDate ) OR (TXDATE between v_FromDate and v_ToDate ) ) THEN 1
                          WHEN PV_DATETYPE = 'txdate' AND  (TXDATE between v_FromDate and v_ToDate ) THEN 1
                           WHEN PV_DATETYPE = 'busdate' AND  (BUSDATE between v_FromDate and v_ToDate ) THEN 1
                             ELSE 0 END  = 1
    AND TLTXCD  IN( '8824' ,'8823', '8868', '8867','2248','8817')
) TL, APPTX APP,SETRANA SETR,SBSECURITIES SB
  WHERE   TL.TXNUM = SETR.TXNUM
     AND TL.TXDATE =SETR.TXDATE
     AND SETR.TXCD = APP.TXCD
     AND SB.CODEID=SUBSTR (SETR.ACCTNO, 11, 6)
     AND APP.APPTYPE = 'SE'
     AND APP.TXTYPE IN ('C', 'D')
     AND TRIM (APP.FIELD) IN('TRADE','SECURED','MORTAGE')
     AND  SUBSTR(SETR.ACCTNO,1,10) LIKE V_STRAFACCTNO
     AND  SETR.NAMT<>0
     AND TL.DELTD<>'Y'
      GROUP BY SETR.ref,APP.TXTYPE
                         )
              BALANCE,cfmast CF,AFMAST AF, TLTX
    WHERE  AF.ACCTNO=substr(BALANCE.ACCTNO,1,10)
          AND CF.custid=AF.custid
          AND CF.CUSTODYCD=V_STRCUSTODYCD
          AND BALANCE.TLTXCD = TLTX.TLTXCD
          AND balance.symbol LIKE V_STRSYMBOL

           ORDER BY BALANCE.BUSDATE,BALANCE.TXNUM;


EXCEPTION
   WHEN OTHERS
   THEN
      RETURN;
END;                                                              -- PROCEDURE
/

