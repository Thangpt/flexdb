CREATE OR REPLACE PROCEDURE mr3005 (
   PV_REFCURSOR             IN OUT   PKG_REPORT.REF_CURSOR,
   OPT                      IN       VARCHAR2,
   BRID                     IN       VARCHAR2,
   PV_CUSTODYCD             IN       VARCHAR2,
   PV_AFACCTNO              IN       VARCHAR2
   )
IS
-- MODIFICATION HISTORY
-- BAO CAO TONG HOP MARGIN CALL THEO NGAY
-- PERSON   DATE  COMMENTS
-- THENN    16-MAR-2012  CREATED
-- ---------   ------  -------------------------------------------
   V_STROPTION         VARCHAR2 (5);            -- A: ALL; B: BRANCH; S: SUB-BRANCH
   V_STRBRID           VARCHAR2 (4);            -- USED WHEN V_NUMOPTION > 0

   V_CUSTODYCD         VARCHAR2(100);
   V_AFACCTNO          VARCHAR2(100);
   V_CURRDATE          VARCHAR2(100);

BEGIN

    V_STROPTION := OPT;

    IF (V_STROPTION <> 'A') AND (BRID <> 'ALL')
    THEN
         V_STRBRID := BRID;
    ELSE
         V_STRBRID := '%%';
    END IF;

-- GET REPORT'S PARAMETERS

    IF (PV_CUSTODYCD <> 'ALL' OR PV_CUSTODYCD <> '')
    THEN
         V_CUSTODYCD := PV_CUSTODYCD;
    ELSE
         V_CUSTODYCD := '%%';
    END IF;

    IF (PV_AFACCTNO <> 'ALL' OR PV_AFACCTNO <> '')
    THEN
         V_AFACCTNO := PV_AFACCTNO;
    ELSE
         V_AFACCTNO := '%%';
    END IF;

    SELECT TO_CHAR(getcurrdate,'DD/MM/YYYY') INTO V_CURRDATE FROM DUAL;

    OPEN PV_REFCURSOR
    FOR
        SELECT * FROM
        (
            SELECT V_CURRDATE CURRDATE, CF.CUSTODYCD, AF.ACCTNO AFACCTNO, CF.FULLNAME,
                TO_CHAR(LN.RLSDATE,'DD/MM/YYYY') RLSDATE, V.TADF SECAMOUNT, V.DDF LOANAMT, V.RTTDF CURRLNRATE,
                DF.MRATE LNRATE, ROUND(V.ODSELLDF) ADDAMOUNT, 'DF' LOANTYPE
            FROM DFGROUP DF, LNMAST LN, AFMAST AF, CFMAST CF,
                V_GETGRPDEALFORMULAR V
            WHERE DF.LNACCTNO= LN.ACCTNO AND DF.AFACCTNO= AF.ACCTNO AND AF.CUSTID= CF.CUSTID
                AND DF.GROUPID=V.GROUPID(+)
                AND V.ODDF>0 AND V.RTTDF <= DF.MRATE
                AND AF.ACCTNO = V_AFACCTNO
            UNION ALL
            SELECT V_CURRDATE CURRDATE, MR.CUSTODYCD, MR.ACCTNO AFACCTNO, CF.FULLNAME, '' RLSDATE,
                ROUND(DECODE(AF.IST2,'Y',LEAST(MR.SEMAXCALLASS, MR.MRCRLIMITMAX), LEAST(MR.SETOTALCALLASS, MR.MRCRLIMITMAX))) SECAMOUNT,
                ROUND(DECODE(AF.IST2,'Y',CASE WHEN MR.OUTSTANDINGT2 > 0 THEN 0 ELSE ABS(MR.OUTSTANDINGT2) END,MR.TOTALODAMT)) LOANAMT,
                DECODE(AF.IST2,'Y',MR.RLSMARGINRATE,MR.MARGINRATE) CURRLNRATE,
                MR.MRMRATE LNRATE, ROUND(DECODE(AF.IST2,'Y',MR.RTNAMTT2,MR.RTNAMT)) ADDAMOUNT, 'MR' LOANTYPE
            FROM VW_MR0003 MR, CFMAST CF,
                (SELECT AF.ACCTNO, CASE WHEN AF.TRFBUYEXT * AF.TRFBUYRATE > 0 THEN 'Y' ELSE 'N' END IST2 FROM AFMAST AF) AF
            WHERE MR.CUSTODYCD = CF.CUSTODYCD AND MR.ACCTNO = AF.ACCTNO
                AND MR.ACCTNO = V_AFACCTNO
        ) A
        ORDER BY A.LOANTYPE DESC, A.RLSDATE
    ;
EXCEPTION
   WHEN OTHERS
   THEN
      RETURN;
END;
/

