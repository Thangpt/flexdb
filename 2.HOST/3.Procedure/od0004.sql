CREATE OR REPLACE PROCEDURE od0004 (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   CUSTID         IN       VARCHAR2
)
IS
--
-- PURPOSE: BRIEFLY EXPLAIN THE FUNCTIONALITY OF THE PROCEDURE
--
-- MODIFICATION HISTORY
-- PERSON      DATE    COMMENTS
-- NAMNT   21-NOV-06  CREATED
-- ---------   ------  -------------------------------------------
   V_STROPTION        VARCHAR2 (5);       -- A: ALL; B: BRANCH; S: SUB-BRANCH
   V_STRBRID          VARCHAR2 (4);              -- USED WHEN V_NUMOPTION > 0
   V_GROUP            VARCHAR2(10);
   V_STRCUSTID         VARCHAR2(20);
-- DECLARE PROGRAM VARIABLES AS SHOWN ABOVE

BEGIN

   V_STROPTION := OPT;

   IF (V_STROPTION <> 'A') AND (BRID <> 'ALL')
   THEN
      V_STRBRID := BRID;
   ELSE
      V_STRBRID := '%%';
   END IF;

   -- GET REPORT'S PARAMETERS
   
    IF  (CUSTID <> 'ALL')
   THEN
      V_STRCUSTID := CUSTID;
   ELSE
      V_STRCUSTID := '%%';
   END IF;
   
   -- END OF GETTING REPORT'S PARAMETERS

   -- GET REPORT'S DATA
   IF (V_STROPTION <> 'A') AND (BRID <> 'ALL')
   THEN
      OPEN PV_REFCURSOR
       FOR
        SELECT  FULLNAME, CUSTID, ORDERID, PRICETYPE, SYMBOL, ORDERQTTY,
                AVAIQTTY, EXPDATE
        FROM (SELECT V_GROUP CURRDATE, CF.FULLNAME FULLNAME, CF.CUSTID CUSTID, OD.ORDERID ORDERID,
                     AL.CDCONTENT PRICETYPE, SB.SYMBOL SYMBOL, OD.ORDERQTTY ORDERQTTY ,
                     (OD.ORDERQTTY - OD.EXECQTTY) AVAIQTTY, OD.EXPDATE EXPDATE,
                     OD.EXECQTTY EXECQTTY, CF.BRID BRID
          FROM ODMAST OD, CFMAST CF, SBSECURITIES SB, ALLCODE AL
          WHERE OD.CUSTID = CF.CUSTID
                AND SB.CODEID = OD.CODEID
                AND OD.ORDERQTTY - OD.EXECQTTY > 0
                AND AL.CDVAL = OD.PRICETYPE
                AND AL.CDNAME ='PRICETYPE'
                AND AL.CDTYPE = 'OD'
                AND OD.ORSTATUS NOT IN ('5','6','7')) V
        WHERE SUBSTR(V.CUSTID,1,4 ) LIKE V_STRBRID
        AND V.custid  LIKE V_STRCUSTID
        ORDER BY V.FULLNAME;
   ELSE
      OPEN PV_REFCURSOR
       FOR
         SELECT  FULLNAME, CUSTID, ORDERID, PRICETYPE, SYMBOL, ORDERQTTY,
                AVAIQTTY, EXPDATE
        FROM (SELECT V_GROUP CURRDATE, CF.FULLNAME FULLNAME, CF.CUSTID CUSTID, OD.ORDERID ORDERID,
                     AL.CDCONTENT PRICETYPE, SB.SYMBOL SYMBOL, OD.ORDERQTTY ORDERQTTY ,
                     (OD.ORDERQTTY - OD.EXECQTTY) AVAIQTTY, OD.EXPDATE EXPDATE,
                     OD.EXECQTTY EXECQTTY, CF.BRID BRID
          FROM ODMAST OD, CFMAST CF, SBSECURITIES SB, ALLCODE AL
          WHERE OD.CUSTID = CF.CUSTID
                AND SB.CODEID = OD.CODEID
                AND OD.ORDERQTTY - OD.EXECQTTY > 0
                AND AL.CDVAL = OD.PRICETYPE
                AND AL.CDNAME ='PRICETYPE'
                AND AL.CDTYPE = 'OD'
                AND OD.ORSTATUS NOT IN ('5','6','7')) V
      WHERE  V.custid  LIKE V_STRCUSTID
                
           ORDER BY V.FULLNAME;
   END IF;
EXCEPTION
   WHEN OTHERS
   THEN
      RETURN;
END;                                                              -- PROCEDURE
/

