CREATE OR REPLACE PROCEDURE SE0066_BK
   (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   F_DATE         IN       VARCHAR2,
   T_DATE         IN       VARCHAR2,
   PV_LIST        IN       VARCHAR2

   )
   IS
   v_LIST VARCHAR2(40);
BEGIN

    IF PV_LIST='ALL' THEN
        v_LIST:='%%';
    ELSE
        v_LIST:=PV_LIST;
    END IF;



     ---ALL
      OPEN PV_REFCURSOR
      FOR
      SELECT MST.OBJNAME, MST.TXDATE, MST.OBJKEY, FN_CRB_GETVOUCHERNO(LG.TRFCODE, LG.TXDATE, LG.VERSION) VOUCHERNO,
      MST.AFACCTNO, MST.BANKCODE, MST.BANKACCT, MST.STATUS, MST.TXAMT, RF.*
      FROM CRBTXREQ MST, CRBTRFLOG LG, CRBTRFLOGDTL LGDTL,
      (SELECT *
      FROM   (SELECT DTL.REQID, DTL.FLDNAME, NVL(DTL.CVAL,DTL.NVAL) REFVAL
              FROM   CRBTXREQ MST, CRBTXREQDTL DTL WHERE MST.REQID=DTL.REQID AND MST.TRFCODE = 'SEODDLOT')
      PIVOT  (MAX(REFVAL) AS R FOR (FLDNAME) IN
      ('QTTY' as QTTY, 'LICENSE' as LICENSE, 'IDDATE' as IDDATE,
      'CUSTNAME' as CUSTNAME, 'CUSTODYCD' as CUSTODYCD, 'BOARD' as BOARD, 'SYMBOL' as SYMBOL))
      ORDER BY REQID) RF
      WHERE MST.REQID=RF.REQID
      AND LG.AUTOID = LGDTL.VERSION
      AND LGDTL.REFREQID = MST.REQID
      AND  MST.TXDATE <= TO_DATE (T_DATE ,'DD/MM/YYYY') AND MST.TXDATE >= TO_DATE (F_DATE ,'DD/MM/YYYY')
      AND LG.TRFCODE = 'SEODDLOT';


EXCEPTION
    WHEN OTHERS THEN
        RETURN ;
END; -- Procedure
/

