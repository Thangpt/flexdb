CREATE OR REPLACE PROCEDURE GETCUSTOMERPOSITION(PV_REFCURSOR IN OUT PKG_REPORT.REF_CURSOR, CUSTODYCD IN VARCHAR2)
  IS
  V_PARAFILTER VARCHAR2(10);
BEGIN
    V_PARAFILTER:=CUSTODYCD;
    OPEN PV_REFCURSOR FOR
         SELECT ITEM, MST.ACCTNO SUBACCTNO, MAX(TYPENAME) SUBACNAME, SUM(VAL) VAL
         FROM  (SELECT CF.CUSTODYCD, AF.ACCTNO, TO_CHAR('PURCHASINGPOWER') ITEM,
               DTL.CASH_ON_HAND-DTL.ORDERAMT - DTL.OUTSTANDING + DTL.ADVANCEDLINE +
               DTL.CASH_RECEIVING_T1+DTL.CASH_RECEIVING_T2 + DTL.CASH_RECEIVING_T3 -
               ((CASE WHEN DTL.ADVT1>0 THEN (CASE WHEN DTL.ADVT1>DTL.ADVMIN THEN DTL.ADVT1 ELSE DTL.ADVMIN END) ELSE 0 END)+
               (CASE WHEN DTL.ADVT2>0 THEN (CASE WHEN DTL.ADVT2>DTL.ADVMIN THEN DTL.ADVT2 ELSE DTL.ADVMIN END) ELSE 0 END) +
               (CASE WHEN DTL.ADVT3>0 THEN (CASE WHEN DTL.ADVT3>DTL.ADVMIN THEN DTL.ADVT3 ELSE DTL.ADVMIN END) ELSE 0 END)) VAL, TYP.TYPENAME
         FROM VW_BD_SUBACCOUNT_CI DTL, AFMAST AF, CFMAST CF, AFTYPE TYP
         WHERE DTL.AFACCTNO=AF.ACCTNO AND AF.CUSTID=CF.CUSTID AND TYP.ACTYPE=AF.ACTYPE AND CF.CUSTODYCD=V_PARAFILTER
         UNION ALL SELECT CF.CUSTODYCD, AF.ACCTNO, TO_CHAR(SB.SYMBOL) ITEM, DTL.TRADE VAL, TYP.TYPENAME
         FROM SEMAST DTL, AFMAST AF, CFMAST CF, AFTYPE TYP, SBSECURITIES SB
         WHERE DTL.AFACCTNO=AF.ACCTNO AND AF.CUSTID=CF.CUSTID AND TYP.ACTYPE=AF.ACTYPE AND SB.CODEID=DTL.CODEID AND CF.CUSTODYCD=V_PARAFILTER) MST
         GROUP BY ROLLUP(ITEM, MST.ACCTNO) HAVING SUM(VAL)<>0;
EXCEPTION
    WHEN others THEN
        return;
END;
/

