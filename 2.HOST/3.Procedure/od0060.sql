CREATE OR REPLACE PROCEDURE od0060 (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   F_DATE         IN       VARCHAR2,
   T_DATE         IN       VARCHAR2,
   CUSTODYCD      IN       VARCHAR2,
   CIACCTNO       IN       VARCHAR2,
   SYMBOL         IN       VARCHAR2,
   EXECTYPE       IN       VARCHAR2,
   VIA            IN       VARCHAR2,
   TLID           IN       VARCHAR2
   )
IS
--
-- PURPOSE: BRIEFLY EXPLAIN THE FUNCTIONALITY OF THE PROCEDURE
-- TONG HOP KET QUA KHOP LENH
-- MODIFICATION HISTORY
-- PERSON      DATE     COMMENTS
-- HUNG.LB    24-AUG-10  UPDATED
-- ---------   ------   -------------------------------------------
   V_STROPTION          VARCHAR2 (5);            -- A: ALL; B: BRANCH; S: SUB-BRANCH
   V_STRBRID            VARCHAR2 (4);               -- USED WHEN V_NUMOPTION > 0

   V_STREXECTYPE        VARCHAR2 (5);
   V_STRSYMBOL          VARCHAR2 (10);
   V_STRVIA             VARCHAR2 (10);
   V_STRCIACCTNO        VARCHAR2 (20);
   V_STRCUSTODYCD       VARCHAR2 (20);
   V_TLID               VARCHAR2(4);

   V_FROM_DATE          DATE;
   V_TO_DATE            DATE;

-- DECLARE PROGRAM VARIABLES AS SHOWN ABOVE
BEGIN
   V_STROPTION := OPT;
   V_TLID := TLID;
   IF (V_STROPTION <> 'A') AND (BRID <> 'ALL')
   THEN
      V_STRBRID := BRID;
   ELSE
      V_STRBRID := '%%';
   END IF;

    -- GET REPORT'S PARAMETERS
   V_FROM_DATE := TO_DATE(F_DATE,'DD/MM/YYYY');
   V_TO_DATE := TO_DATE(T_DATE,'DD/MM/YYYY');

   IF (CUSTODYCD <> 'ALL')
   THEN
      V_STRCUSTODYCD := CUSTODYCD;
   ELSE
      V_STRCUSTODYCD := '%%';
   END IF;

   IF (CIACCTNO <> 'ALL')
   THEN
      V_STRCIACCTNO := CIACCTNO;
   ELSE
      V_STRCIACCTNO := '%%';
   END IF;

   --
    IF (SYMBOL <> 'ALL')
   THEN
      V_STRSYMBOL := SYMBOL;
   ELSE
      V_STRSYMBOL := '%%';
   END IF;
   --
   IF (EXECTYPE <> 'ALL')
   THEN
      V_STREXECTYPE := EXECTYPE;
   ELSE
      V_STREXECTYPE := '%%';
   END IF;

   IF (VIA <> 'ALL')
   THEN
      V_STRVIA := VIA;
   ELSE
      V_STRVIA := '%%';
   END IF;


-- GET REPORT'S DATA

OPEN PV_REFCURSOR
FOR
SELECT OD.*, NVL(IO.MATCHQTTY,0) MATCHQTTY, NVL(IO.MATCHPRICE,0) MATCHPRICE,
    NVL(IO.TXTIME,0) MATCHTXTIME
FROM
(
    SELECT E.ORGACCTNO ORDERID, A1.CDCONTENT VIA, A2.CDCONTENT EXECTYPE, SB.SYMBOL,
        E.QUANTITY, (E.QUOTEPRICE*1000) QUOTEPRICE, TO_CHAR(E.LAST_CHANGE, 'HH24:MI:SS') TXTIME,
        CF.CUSTODYCD, AF.ACCTNO, NVL(F.TLNAME, 'ONLINE') TLNAME,
        TO_DATE(SUBSTR(E.CREATEDDT,1,10), 'DD/MM/YYYY') TXDATE
    FROM (SELECT * FROM FOMAST UNION ALL SELECT * FROM FOMASTHIST) E, TLPROFILES F,
          SBSECURITIES SB, AFMAST AF, CFMAST CF, ALLCODE A1, ALLCODE A2
    WHERE E.USERNAME = F.TLID(+)
        AND LENGTH(ORGACCTNO) = LENGTH('8000080610001415') /*AND E.STATUS ='A'*/
        AND E.CODEID = SB.CODEID
        AND E.AFACCTNO = AF.ACCTNO
        AND AF.CUSTID = CF.CUSTID
        AND E.VIA = A1.CDVAL
        AND A1.CDNAME = 'VIA'
        AND A1.CDTYPE = 'OD'
        AND E.EXECTYPE = A2.CDVAL
        AND A2.CDNAME = 'EXECTYPE'
        AND A2.CDTYPE = 'OD'
        AND E.EXECTYPE NOT IN ('CB','CS','AB','AS')
        AND CF.CUSTODYCD LIKE V_STRCUSTODYCD
        AND EXISTS (SELECT GU.GRPID FROM TLGRPUSERS GU WHERE CF.CAREBY = GU.GRPID AND GU.TLID = V_TLID)   -- CHECK CAREBY
        AND AF.ACCTNO LIKE V_STRCIACCTNO
        AND E.CODEID LIKE V_STRSYMBOL
        AND E.EXECTYPE LIKE V_STREXECTYPE
        AND E.VIA LIKE V_STRVIA
        AND TO_DATE(SUBSTR(E.CREATEDDT,1,10), 'DD/MM/YYYY') BETWEEN V_FROM_DATE AND V_TO_DATE
    UNION
    SELECT OD.ORDERID, A1.CDCONTENT VIA, A2.CDCONTENT EXECTYPE, SB.SYMBOL,
       OD.ORDERQTTY QUANTITY, OD.QUOTEPRICE QUOTEPRICE,
       OD.TXTIME, CF.CUSTODYCD, AF.ACCTNO, NVL(D.TLNAME,'ONLINE') TLNAME, OD.TXDATE
    FROM VW_TLLOG_ALL A, VW_ODMAST_ALL OD, TLPROFILES D,
        SBSECURITIES SB, AFMAST AF, CFMAST CF, ALLCODE A1, ALLCODE A2
    WHERE A.TXNUM = OD.TXNUM
        AND A.TLID <> '0000'
        AND A.TLID = D.TLID(+)
        AND A.TXDATE = OD.TXDATE
        AND OD.VIA <> 'B'
        AND OD.CODEID = SB.CODEID
        AND OD.CIACCTNO = AF.ACCTNO
        AND AF.CUSTID = CF.CUSTID
        AND OD.VIA = A1.CDVAL
        AND A1.CDNAME = 'VIA'
        AND A1.CDTYPE = 'OD'
        AND OD.EXECTYPE = A2.CDVAL
        AND A2.CDNAME = 'EXECTYPE'
        AND A2.CDTYPE = 'OD'
        AND OD.EXECTYPE NOT IN ('CB','CS','AB','AS')
        AND CF.CUSTODYCD LIKE V_STRCUSTODYCD
        AND EXISTS (SELECT GU.GRPID FROM TLGRPUSERS GU WHERE CF.CAREBY = GU.GRPID AND GU.TLID = V_TLID)   -- CHECK CAREBY
        AND AF.ACCTNO LIKE V_STRCIACCTNO
        AND OD.CODEID LIKE V_STRSYMBOL
        AND OD.EXECTYPE LIKE V_STREXECTYPE
        AND OD.VIA LIKE V_STRVIA
        AND OD.TXDATE BETWEEN V_FROM_DATE AND V_TO_DATE
) OD
LEFT JOIN
VW_IOD_ALL IO
ON IO.ORGORDERID = OD.ORDERID
ORDER BY OD.ORDERID, OD.CUSTODYCD, OD.ACCTNO ;

EXCEPTION
   WHEN OTHERS
   THEN
      RETURN;
END;                                                              -- PROCEDURE
/

