CREATE OR REPLACE PROCEDURE sp_process_cifeeschd_common
IS
  v_CURRDATE  DATE;
  v_NEXTDATE  DATE;
  v_BOMDATE  DATE;
  v_EOMDATE  DATE;
  v_TODATE  DATE;
  v_Result    number(20);
BEGIN
  --PROCESS FEE FOR EXCHANGE FEETYPE=EXCBRK
  --****************************************************************************************
  --CALCULATE THE AMOUNT OF FEE FOR EXCHANGE
  UPDATE ODMAST T1
  SET EXCFEEAMT = nvl((
    SELECT DECODE(T2.FORP,'P',FEEAMT/100,FEEAMT)*T1.EXECAMT/(T2.LOTDAY*T2.LOTVAL)
    FROM (SELECT A2.*
    FROM (SELECT T.ORDERID, MIN(T.ODRNUM) RFNUM FROM VW_ODMAST_EXC_FEETERM T GROUP BY T.ORDERID) A1,
    VW_ODMAST_EXC_FEETERM A2 WHERE A1.ORDERID=A2.ORDERID AND A1.RFNUM=A2.ODRNUM) T2
    WHERE T1.ORDERID = T2.ORDERID),0);
  --MAP TO CIFEEDEF.AUTOID
  UPDATE ODMAST T1
  SET EXCFEEREFID = nvl((
    SELECT T2.AUTOID
    FROM (SELECT A2.*
    FROM (SELECT T.ORDERID, MIN(T.ODRNUM) RFNUM FROM VW_ODMAST_EXC_FEETERM T GROUP BY T.ORDERID) A1,
    VW_ODMAST_EXC_FEETERM A2 WHERE A1.ORDERID=A2.ORDERID AND A1.RFNUM=A2.ODRNUM) T2
    WHERE T1.ORDERID = T2.ORDERID),0);


  --PROCESS THE DEPOSITORY FEE
  --****************************************************************************************
  SELECT TO_DATE (varvalue, systemnums.c_date_format) INTO v_CURRDATE
  FROM sysvar WHERE grname = 'SYSTEM' AND varname = 'CURRDATE';
  SELECT TO_DATE (varvalue, systemnums.c_date_format) INTO v_NEXTDATE
  FROM sysvar WHERE grname = 'SYSTEM' AND varname = 'NEXTDATE';

  --CHECK EOM PROCESSING
  --SELECT DECODE(extract(MONTH FROM v_NEXTDATE)-extract(MONTH FROM v_CURRDATE),0,'N','Y') into v_EOM FROM DUAL;
  SELECT ADD_MONTHS(TRUNC(v_CURRDATE, 'MM'), 1) -1 INTO v_EOMDATE FROM DUAL;
  IF v_EOMDATE>=v_NEXTDATE THEN
    --DURING THIS MONTH: CALCULATE THE ACCRUE DEPOSITPORY FEE ONLY (BUSDATE-NEXTDATE)
    BEGIN
           --INCREASE CIDEPOFEEACR IN CIMAST
/*      UPDATE CIMAST T1
      SET CIDEPOFEEACR = CIDEPOFEEACR + nvl((
        SELECT FEEACR
        FROM (
        SELECT A2.AFACCTNO,
          SUM(DECODE(A2.FORP,'P',A2.FEEAMT/100,A2.FEEAMT)*A2.SEBAL*(v_NEXTDATE-nvl (A2.TBALDT,v_CURRDATE))/(A2.LOTDAY*A2.LOTVAL)) FEEACR
        FROM (SELECT T.ACCTNO, MIN(T.ODRNUM) RFNUM FROM VW_SEMAST_VSDDEP_FEETERM T GROUP BY T.ACCTNO) A1,
        VW_SEMAST_VSDDEP_FEETERM A2 WHERE A1.ACCTNO=A2.ACCTNO AND A1.RFNUM=A2.ODRNUM GROUP BY A2.AFACCTNO) T2
        WHERE T1.AFACCTNO = T2.AFACCTNO),0);*/
      for rec in
      (
        SELECT A2.AFACCTNO,a2.ACCTNO,
        round((DECODE(A2.FORP,'P',A2.FEEAMT/100,A2.FEEAMT)*A2.SEBAL*(v_NEXTDATE-nvl (A2.TBALDT,v_CURRDATE))/(A2.LOTDAY*A2.LOTVAL)),4) FEEACR
        FROM (SELECT T.ACCTNO, MIN(T.ODRNUM) RFNUM FROM VW_SEMAST_VSDDEP_FEETERM T GROUP BY T.ACCTNO) A1,
        VW_SEMAST_VSDDEP_FEETERM A2 WHERE A1.ACCTNO=A2.ACCTNO AND A1.RFNUM=A2.ODRNUM
      )
      loop
        UPDATE CIMAST T1
            SET CIDEPOFEEACR = CIDEPOFEEACR + nvl(REC.FEEACR,0)
        where acctno = rec.afacctno;
         --LOG INTO SEDEPOBAL
      INSERT INTO SEDEPOBAL (AUTOID, ACCTNO, TXDATE, DAYS, QTTY, DELTD,AMT)
      SELECT SEQ_SEDEPOBAL.NEXTVAL, SE.ACCTNO, nvl (SE.TBALDT,v_CURRDATE), v_NEXTDATE-nvl (SE.TBALDT,v_CURRDATE),
        (se.trade + se.margin + se.mortage + se.blocked + se.secured + se.repo + se.netting + se.dtoclose + se.withdraw), 'N',
        nvl(REC.FEEACR,0)
      FROM SEMAST SE WHERE  acctno=rec.ACCTNO AND nvl (SE.TBALDT,v_CURRDATE) <v_NEXTDATE;

      end loop;
      --MARK TO SEMAST
      UPDATE SEMAST SET TBALDT=v_NEXTDATE;
    END;
  ELSE
    --NEED PROCESS END OF MONTH: CALCULATE THE ACCRUE DEPOSITPORY FEE & CREATE THE MATURITY DEPOSITORY FEE
    BEGIN
      --1.1: TINH CONG DON DEN NGAY CUOI THANG
          --INCREASE CIDEPOFEEACR IN CIMAST
/*      UPDATE CIMAST T1
      SET CIDEPOFEEACR = CIDEPOFEEACR + nvl((
        SELECT FEEACR
        FROM (
        SELECT A2.AFACCTNO,
          SUM(DECODE(A2.FORP,'P',A2.FEEAMT/100,A2.FEEAMT)*A2.SEBAL*(v_EOMDATE-nvl(A2.TBALDT,v_CURRDATE)+1)/(A2.LOTDAY*A2.LOTVAL)) FEEACR
        FROM (SELECT T.ACCTNO, MIN(T.ODRNUM) RFNUM FROM VW_SEMAST_VSDDEP_FEETERM T GROUP BY T.ACCTNO) A1,
        VW_SEMAST_VSDDEP_FEETERM A2 WHERE A1.ACCTNO=A2.ACCTNO AND A1.RFNUM=A2.ODRNUM GROUP BY A2.AFACCTNO) T2
        WHERE T1.AFACCTNO = T2.AFACCTNO),0);*/
      for rec in
      (
        SELECT A2.AFACCTNO,a2.ACCTNO,
          round(DECODE(A2.FORP,'P',A2.FEEAMT/100,A2.FEEAMT)*A2.SEBAL*(v_EOMDATE-nvl(A2.TBALDT,v_CURRDATE)+1)/(A2.LOTDAY*A2.LOTVAL),4) FEEACR
        FROM (SELECT T.ACCTNO, MIN(T.ODRNUM) RFNUM FROM VW_SEMAST_VSDDEP_FEETERM T GROUP BY T.ACCTNO) A1,
        VW_SEMAST_VSDDEP_FEETERM A2 WHERE A1.ACCTNO=A2.ACCTNO AND A1.RFNUM=A2.ODRNUM
      )
      loop
        UPDATE CIMAST T1
            SET CIDEPOFEEACR = CIDEPOFEEACR + nvl(REC.FEEACR,0)
        where acctno = rec.afacctno;
         --LOG INTO SEDEPOBAL: UPTO END OF MONTH
      INSERT INTO SEDEPOBAL (AUTOID, ACCTNO, TXDATE, DAYS, QTTY, DELTD,amt)
      SELECT SEQ_SEDEPOBAL.NEXTVAL, SE.ACCTNO, SE.TBALDT, v_EOMDATE- nvl (SE.TBALDT,v_CURRDATE)+1,
        (se.trade + se.margin + se.mortage + se.blocked + se.secured + se.repo + se.netting + se.dtoclose + se.withdraw), 'N',
         nvl(REC.FEEACR,0)
      FROM SEMAST SE WHERE acctno=rec.acctno AND  nvl(SE.TBALDT,v_CURRDATE)<=v_EOMDATE;

      end loop;
      --MARK TO SEMAST
      UPDATE SEMAST SET TBALDT=v_EOMDATE+1;

      --1.2: CHUYEN PHI LUU KY DEN HAN
      SELECT TRUNC(v_CURRDATE, 'MM') INTO v_BOMDATE FROM DUAL;
      INSERT INTO CIFEESCHD (AUTOID, AFACCTNO, FEETYPE, TXDATE, TXNUM, NMLAMT, PAIDAMT, FLOATAMT, FRDATE, TODATE, REFACCTNO, DELTD)
      SELECT SEQ_CIFEESCHD.NEXTVAL, AFACCTNO, 'VSDDEP', v_EOMDATE, 'VSDDEP_DUE', round(CIDEPOFEEACR), 0, 0, v_BOMDATE, v_EOMDATE, NULL, 'N'
      FROM CIMAST WHERE CIDEPOFEEACR>0 AND nvl(DEPOLASTDT,v_CURRDATE)<v_EOMDATE;
/*      UPDATE CIMAST SET DEPOFEEAMT=DEPOFEEAMT+round(CIDEPOFEEACR), CIDEPOFEEACR=0, DEPOLASTDT=v_EOMDATE WHERE CIDEPOFEEACR>0 AND nvl(DEPOLASTDT,v_CURRDATE)<v_EOMDATE;*/
        UPDATE CIMAST SET DEPOFEEAMT=DEPOFEEAMT+round(CIDEPOFEEACR), CIDEPOFEEACR=0, DEPOLASTDT=v_EOMDATE ;

      --1.3: TINH CONG DON TU DAU THANG DEN NGAY HIEN TAI
        --INCREASE CIDEPOFEEACR IN CIMAST
/*      UPDATE CIMAST T1
      SET CIDEPOFEEACR = CIDEPOFEEACR + nvl((
        SELECT FEEACR
        FROM (
        SELECT A2.AFACCTNO,
          SUM(DECODE(A2.FORP,'P',A2.FEEAMT/100,A2.FEEAMT)*A2.SEBAL*(v_NEXTDATE-nvl (A2.TBALDT,v_CURRDATE))/(A2.LOTDAY*A2.LOTVAL)) FEEACR
        FROM (SELECT T.ACCTNO, MIN(T.ODRNUM) RFNUM FROM VW_SEMAST_VSDDEP_FEETERM T GROUP BY T.ACCTNO) A1,
        VW_SEMAST_VSDDEP_FEETERM A2 WHERE A1.ACCTNO=A2.ACCTNO AND A1.RFNUM=A2.ODRNUM GROUP BY A2.AFACCTNO) T2
        WHERE T1.AFACCTNO = T2.AFACCTNO),0);*/
      for rec in
      (
        SELECT A2.AFACCTNO,a2.acctno,
                  round(DECODE(A2.FORP,'P',A2.FEEAMT/100,A2.FEEAMT)*A2.SEBAL*(v_NEXTDATE-nvl (A2.TBALDT,v_CURRDATE))/(A2.LOTDAY*A2.LOTVAL),4) FEEACR
                FROM (SELECT T.ACCTNO, MIN(T.ODRNUM) RFNUM FROM VW_SEMAST_VSDDEP_FEETERM T GROUP BY T.ACCTNO) A1,
                VW_SEMAST_VSDDEP_FEETERM A2 WHERE A1.ACCTNO=A2.ACCTNO AND A1.RFNUM=A2.ODRNUM
      )
      loop
        UPDATE CIMAST T1
            SET CIDEPOFEEACR = CIDEPOFEEACR + nvl(REC.FEEACR,0)
        where acctno = rec.afacctno;
         --LOG INTO SEDEPOBAL: UPTO NEXTDATE
      INSERT INTO SEDEPOBAL (AUTOID, ACCTNO, TXDATE, DAYS, QTTY, DELTD,amt)
      SELECT SEQ_SEDEPOBAL.NEXTVAL, SE.ACCTNO, SE.TBALDT, v_NEXTDATE-nvl (SE.TBALDT,v_CURRDATE),
        (se.trade + se.margin + se.mortage + se.blocked + se.secured + se.repo + se.netting + se.dtoclose + se.withdraw), 'N',
         nvl(REC.FEEACR,0)
      FROM SEMAST SE WHERE acctno=rec.acctno AND  nvl (TBALDT,v_currdate)<v_NEXTDATE;

      end loop;
      --MARK TO SEMAST
      UPDATE SEMAST SET TBALDT=v_NEXTDATE;
    END;
  END IF;

  --?A C?C BI?U THAM S? ?N NG?Y HI?U L?C V?O HO?T ?NG (BI?U PH?TUONG T? S? H?T H?N-FEETYPE/CODEID/EXCHANGE/SECTYPE)
  --?A C?C BI?U THAM S? ?N NG?Y HI?U L?C V?O HO?T ?NG (BI?U PH?TUONG T? S? H?T H?N-FEETYPE/CODEID/EXCHANGE/SECTYPE)
  -- update cac bieu phi co ngay hieu luc la nextdate

  FOR REC IN (
  SELECT * FROM CIFEEDEF WHERE VALDATE= v_NEXTDATE AND STATUS='P'
  )
  LOOP
    UPDATE CIFEEDEF SET STATUS='C' WHERE FEETYPE=REC.FEETYPE  AND ACTYPE=REC.ACTYPE
           AND NVL(CODEID,'A')=NVL(REC.CODEID,'A') AND TRADEPLACE=REC.TRADEPLACE
           AND SECTYPE=REC.SECTYPE AND STATUS='A' ;
    UPDATE CIFEEDEF SET STATUS='A' WHERE AUTOID=REC.AUTOID;


    END LOOP;
  COMMIT;
EXCEPTION
   WHEN OTHERS THEN
        BEGIN
            raise;
            return;
        END;
END;
/

