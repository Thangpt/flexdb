CREATE OR REPLACE PROCEDURE CI9946
 (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   F_DATE         IN       VARCHAR2,
   T_DATE         IN       VARCHAR2,
   PV_CUSTODYCD   IN       VARCHAR2,
   PV_TLID IN VARCHAR2
  )
IS
--

-- BANG KE SO DU PHONG TOA TIEN
-- MODIFICATION HISTORY
-- PERSON       DATE                COMMENTS
-- ---------   ------  -------------------------------------------
-- HUONG.TTD    08-OCT-2010           CREATED


   CUR            PKG_REPORT.REF_CURSOR;
   V_STROPTION    VARCHAR2 (5);            -- A: ALL; B: BRANCH; S: SUB-BRANCH
   V_STRBRID      VARCHAR2 (4);                   -- USED WHEN V_NUMOPTION > 0
   V_FROMDATE DATE;
   V_TODATE DATE;
   V_CURRDATE DATE;
   V_CUSTODYCD VARCHAR2(20);
   V_TLID VARCHAR2(4);


BEGIN

V_TLID := PV_TLID;
V_STROPTION := OPT;
IF V_STROPTION = 'A' THEN
    V_STRBRID := '%';
ELSIF V_STROPTION = 'B' THEN
    V_STRBRID := SUBSTR(BRID,1,2) || '__' ;
ELSE
    V_STRBRID:=BRID;
END IF;

V_FROMDATE  := TO_DATE(F_DATE,'DD/MM/RRRR');
V_TODATE    := TO_DATE(T_DATE,'DD/MM/RRRR');
V_CUSTODYCD := UPPER(REPLACE(PV_CUSTODYCD,'.',''));

if V_CUSTODYCD = 'ALL' or V_CUSTODYCD is null then
    V_CUSTODYCD := '%';
ELSE
    V_CUSTODYCD :=V_CUSTODYCD ;
end if;

OPEN PV_REFCURSOR FOR

-- Bang ke so du phong toa tien (CI9946)

SELECT CF.FULLNAME, CF.CUSTODYCD, A.ACCTNO,
       CI.EMKAMT+ A.NAMT BEGIN_AMT,T.AMT_C,T.AMT_D,
       CI.EMKAMT+ A.NAMT + T.AMT_C - T.AMT_D END_AMT
FROM CFMAST CF, CIMAST CI,
(
---- Phat sinh tu ngay fromdate den ngay hien tai

  SELECT TR.custodycd,TR.ACCTNO, ROUND(SUM(CASE WHEN TR.TXTYPE = 'C' THEN -TR.NAMT ELSE TR.NAMT END),0) NAMT
    FROM VW_CITRAN_GEN TR
    WHERE TR.FIELD = 'EMKAMT'
        AND TR.TXTYPE IN ('C','D')
        AND TR.TXDATE >= V_FROMDATE
   GROUP BY TR.custodycd, TR.ACCTNO
) a,

(
-- Phat sinh tang, giam tu ngay fromdate den todate

  SELECT TR.custodycd,TR.ACCTNO,
         ROUND(SUM(CASE WHEN TR.TXTYPE = 'C' THEN TR.NAMT ELSE 0 END),0) AMT_C,
         ROUND(SUM(CASE WHEN TR.TXTYPE = 'D' THEN TR.NAMT ELSE 0 END),0) AMT_D
    FROM VW_CITRAN_GEN TR
    WHERE TR.FIELD = 'EMKAMT'
        AND TR.TXTYPE IN ('C','D')
        AND TR.TXDATE BETWEEN V_FROMDATE AND V_TODATE
   GROUP BY TR.custodycd, TR.ACCTNO
) T
WHERE CF.CUSTODYCD=A.CUSTODYCD
AND CI.ACCTNO= A.ACCTNO
AND CI.ACCTNO=T.ACCTNO
AND CF.CUSTODYCD LIKE V_CUSTODYCD
;

EXCEPTION
  WHEN OTHERS
   THEN
      RETURN;
END;
/

