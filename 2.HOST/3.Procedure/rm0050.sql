CREATE OR REPLACE PROCEDURE RM0050
   (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   F_DATE         IN       VARCHAR2,
   T_DATE         IN       VARCHAR2,
   PV_BANKCODE    IN       VARCHAR2,
   PV_CUSTODYCD   IN       VARCHAR2

   )
   IS
 /*  v_BANKCODE VARCHAR2(500);
   v_CUSTODYCD VARCHAR2(20);
BEGIN

    IF PV_BANKCODE='0000' THEN
        v_BANKCODE:='BVSC';
       ELSIF PV_BANKCODE='9999' THEN
        v_BANKCODE:='BVB';
    ELSIF PV_BANKCODE='7777' THEN
        v_BANKCODE:='BIDV';
    ELSIF PV_BANKCODE='5555' THEN
        v_BANKCODE:='DAB';
    ELSIF PV_BANKCODE='2222' THEN
        v_BANKCODE:='Vietcombank';
     ELSE
        v_BANKCODE:='%%';
    END IF;*/

     v_BANKCODE VARCHAR2(500);
   v_CUSTODYCD VARCHAR2(20);
   v_CUSTBANK VARCHAR2(20);

BEGIN

    IF PV_BANKCODE='ALL' THEN
        v_BANKCODE:='%%';
     ELSE
        SELECT DECODE(RRTYPE,'B', CUSTBANK, NULL) INTO v_CUSTBANK FROM ADTYPE WHERE ACTYPE= PV_BANKCODE  ;
        SELECT SHORTNAME INTO v_BANKCODE FROM CFMAST WHERE CUSTID=v_CUSTBANK;
    END IF;


    IF PV_CUSTODYCD='ALL' THEN
        v_CUSTODYCD:='%%';
    ELSE
        v_CUSTODYCD:=PV_CUSTODYCD;
    END IF;

     ---GET REPORT DATA:
      OPEN PV_REFCURSOR
      FOR
------Lay 1153:
SELECT * FROM
      (
      SELECT  PV_BANKCODE BCODE_IN, 
     -- TO_DATE(LOG.CVALUE,'DD/MM/YYYY') DUEDATE, 
      SCHD.CLEARDT DUEDATE,
      MST.OBJNAME, MST.TXDATE, MST.OBJKEY, MST.NOTES,FN_CRB_GETVOUCHERNO(LG.TRFCODE, LG.TXDATE, LG.VERSION) VOUCHERNO, SCHD.ADTYPE, AD.ADVRATE,
            MST.AFACCTNO, MST.BANKCODE, MST.BANKACCT, MST.STATUS, MST.TXAMT, CF.CUSTODYCD, CF.FULLNAME, CF.IDCODE LICENSE, LGDTL.AMT, RF.*
            FROM CFMAST CF, AFMAST AF, CRBTXREQ MST, CRBTRFLOG LG, CRBTRFLOGDTL LGDTL, ADTYPE AD, ADSCHD SCHD,
            (SELECT * FROM
              (SELECT * FROM tllogfld
              UNION ALL
              SELECT * FROM tllogfldall)
             ) LOG,
            (SELECT *
      FROM  (SELECT DTL.REQID, DTL.FLDNAME, NVL(DTL.CVAL,DTL.NVAL) REFVAL
             FROM   CRBTXREQ MST, CRBTXREQDTL DTL WHERE MST.REQID=DTL.REQID )
            PIVOT  (MAX(REFVAL) AS R FOR (FLDNAME) IN  ('ORDATE' as ORDATE, 'DAYS' as DAYS, 'ADVAMT' as ADVAMT, 'BNKFEEAMT' as BNKFEEAMT, 'BNKRATE' as BNKRATE, 'CFEEAMT' as CFEEAMT, 'FEEAMT' as FEEAMT))
            ORDER BY REQID) RF
            WHERE CF.CUSTID=AF.CUSTID
            AND AF.ACCTNO=MST.AFACCTNO
            AND MST.REQID=RF.REQID
            AND LG.VERSION = LGDTL.VERSION
            AND LG.TXDATE = LGDTL.TXDATE
            AND LG.TRFCODE = LGDTL.TRFCODE
            AND LGDTL.REFREQID = MST.REQID
            AND LG.TRFCODE = 'TRFADVFRBANK'
            AND LOG.TXNUM = MST.OBJKEY
            AND LOG.TXDATE = MST.TXDATE
            AND SCHD.TXNUM = MST.OBJKEY
            AND SCHD.TXDATE = MST.TXDATE
            AND SCHD.ADTYPE = AD.ACTYPE
            AND LOG.FLDCD = '08'

      UNION ALL

      ------Lay 1178:

      SELECT  PV_BANKCODE BCODE_IN,
        SCHD.CLEARDT DUEDATE,
        MST.OBJNAME, MST.TXDATE, MST.OBJKEY, MST.NOTES,FN_CRB_GETVOUCHERNO(LG.TRFCODE, LG.TXDATE, LG.VERSION) VOUCHERNO,
        SCHD.ADTYPE, ADT.ADVRATE,
        MST.AFACCTNO, MST.BANKCODE, MST.BANKACCT, MST.STATUS, MST.TXAMT, CF.CUSTODYCD, CF.FULLNAME, CF.IDCODE LICENSE, LGDTL.AMT, RF.*

      FROM CFMAST CF, AFMAST AF, CRBTXREQ MST, CRBTRFLOG LG, CRBTRFLOGDTL LGDTL, ADTYPE ADT,
            (
               select * from adschd
               union all
               select * from adschdhist
            ) SCHD,  vw_tllogfld_all LOG,
            (SELECT *
            FROM   (SELECT DTL.REQID, DTL.FLDNAME, NVL(DTL.CVAL,DTL.NVAL) REFVAL
                    FROM   CRBTXREQ MST, CRBTXREQDTL DTL WHERE MST.REQID=DTL.REQID )
            PIVOT  (MAX(REFVAL) AS R FOR (FLDNAME) IN  ('ORDATE' as ORDATE, 'DAYS' as DAYS, 'ADVAMT' as ADVAMT, 'BNKFEEAMT' as BNKFEEAMT, 'BNKRATE' as BNKRATE, 'CFEEAMT' as CFEEAMT, 'FEEAMT' as FEEAMT))
            ORDER BY REQID) RF

            WHERE CF.CUSTID=AF.CUSTID
            AND AF.ACCTNO=MST.AFACCTNO
            AND MST.REQID=RF.REQID
            AND LG.VERSION = LGDTL.VERSION
            AND LG.TXDATE = LGDTL.TXDATE
            AND LG.TRFCODE = LGDTL.TRFCODE
            AND LGDTL.REFREQID = MST.REQID
            AND LG.TRFCODE = 'TRFADVFRBANK'
            AND LOG.TXNUM = MST.OBJKEY
            AND LOG.TXDATE = MST.TXDATE
            AND LOG.FLDCD = '01'
            AND LOG.CVALUE = TO_CHAR(SCHD.AUTOID)
            AND MST.OBJNAME = '1178'
            AND SCHD.ADTYPE = ADT.ACTYPE
       ) AD

      WHERE AD.BANKCODE LIKE v_BANKCODE
      AND  AD.TXDATE <= TO_DATE (T_DATE ,'DD/MM/YYYY') AND AD.TXDATE >= TO_DATE (F_DATE ,'DD/MM/YYYY')
      AND AD.CUSTODYCD LIKE v_CUSTODYCD;


EXCEPTION
    WHEN OTHERS THEN
        RETURN ;
END; -- Procedure
/

