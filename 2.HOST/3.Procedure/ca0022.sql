CREATE OR REPLACE PROCEDURE ca0022 (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   F_DATE         IN       VARCHAR2,
   T_DATE         IN       VARCHAR2,
   POTXNUM         IN       VARCHAR2 -- SO BANG KE
   )
IS
--
-- PURPOSE: B?NG KE QUY?N MUA C? PHI?U
-- PERSON      DATE    COMMENTS
-- QUOCTA   29-11-10   CREATE
-- ---------   ------  -------------------------------------------

    CUR             PKG_REPORT.REF_CURSOR;
    V_STROPTION    VARCHAR2 (5);            -- A: ALL; B: BRANCH; S: SUB-BRANCH
    V_STRBRID      VARCHAR2 (4);
    V_FRDATE       DATE;
    V_TODATE       DATE;
    V_POTXNUM    VARCHAR2 (20);
BEGIN
   V_STROPTION := OPT;

   IF (V_STROPTION <> 'A') AND (BRID <> 'ALL')
   THEN
      V_STRBRID := BRID;
   ELSE
      V_STRBRID := '%';
   END IF;

/*   V_FRDATE    := TO_DATE(F_DATE,'DD/MM/RRRR');
   V_TODATE    := TO_DATE(T_DATE,'DD/MM/RRRR');*/
   -- GET REPORT'S PARAMETERS

   V_POTXNUM := POTXNUM;
   V_POTXNUM := replace(V_POTXNUM, '.', '');

OPEN PV_REFCURSOR
   FOR
   SELECT PO.POTXNUM, PO.POTXDATE, CM.REPORTDATE, CA.CAMASTID, SB.SYMBOL, CM.EXRATE,
    PO.POTXNUM TXNUM, PO.POTXDATE TXDATE, CF.CUSTODYCD, AF.ACCTNO, CF.FULLNAME,
          sum(CA.PBALANCE + CA.BALANCE) REPORTDATE_QTTY,
          ROUND(CASE WHEN
               sum(CA.PBALANCE + CA.BALANCE)<> 0 THEN (sum(CA.BALANCE) / sum(CA.PBALANCE + CA.BALANCE)) *100
               ELSE 100 END, 2) PERCENT_EXECUTE,
          sum(CA.QTTY+CA.PQTTY) TOTAL_QTTY, sum(CA.QTTY) QTTY, sum(CA.NMQTTY) NMQTTY, CM.EXPRICE EXPRICE,
          (sum(CA.NMQTTY)* CM.EXPRICE) AMT, CM.DESCRIPTION
   FROM CFMAST CF, AFMAST AF, CAMAST CM, CASCHD CA, SBSECURITIES SB, ----VW_CITRAN_ALL CITR,
        (SELECT potxdate, potxnum, afacctno, camastid FROM PODETAILS GROUP BY potxdate, potxnum, afacctno, camastid UNION
         SELECT potxdate, potxnum, afacctno, camastid FROM PODETAILSHIST GROUP BY potxdate, potxnum, afacctno, camastid) PO
   WHERE CF.CUSTID = AF.CUSTID AND AF.ACCTNO = CA.AFACCTNO
         AND CA.CAMASTID = CM.CAMASTID AND CM.CATYPE='014'
         AND PO.CAMASTID = CA.CAMASTID AND PO.AFACCTNO = AF.ACCTNO
         AND SB.CODEID = CM.CODEID
----         AND CITR.TLTXCD='3387' AND CITR.TXCD ='0069'
---         AND CITR.TXDATE = PO.POTXDATE
---         AND CITR.ACCTNO = AF.ACCTNO    --AND CITR.REF = CA.CAMASTID
         AND PO.POTXNUM = V_POTXNUM
   GROUP BY PO.POTXNUM, PO.POTXDATE, CM.REPORTDATE, CA.CAMASTID, SB.SYMBOL, CM.EXRATE,
            PO.POTXNUM , PO.POTXDATE , CF.CUSTODYCD, AF.ACCTNO, CF.FULLNAME, CM.EXPRICE,CM.DESCRIPTION
   order by PO.POTXDATE , PO.POTXNUM, CF.CUSTODYCD, AF.ACCTNO;
EXCEPTION
   WHEN OTHERS
   THEN
      RETURN;
END;                                                              -- PROCEDURE


-- End of DDL Script for Procedure HOST63.CA0022
/

