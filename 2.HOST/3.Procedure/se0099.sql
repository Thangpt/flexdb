CREATE OR REPLACE PROCEDURE SE0099(
   PV_REFCURSOR     IN OUT   PKG_REPORT.REF_CURSOR,
   v_VERSION        IN       VARCHAR2
        )
   IS
BEGIN
	OPEN PV_REFCURSOR FOR
		SELECT TRF.VERSION, RF.CUSTODYCD_R CUSTODYCD, RF.CUSTNAME_R CUSTNAME, RF.LICENSE_R LICNO, CF.IDDATE LICDT,
		DECODE(CF.IDTYPE, '001', 1, '009', 2, '005', 3, 4) LICTY,
		RF.BOARD_R BOARD, RF.SYMBOL_R SYMBOL, RF.NOTES_R NOTES,
		RF.DEPOTRADE_R+RF.DEPOBLOCK_R QTTY, RF.REQID
		FROM CFMAST CF, CRBTRFLOGDTL TRF,
		(SELECT *
		FROM   (SELECT DTL.REQID, DTL.FLDNAME, NVL(DTL.CVAL,DTL.NVAL) REFVAL
				FROM   CRBTXREQ MST, CRBTXREQDTL DTL WHERE MST.REQID=DTL.REQID AND MST.TRFCODE='SESENDDEPOSIT')
		PIVOT  (MAX(REFVAL) AS R FOR (FLDNAME) IN
		('DEPOTRADE' as DEPOTRADE, 'DEPOBLOCK' as DEPOBLOCK, 'QTTYTYPE' as QTTYTYPE, 'LICENSE' as LICENSE,
    'CUSTNAME' as CUSTNAME, 'CUSTODYCD' as CUSTODYCD, 'BOARD' as BOARD, 'SYMBOL' as SYMBOL, 'DESC' as NOTES))
    ORDER BY REQID) RF
    WHERE TRF.REFREQID=RF.REQID AND CF.CUSTODYCD=RF.CUSTODYCD_R
      AND TRF.VERSION=v_VERSION;
 EXCEPTION
    WHEN OTHERS
   THEN
      RETURN;
END; -- Procedure
/

