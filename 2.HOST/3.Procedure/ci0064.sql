CREATE OR REPLACE PROCEDURE CI0064
   (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   F_DATE         IN       VARCHAR2,
   T_DATE         IN       VARCHAR2,
   PV_TXTYPE      IN       VARCHAR2,
   PV_FUNDTYPE    IN       VARCHAR2,
   PV_BANKCODE    IN       VARCHAR2

   )
   IS
   v_BANKCODE VARCHAR2(500);
   v_TXTYPE VARCHAR2(20);

BEGIN

    IF PV_TXTYPE='ALL' THEN
         v_TXTYPE:='%%';
    ELSE
       v_TXTYPE:=PV_TXTYPE;
    END IF;

    IF PV_BANKCODE='ALL' THEN
         v_BANKCODE:='%%';
    ELSE
       v_BANKCODE:=PV_BANKCODE;
    END IF;



     ---GET REPORT DATA:

IF PV_FUNDTYPE = 'BVS' AND v_TXTYPE = 'DEPO' THEN
      --- Qui BVS + NOP
      OPEN PV_REFCURSOR
      FOR
      SELECT  CI.TLTXCD,PV_FUNDTYPE FUND,  CI.BUSDATE, CI.TXNUM, CF.FULLNAME, CI.CUSTODYCD, CI.ACCTNO, CI.NAMT, CI.TXDESC, CI.TXTYPE
      FROM    VW_CITRAN_GEN CI, CFMAST CF
      WHERE   CI.CUSTODYCD = CF.CUSTODYCD
      AND     FIELD = 'BALANCE'
      AND     TLTXCD IN ('1140')
      AND     CI.BUSDATE <= TO_DATE (T_DATE ,'DD/MM/YYYY') AND CI.BUSDATE >= TO_DATE (F_DATE ,'DD/MM/YYYY');

ELSIF PV_FUNDTYPE = 'BVS' AND v_TXTYPE = 'WITH' THEN
      --- Qui BVS + RUT
      OPEN PV_REFCURSOR
      FOR
      SELECT  CI.TLTXCD, PV_FUNDTYPE FUND,  CI.BUSDATE, CI.TXNUM, CF.FULLNAME, CI.CUSTODYCD, CI.ACCTNO, CI.NAMT, CI.TXDESC, CI.TXTYPE
      FROM    VW_CITRAN_GEN CI, CFMAST CF
      WHERE   CI.CUSTODYCD = CF.CUSTODYCD
      AND     FIELD = 'BALANCE'
      AND     TLTXCD IN ('1100')
      AND     CI.BUSDATE <= TO_DATE (T_DATE ,'DD/MM/YYYY') AND CI.BUSDATE >= TO_DATE (F_DATE ,'DD/MM/YYYY');

ELSIF PV_FUNDTYPE = 'BVS' AND PV_TXTYPE = 'ALL' THEN
      ---Qui BVS + NOP & RUT
      OPEN PV_REFCURSOR
      FOR
      SELECT  CI.TLTXCD, PV_FUNDTYPE FUND,  CI.BUSDATE, CI.TXNUM, CF.FULLNAME, CI.CUSTODYCD, CI.ACCTNO, CI.NAMT, CI.TXDESC, CI.TXTYPE
      FROM    VW_CITRAN_GEN CI, CFMAST CF
      WHERE   CI.CUSTODYCD = CF.CUSTODYCD
      AND     FIELD = 'BALANCE'
      AND     TLTXCD IN ('1140','1100')
      AND     CI.BUSDATE <= TO_DATE (T_DATE ,'DD/MM/YYYY') AND CI.BUSDATE >= TO_DATE (F_DATE ,'DD/MM/YYYY');

ELSIF PV_FUNDTYPE = 'NHG' AND v_TXTYPE = 'DEPO' THEN
  --- --- ---Qui Ngan hang + NOP
      OPEN PV_REFCURSOR
      FOR
      SELECT  CI.TLTXCD, PV_FUNDTYPE FUND, LG.CVALUE BANKCODE, BANK.FULLNAME BANKNAME,  CI.BUSDATE, CI.TXNUM, CF.FULLNAME, CI.CUSTODYCD, CI.ACCTNO, CI.NAMT, CI.TXDESC, CI.TXTYPE
      FROM    VW_CITRAN_GEN CI, CFMAST CF, BANKNOSTRO BANK,
      (
      SELECT * FROM TLLOGFLD
      UNION ALL
      SELECT * FROM TLLOGFLDALL
      ) LG
      WHERE   CI.CUSTODYCD = CF.CUSTODYCD
      AND     FIELD = 'BALANCE'
      AND     CI.TXDATE = LG.TXDATE
      AND     CI.TXNUM = LG.TXNUM
      AND     TLTXCD IN ('1131')
      AND     LG.FLDCD = '02'
      AND     LG.CVALUE = BANK.SHORTNAME
      AND     LG.CVALUE LIKE v_BANKCODE
      AND     CI.BUSDATE <= TO_DATE (T_DATE ,'DD/MM/YYYY') AND CI.BUSDATE >= TO_DATE (F_DATE ,'DD/MM/YYYY');

ELSIF PV_FUNDTYPE = 'NHG' AND v_TXTYPE = 'WITH' THEN
      --- --- --- Qui Ngan hang + RUT
      OPEN PV_REFCURSOR
      FOR
      SELECT  CI.TLTXCD, PV_FUNDTYPE FUND, LG.CVALUE BANKCODE, BANK.FULLNAME BANKNAME,  CI.BUSDATE, CI.TXNUM, CF.FULLNAME, CI.CUSTODYCD, CI.ACCTNO, CI.NAMT, CI.TXDESC, CI.TXTYPE
      FROM    VW_CITRAN_GEN CI, CFMAST CF, BANKNOSTRO BANK,
      (
      SELECT * FROM TLLOGFLD
      UNION ALL
      SELECT * FROM TLLOGFLDALL
      ) LG
      WHERE   CI.CUSTODYCD = CF.CUSTODYCD
      AND     FIELD = 'BALANCE'
      AND     TLTXCD IN ('1132')
      AND     CI.TXDATE = LG.TXDATE
      AND     CI.TXNUM = LG.TXNUM
      AND     LG.FLDCD = '02'
      AND     LG.CVALUE = BANK.SHORTNAME
      AND     LG.CVALUE LIKE v_BANKCODE
      AND     CI.BUSDATE <= TO_DATE (T_DATE ,'DD/MM/YYYY') AND CI.BUSDATE >= TO_DATE (F_DATE ,'DD/MM/YYYY');

ELSIF PV_FUNDTYPE = 'NHG' AND PV_TXTYPE = 'ALL' THEN
      --- --- --- Qui Ngan hang + NOP & RUT
      OPEN PV_REFCURSOR
      FOR
      SELECT  CI.TLTXCD, PV_FUNDTYPE FUND, LG.CVALUE BANKCODE, BANK.FULLNAME BANKNAME,  CI.BUSDATE, CI.TXNUM, CF.FULLNAME, CI.CUSTODYCD, CI.ACCTNO, CI.NAMT, CI.TXDESC, CI.TXTYPE
      FROM    VW_CITRAN_GEN CI, CFMAST CF, BANKNOSTRO BANK,
      (
      SELECT * FROM TLLOGFLD
      UNION ALL
      SELECT * FROM TLLOGFLDALL
      ) LG
      WHERE   CI.CUSTODYCD = CF.CUSTODYCD
      AND     FIELD = 'BALANCE'
      AND     TLTXCD IN ('1131','1132')
      AND     CI.TXDATE = LG.TXDATE
      AND     CI.TXNUM = LG.TXNUM
      AND     LG.FLDCD = '02'
      AND     LG.CVALUE = BANK.SHORTNAME
      AND     LG.CVALUE LIKE v_BANKCODE
      AND     CI.BUSDATE <= TO_DATE (T_DATE ,'DD/MM/YYYY') AND CI.BUSDATE >= TO_DATE (F_DATE ,'DD/MM/YYYY');

END IF;

EXCEPTION
    WHEN OTHERS THEN
        RETURN ;
END; -- Procedure
/

