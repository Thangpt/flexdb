CREATE OR REPLACE PROCEDURE gl0035 (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   I_DATE         IN       VARCHAR2
)
IS

--
-- PURPOSE:
-- BAO CAO SO DU TIEN MAT
-- MODIFICATION HISTORY
-- PERSON               DATE                COMMENTS
-- ---------------     -----------         ---------------------
-- DUNGNH              06/08/2010          TAO MOI
-- ---------   ------  -------------------------------------------

  V_STROPTION            VARCHAR2 (5);       -- A: ALL; B: BRANCH; S: SUB-BRANCH
  V_STRBRID              VARCHAR2 (4);

  V_IN_DATE              DATE;
  V_CURR_DATE            DATE;


BEGIN

    V_STROPTION := OPT;

     IF V_STROPTION = 'A' THEN     -- TOAN HE THONG
      V_STRBRID := '%';
   ELSIF V_STROPTION = 'B' THEN
      V_STRBRID := SUBSTR(BRID,1,2) || '__' ;
   ELSE
      V_STRBRID := BRID;
   END IF;

   SELECT  TO_DATE(VARVALUE,'DD/MM/RRRR') INTO V_CURR_DATE FROM SYSVAR WHERE VARNAME = 'CURRDATE' AND GRNAME = 'SYSTEM';
   V_IN_DATE := TO_DATE(I_DATE,'DD/MM/RRRR');


-- MAIN REPORT
OPEN PV_REFCURSOR FOR
SELECT CF.CUSTODYCD CUSTODYCD, DF.ACCTNO, DFTR.RLSAMT, DFTR.INTPAID, DFTR.TXDATE,
    NVL(CITR.NAMT,0) NAMT, NVL(KNTR.NAMT,0) KN_AMT, NVL(BLTR.PRINPAID,0) PRINPAID,
    NVL(BLTR.INTPAID,0) BL_INTPAID, NVL(TMTR.BALANCE,0) BALANCE,
    TL.TLTXCD , NVL(TLPR_1.TLNAME,' ') USER_THUCHIEN, NVL(TLPR_2.TLNAME,' ') USER_DUYET,
    TL.TXNUM, BR.BRNAME
FROM AFMAST AF, CFMAST CF, VW_DFMAST_ALL DF , VW_TLLOG_ALL TL,
    TLPROFILES TLPR_1, TLPROFILES TLPR_2, BRGRP BR,
(
--SO TIEN THANH LY TAI NGAY TAO BAO CAO.
    SELECT * FROM
    (
        SELECT TXNUM, TXDATE, DFACCTNO,
            SUM(RLSAMT) RLSAMT,
            SUM(INTPAID) INTPAID
        FROM
        (
            --- TRA NO GOC
            SELECT TO_CHAR(TR.TXNUM) TXNUM, TR.TXDATE, TR.ACCTNO DFACCTNO,
                TR.NAMT RLSAMT,
                0 INTPAID
            FROM VW_DFTRAN_ALL TR, APPTX TX
            WHERE TR.TXCD = TX.TXCD 
                AND TX.FIELD = 'RLSAMT' AND TX.APPTYPE = 'DF' AND TX.TXTYPE = 'C'
                AND TR.NAMT <> 0
                AND TR.TXDATE = V_IN_DATE
            --- TRA LAI    
            UNION ALL
            SELECT TO_CHAR(TR.TXNUM) TXNUM, TR.TXDATE, DF.ACCTNO DFACCTNO,
                0 RLSAMT,
                SUM(TR.NAMT) INTPAID
            FROM VW_LNTRAN_ALL TR, APPTX TX, VW_DFMAST_ALL DF
            WHERE TR.TXCD = TX.TXCD 
                AND DF.LNACCTNO = TR.ACCTNO 
                AND TX.FIELD IN ('INTPAID') AND TX.APPTYPE = 'LN' AND TX.TXTYPE = 'C'
                AND TR.NAMT <> 0
                AND TR.TXDATE = V_IN_DATE
            GROUP BY TO_CHAR(TR.TXNUM), TR.TXDATE, DF.ACCTNO
        ) TR
        GROUP BY TXNUM, TXDATE, DFACCTNO
    )
) DFTR,
(
--SO TIEN UNG TRUOC TRONG NGAY TAO BAO CAO.
    SELECT ACCTNO, SUM(NAMT) NAMT
    FROM 
    (
        
        SELECT CI.ACCTNO ACCTNO, CI.NAMT NAMT
        FROM VW_CITRAN_ALL CI, APPTX TX
        WHERE CI.TXCD = TX.TXCD
            AND TX.FIELD IN('AAMT')
            AND TX.TXTYPE = 'C'
            AND TX.APPTYPE = 'CI'
            AND CI.NAMT <> 0
            AND NVL(CI.TLTXCD,'1153') <> '1153'
            AND CI.TXDATE = V_IN_DATE  
                  
        UNION ALL
        
        SELECT ACCTNO, AMT NAMT
        FROM ADSCHD
        WHERE DELTD <> 'Y'
            AND TXDATE = V_IN_DATE
        UNION ALL    
        SELECT ACCTNO, AMT NAMT
        FROM ADSCHDHIST
        WHERE DELTD <> 'Y'
            AND TXDATE = V_IN_DATE
    )
    GROUP BY ACCTNO              
) CITR,
(
--SU TIEN KHOANH NO TAI NGAY TAO BAO CAO.
    SELECT CITR.ACCTNO, CITR.NAMT
    FROM VW_CITRAN_ALL CITR, APPTX APP
    WHERE CITR.TXCD = APP.TXCD 
        AND APP.TXTYPE = 'C'
        AND APP.FIELD = 'DFDEBTAMT'
        AND CITR.NAMT <> 0
        AND APP.APPTYPE = 'DF'
        AND CITR.TXDATE = V_IN_DATE
) KNTR,
(    
--PHAT VAY BAO LANH TRONG NGAY TAO BAO CAO.
    SELECT AF.ACCTNO,
        SUM(CASE WHEN APP.FIELD IN ('PRINPAID','OPRINPAID') THEN LNTR.NAMT ELSE 0 END) PRINPAID,
        SUM(CASE WHEN APP.FIELD IN ('INTPAID','OINTPAID') THEN LNTR.NAMT ELSE 0 END) INTPAID
    FROM VW_LNTRAN_ALL LNTR, APPTX APP, VW_LNMAST_ALL LN,
        AFMAST AF
    WHERE LNTR.TXCD = APP.TXCD
        AND LNTR.ACCTNO = LN.ACCTNO
        AND LN.FTYPE = 'AF'
        AND APP.FIELD IN ('PRINPAID','OPRINPAID','INTPAID','OINTPAID')
        AND APP.APPTYPE LIKE 'LN'
        AND LNTR.NAMT > 1
        AND LN.TRFACCTNO = AF.ACCTNO
        AND LN.FTYPE <> 'DF'
        AND LNTR.TXDATE = V_IN_DATE
    GROUP BY AF.ACCTNO
) BLTR,
(
--SO DU TAI KHOAN KHACH HANG TAI THOI DIEM TAO BAO CAO.    
    SELECT CI_CURR.ACCTNO, ROUND(SUM(CI_CURR.BALANCE - NVL(CI_TR.TR_BALANCE,0))) BALANCE
    FROM CIMAST CI_CURR,
        (
            SELECT TR.ACCTNO,
                ROUND(SUM(CASE WHEN TX.FIELD = 'BALANCE' THEN (CASE WHEN TX.TXTYPE = 'D' THEN -TR.NAMT ELSE TR.NAMT END)
                            ELSE 0 END)) TR_BALANCE
            FROM VW_CITRAN_ALL TR, APPTX TX
            WHERE TR.TXCD = TX.TXCD
                AND TX.APPTYPE = 'CI'
                AND TX.TXTYPE IN ('C','D')
                AND TX.FIELD  = 'BALANCE'
                AND NVL(TR.BKDATE,TR.TXDATE) > V_IN_DATE
            GROUP BY TR.ACCTNO
        ) CI_TR
    WHERE CI_CURR.ACCTNO = CI_TR.ACCTNO(+)        
    GROUP BY CI_CURR.ACCTNO    
) TMTR
WHERE DF.ACCTNO = DFTR.DFACCTNO
    AND DF.AFACCTNO = AF.ACCTNO
    AND AF.CUSTID = CF.CUSTID
    AND AF.ACCTNO = CITR.ACCTNO (+)
    AND AF.ACCTNO = KNTR.ACCTNO (+)
    AND AF.ACCTNO = BLTR.ACCTNO (+)
    AND AF.ACCTNO = TMTR.ACCTNO (+)
    AND DFTR.TXNUM = TL.TXNUM
    AND DFTR.TXDATE = TL.TXDATE
    AND TL.TLID = TLPR_1.TLID(+)
    AND TL.OFFID = TLPR_2.TLID(+)
    AND SUBSTR(DF.ACCTNO,1,4) = BR.BRID (+)
ORDER BY CUSTODYCD
;

EXCEPTION
   WHEN OTHERS THEN
      RETURN;
END;
/

