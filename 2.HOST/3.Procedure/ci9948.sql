CREATE OR REPLACE PROCEDURE CI9948
 (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   F_DATE         IN       VARCHAR2,
   T_DATE         IN       VARCHAR2,
   PV_CUSTODYCD   IN       VARCHAR2,
--   PV_AFACCTNO    IN       VARCHAR2,
   PV_TLID IN VARCHAR2
  )
IS
--

-- BANG KE GIAI TOA TIEN
-- MODIFICATION HISTORY
-- PERSON       DATE                COMMENTS
-- ---------   ------  -------------------------------------------
-- HUONG.TTD    08-OCT-2010           CREATED


   CUR            PKG_REPORT.REF_CURSOR;
   V_STROPTION    VARCHAR2 (5);            -- A: ALL; B: BRANCH; S: SUB-BRANCH
   V_STRBRID      VARCHAR2 (4);                   -- USED WHEN V_NUMOPTION > 0
   V_FROMDATE DATE;
   V_TODATE DATE;
   V_CURRDATE DATE;
   V_CUSTODYCD VARCHAR2(20);
--   V_AFACCTNO VARCHAR2(20);
   V_TLID VARCHAR2(4);


BEGIN

V_TLID := PV_TLID;
V_STROPTION := OPT;
IF V_STROPTION = 'A' THEN
    V_STRBRID := '%';
ELSIF V_STROPTION = 'B' THEN
    V_STRBRID := SUBSTR(BRID,1,2) || '__' ;
ELSE
    V_STRBRID:=BRID;
END IF;

V_FROMDATE  := TO_DATE(F_DATE,'DD/MM/RRRR');
V_TODATE    := TO_DATE(T_DATE,'DD/MM/RRRR');
V_CUSTODYCD := UPPER(REPLACE(PV_CUSTODYCD,'.',''));
--V_AFACCTNO  := UPPER(REPLACE(PV_AFACCTNO,'.',''));

if V_CUSTODYCD = 'ALL' or V_CUSTODYCD is null then
    V_CUSTODYCD := '%';
ELSE
    V_CUSTODYCD := V_CUSTODYCD ;
end if;

OPEN PV_REFCURSOR FOR

-- Bang ke giai toa tien (CI9948)

 SELECT TR.CUSTODYCD,TR.ACCTNO,TR.TXNUM,TR.TXDATE,CF.FULLNAME,TL.TLNAME USER_CAREDBY,BR.BRNAME CHI_NHANH,TR.TXDESC,
         ROUND(SUM(CASE WHEN TR.TXTYPE = 'D' THEN TR.NAMT ELSE 0 END),0) AMT
    FROM VW_CITRAN_GEN TR, CFMAST CF, TLPROFILES TL,BRGRP BR
    WHERE TR.FIELD = 'EMKAMT'
        AND TR.TXTYPE ='D'
        AND TR.TXDATE BETWEEN V_FROMDATE AND V_TODATE
        AND TR.custodycd=CF.CUSTODYCD
        AND CF.TLID=TL.TLID
        AND TL.BRID=BR.BRID
        AND TR.CUSTODYCD LIKE V_CUSTODYCD
   GROUP BY TR.custodycd, TR.ACCTNO,TR.TXNUM,TR.TXDATE,CF.FULLNAME,TL.TLNAME,BR.BRNAME,TR.TXDESC
   ORDER BY TR.custodycd
;

EXCEPTION
  WHEN OTHERS
   THEN
      RETURN;
END;
/

