CREATE OR REPLACE PROCEDURE td0002 (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   I_DATE         IN       VARCHAR2,
   AFACCTNO       IN       VARCHAR2,
   LOANTYPE       IN       VARCHAR2,
   CAREBY         IN       VARCHAR2
   )
IS
-- MODIFICATION HISTORY
-- Bao cao tinh trang no qua han
-- PERSON           DATE        COMMENTS
-- DUNGNH       24-MAR-2011     CREATED
-- ---------       ------   -------------------------------------------
   V_STROPTION      VARCHAR2 (5);            -- A: ALL; B: BRANCH; S: SUB-BRANCH
   V_STRBRID        VARCHAR2 (4);            -- USED WHEN V_NUMOPTION > 0

   V_INDATE         date;
   V_STRAFACCTNO    VARCHAR2 (10);
   V_STRCAREBY      VARCHAR2 (4);

-- DECLARE PROGRAM VARIABLES AS SHOWN ABOVE
BEGIN
   V_STROPTION := OPT;

   IF (V_STROPTION <> 'A') AND (BRID <> 'ALL')
   THEN
      V_STRBRID := BRID;
   ELSE
      V_STRBRID := '%%';
   END IF;

    -- GET REPORT'S PARAMETERS

    V_STRCAREBY := CAREBY;

   IF(upper(AFACCTNO) <> 'ALL') THEN
        V_STRAFACCTNO := AFACCTNO;
   ELSE
        V_STRAFACCTNO := '%';
   END IF;

   V_INDATE := to_date(I_DATE,'dd/mm/yyyy');


   -- GET REPORT'S DATA
IF(LOANTYPE = '01') THEN

OPEN PV_REFCURSOR
       FOR

SELECT I_DATE IDATE, MST.ACTYPE, MST.ACCTNO, MST.AFACCTNO, MST.ORGAMT, MST.FRDATE,
    (SELECT min(sbdate) FROM SBCLDR WHERE CLDRTYPE = '000' 
                                AND SBDATE >= MST.TODATE AND HOLIDAY = 'N') TODATE,
    (MST.BALANCE-NVL(TR.NAMT,0)) NAMT,
    (FN_TDMASTINTRATIO(MST.ACCTNO,V_INDATE,(MST.BALANCE-NVL(TR.NAMT,0))))INTAVLAMT
FROM TDMAST MST, AFMAST AF, CFMAST CF,
    (
        SELECT DISTINCT TLGRPUSERS.GRPID
        FROM TLPROFILES, TLGRPUSERS
        WHERE TLPROFILES.TLID LIKE V_STRCAREBY
            AND TLPROFILES.BRID = TLGRPUSERS.BRID
            AND TLPROFILES.TLID = TLGRPUSERS.TLID
    ) CARE,
    (
        SELECT TR.ACCTNO, SUM(TR.NAMT) NAMT
        FROM
            (
                SELECT DISTINCT TR.ACCTNO, txnum, txdate,
                (CASE WHEN APP.TXTYPE = 'D' THEN -TR.NAMT ELSE TR.NAMT END) NAMT
                FROM (SELECT * FROM TDTRAN UNION ALL SELECT * FROM TDTRANA) TR,
                V_APPMAP_BY_TLTXCD APP
                WHERE TR.NAMT > 0 AND DELTD <> 'Y'
                    AND TR.TXCD = APP.APPTXCD
                    AND APP.FIELD = 'BALANCE'
                    AND APP.APPTYPE = 'TD'
                    AND NVL(TR.BKDATE,TR.TXDATE) >= V_INDATE
            ) TR
        GROUP BY TR.ACCTNO
    ) TR
WHERE MST.ACCTNO = TR.ACCTNO(+)
    AND MST.OPNDATE <= V_INDATE
    AND (MST.BALANCE-NVL(TR.NAMT,0)) > 0
    AND MST.AFACCTNO = AF.ACCTNO
    AND AF.CUSTID = CF.CUSTID
    AND MST.STATUS IN ('N','A')
    AND CF.CAREBY = CARE.GRPID
    AND MST.AFACCTNO LIKE V_STRAFACCTNO;

ELSE

OPEN PV_REFCURSOR
       FOR
SELECT I_DATE IDATE, MST.ACTYPE, MST.ACCTNO, MST.AFACCTNO, MST.ORGAMT, MST.FRDATE,
    (SELECT min(sbdate) FROM SBCLDR WHERE CLDRTYPE = '000' 
                                AND SBDATE >= MST.TODATE AND HOLIDAY = 'N') TODATE,
    (MST.BALANCE-NVL(TR.NAMT,0)) NAMT,
    (FN_TDMASTINTRATIO(MST.ACCTNO,(SELECT min(sbdate) FROM SBCLDR WHERE CLDRTYPE = '000' 
                                AND SBDATE >= MST.TODATE AND HOLIDAY = 'N'),(MST.BALANCE-NVL(TR.NAMT,0))))INTAVLAMT
FROM TDMAST MST, AFMAST AF, CFMAST CF,
    (
        SELECT DISTINCT TLGRPUSERS.GRPID
        FROM TLPROFILES, TLGRPUSERS
        WHERE TLPROFILES.TLID LIKE V_STRCAREBY
            AND TLPROFILES.BRID = TLGRPUSERS.BRID
            AND TLPROFILES.TLID = TLGRPUSERS.TLID
    ) CARE,
    (
        SELECT TR.ACCTNO,
        SUM(CASE WHEN APP.TXTYPE = 'D' THEN -TR.NAMT ELSE TR.NAMT END) NAMT
        FROM (SELECT * FROM TDTRAN UNION ALL SELECT * FROM TDTRANA) TR,
            V_APPMAP_BY_TLTXCD APP
        WHERE TR.NAMT > 0 AND DELTD <> 'Y'
            AND TR.TXCD = APP.APPTXCD
            AND APP.FIELD = 'BALANCE'
            AND APP.APPTYPE = 'TD'
            AND NVL(TR.BKDATE,TR.TXDATE) >= V_INDATE
        GROUP BY TR.ACCTNO
    ) TR
WHERE MST.ACCTNO = TR.ACCTNO(+)
    AND MST.OPNDATE <= V_INDATE
    AND MST.STATUS IN ('N','A')
    AND (MST.BALANCE-NVL(TR.NAMT,0)) > 0
    AND MST.AFACCTNO = AF.ACCTNO
    AND AF.CUSTID = CF.CUSTID
    AND CF.CAREBY = CARE.GRPID
    AND MST.AFACCTNO LIKE V_STRAFACCTNO;

END IF;


EXCEPTION
   WHEN OTHERS
   THEN
      RETURN;
END;                                                              -- PROCEDURE
/

