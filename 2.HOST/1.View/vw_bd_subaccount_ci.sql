CREATE OR REPLACE FORCE VIEW VW_BD_SUBACCOUNT_CI AS
SELECT MAX(CF.CUSTID) CUSTID, MST.AFACCTNO, MAX(NVL(MST.BALANCE,0)) CASH_ON_HAND,
MAX(NVL(AF.ADVANCELINE,0)) ADVANCEDLINE, MAX(NVL(AF.MRCRLIMITMAX,0)) MRCRLIMITMAX,
MAX(NVL(MST.ODAMT,0)) OUTSTANDING, MAX(NVL(REFORDER.SECUREAMT,0)) ORDERAMT, MAX(NVL(ADVFEE.MINVAL,0)) ADVMIN,
ROUND(SUM(CASE WHEN ST.DUETYPE='RM' AND ST.TDAY=1 THEN (NVL(ST.ST_AMT,0)-NVL(ST.ST_AAMT,0)-NVL(ST.ST_FAMT,0))*NVL(ST.NDAY,0)*NVL(ADVFEE.INTRATE,0)/(100*360) ELSE 0 END),0) ADVT1, --phi ung truoc t1
ROUND(SUM(CASE WHEN ST.DUETYPE='RM' AND ST.TDAY=2 THEN (NVL(ST.ST_AMT,0)-NVL(ST.ST_AAMT,0)-NVL(ST.ST_FAMT,0))*NVL(ST.NDAY,0)*NVL(ADVFEE.INTRATE,0)/(100*360) ELSE 0 END),0) ADVT2, --phi ung truoc t2
ROUND(SUM(CASE WHEN ST.DUETYPE='RM' AND ST.TDAY=3 THEN (NVL(ST.ST_AMT,0)-NVL(ST.ST_AAMT,0)-NVL(ST.ST_FAMT,0))*NVL(ST.NDAY,0)*NVL(ADVFEE.INTRATE,0)/(100*360) ELSE 0 END),0) ADVT3, --phi ung truoc t3
SUM(CASE WHEN ST.DUETYPE='RM' AND ST.TDAY=0 THEN ST.ST_AMT-ST.ST_AAMT-ST.ST_FAMT ELSE 0 END) CASH_RECEIVING_T0,
SUM(CASE WHEN ST.DUETYPE='RM' AND ST.TDAY=1 THEN ST.ST_AMT-ST.ST_AAMT-ST.ST_FAMT ELSE 0 END) CASH_RECEIVING_T1,
SUM(CASE WHEN ST.DUETYPE='RM' AND ST.TDAY=2 THEN ST.ST_AMT-ST.ST_AAMT-ST.ST_FAMT ELSE 0 END) CASH_RECEIVING_T2,
SUM(CASE WHEN ST.DUETYPE='RM' AND ST.TDAY=3 THEN ST.ST_AMT-ST.ST_AAMT-ST.ST_FAMT ELSE 0 END) CASH_RECEIVING_T3,
SUM(CASE WHEN ST.DUETYPE='RM' AND ST.TDAY>3 THEN ST.ST_AMT-ST.ST_AAMT-ST.ST_FAMT ELSE 0 END) CASH_RECEIVING_TN,
SUM(CASE WHEN ST.DUETYPE='SM' AND ST.TDAY=0 THEN ST.ST_AMT-ST.ST_AAMT-ST.ST_FAMT ELSE 0 END) CASH_SENDING_T0,
SUM(CASE WHEN ST.DUETYPE='SM' AND ST.TDAY=1 THEN ST.ST_AMT-ST.ST_AAMT-ST.ST_FAMT ELSE 0 END) CASH_SENDING_T1,
SUM(CASE WHEN ST.DUETYPE='SM' AND ST.TDAY=2 THEN ST.ST_AMT-ST.ST_AAMT-ST.ST_FAMT ELSE 0 END) CASH_SENDING_T2,
SUM(CASE WHEN ST.DUETYPE='SM' AND ST.TDAY=3 THEN ST.ST_AMT-ST.ST_AAMT-ST.ST_FAMT ELSE 0 END) CASH_SENDING_T3,
SUM(CASE WHEN ST.DUETYPE='SM' AND ST.TDAY>3 THEN ST.ST_AMT-ST.ST_AAMT-ST.ST_FAMT ELSE 0 END) CASH_SENDING_TN
FROM CIMAST MST, AFMAST AF, CFMAST CF, VW_STRADE_FEE_ADV_PAYMENT ADVFEE, V_GETBUYORDERINFO REFORDER,
(SELECT * FROM VW_BD_PENDING_SETTLEMENT WHERE DUETYPE='RM' OR DUETYPE='SM') ST
WHERE MST.AFACCTNO=AF.ACCTNO AND AF.CUSTID=CF.CUSTID
AND MST.AFACCTNO=ST.AFACCTNO (+) AND MST.AFACCTNO=REFORDER.AFACCTNO (+)
GROUP BY MST.AFACCTNO
;

