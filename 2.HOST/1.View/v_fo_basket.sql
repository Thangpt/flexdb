CREATE OR REPLACE FORCE VIEW V_FO_BASKET AS
Select sbk.basketid BASKETID,
    sbk.symbol SYMBOL,
    LEAST(sif.marginprice, sis.mrpriceloan,  sbk.MRPRICELOAN) PRICE_MARGIN,
    LEAST(sif.marginprice, sis.mrpricerate,  sbk.MRPRICERATE) PRICE_ASSET,
    0 RATE_BUY,
    sbk.mrratioloan RATE_MARGIN,
    sbk.mrratiorate RATE_ASSET,
    sif.txdate
From secbasket sbk, securities_info sif, securities_risk sis
where sbk.symbol = sif.symbol
    and sif.codeid = sis.codeid
UNION ALL
SELECT 'BLACK_LIST' BASKETID, SYMBOL, NULL  PRICE_MARGIN, NULL PRICE_ASSET, NULL RATE_BUY,
NULL RATE_MARGIN, NULL RATE_ASSET, MKDATE txdate
FROM BLACKLISTSYMBOL
WHERE  STATUS = 'A' AND EFFDATE <= (SELECT to_date(VARVALUE,'DD/MM/RRRR') FROM   sysvar WHERE varname ='CURRDATE')
 AND (EXPDATE IS NULL OR EXPDATE > (SELECT to_date(VARVALUE,'DD/MM/RRRR') FROM   sysvar WHERE varname ='CURRDATE'))
UNION ALL
SELECT 'BLACK_LIST'||','||A.AFACCTNO BASKETID, SYMBOL, NULL  PRICE_MARGIN, NULL PRICE_ASSET, NULL RATE_BUY,
NULL RATE_MARGIN, NULL RATE_ASSET, MKDATE txdate
FROM BLACKLISTSYMBOL B, AFBLACKLISTSYMBOL A
WHERE B.STATUS = 'A' AND A.REFSYMBOL = B.SYMBOL AND EFFDATE <= (SELECT to_date(VARVALUE,'DD/MM/RRRR') FROM   sysvar WHERE varname ='CURRDATE')
 AND (EXPDATE IS NULL OR EXPDATE > (SELECT to_date(VARVALUE,'DD/MM/RRRR') FROM   sysvar WHERE varname ='CURRDATE'));

