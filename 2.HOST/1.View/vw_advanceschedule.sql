CREATE OR REPLACE FORCE VIEW VW_ADVANCESCHEDULE AS
(

SELECT CF.CUSTODYCD, CF.CUSTID, CF.FULLNAME, AF.ACCTNO, AF.AUTOADV, AF.ACTYPE, NVL(ISVSD,'N') ISVSD,
  --B? THAM S? ÃƒÆ’Ã‚Â? G?I B?NG KÃƒÆ’Ã…Â  CHO TÃƒÆ’Ã¢â€šÂ¬I KHO?N K?T N?I COREBANK
    (CASE WHEN CI.COREBANK='Y' THEN 1 ELSE 0 END) TRFBANK,
    (CASE WHEN CI.COREBANK='Y' THEN 1 ELSE 0 END) COREBANK,
    (CASE WHEN CI.COREBANK='Y' THEN AF.BANKACCTNO ELSE NULL END) BANKACCT,
    (CASE WHEN CI.COREBANK='Y' THEN AF.BANKNAME ELSE NULL END) BANKCODE,
    RF.CLEARDATE, RF.TXDATE, TO_DATE(SY1.varvalue,'DD/MM/YYYY') CURRDATE,
   ROUND( RF.EXECAMT-RF.AAMT-RF.BRKFEEAMT-(CASE WHEN TYP.VAT='Y' THEN (RF.RIGHTTAX+ RF.INCOMETAXAMT) ELSE 0 END)/*RF.RIGHTTAX-RF.INCOMETAXAMT*/,4) MAXAVLAMT,    --check thu thue moi tru thue
   ROUND( RF.EXECAMT,4) EXECAMT, ROUND(RF.AMT,4) AMT, RF.AAMT, RF.PAIDAMT, RF.PAIDFEEAMT, RF.BRKFEEAMT, RF.RIGHTTAX, RF.INCOMETAXAMT,
    (CASE WHEN RF.CLEARDATE - TO_DATE(SY1.varvalue,'DD/MM/YYYY') =0 THEN 1 ELSE RF.CLEARDATE -TO_DATE(SY1.varvalue,'DD/MM/YYYY') END) DAYS,
    RF.FAMT, RF.CLEARDAY, RF.CLEARCD
FROM AFMAST AF, CIMAST CI, CFMAST CF, SYSVAR SY1, AFTYPE TYP,
--Nh?ng deal chua UTTB: Seach ra vÃƒÆ’Ã‚Â  n?p vÃƒÆ’Ã‚Â o giao d?ch 1153: Giao d?ch nÃƒÆ’Ã‚Â y cho ch?n ngu?n
(
     SELECT STS.AFACCTNO, STS.CLEARDATE, STS.TXDATE,NVL(ISVSD,'N') ISVSD,
        SUM(case when NVL(DF.EXECQTTY,0) > 0 then DF.EXECQTTY else STS.QTTY end *  (STS.AMT/STS.QTTY) ) EXECAMT,
        SUM(DECODE(ISVSD,'Y',DF.FAMT,NVL(STS.FAMT,0) - nvl(DFVSD.FAMT,0))) FAMT,
        SUM(DECODE(ISVSD,'Y',DF.AAMT,STS.AAMT - nvl(DFVSD.AAMT,0))) AAMT,
        SUM(STS.PAIDAMT) PAIDAMT, SUM(STS.PAIDFEEAMT) PAIDFEEAMT,
        SUM(case when NVL(DF.EXECQTTY,0) > 0 then DF.EXECQTTY else STS.QTTY end *  (STS.AMT/STS.QTTY)
            - DECODE(ISVSD,'Y',DF.AAMT,STS.AAMT - nvl(DF.AAMT,0))
            - DECODE(ISVSD,'Y',DF.FAMT,NVL(STS.FAMT,0) - nvl(DF.FAMT,0)) + STS.PAIDAMT + STS.PAIDFEEAMT) AMT,
        SUM(CASE WHEN MST.FEEACR<=0 THEN round(ODT.DEFFEERATE* (case when NVL(DF.EXECQTTY,0) > 0 then DF.EXECQTTY else STS.QTTY end *  (STS.AMT/STS.QTTY))/100) ELSE MST.FEEACR END) BRKFEEAMT,
        SUM(STS.ARIGHT) RIGHTTAX, --THU? C? T?C
        SUM(case when mst.TAXSELLAMT > 0 then mst.TAXSELLAMT else round(TO_NUMBER(SY0.VARVALUE)*(case when NVL(DF.EXECQTTY,0) > 0 then DF.EXECQTTY else STS.QTTY end *  (STS.AMT/STS.QTTY) )/100) end) INCOMETAXAMT,
        MAX(STS.CLEARDAY) CLEARDAY, MAX(STS.CLEARCD) CLEARCD

    FROM STSCHD STS, SYSVAR SY0, ODTYPE ODT, SBSECURITIES SB, ODMAST MST,
        (
        SELECT ORDERID,ODM.ISVSD, sum(ODM.EXECQTTY) EXECQTTY, sum(ODM.AAMT) AAMT, sum(ODM.FAMT) FAMT
            FROM ODMAPEXT ODM WHERE DELTD <> 'Y' GROUP BY ORDERID,ODM.ISVSD
        ) DF,
        (
         SELECT ORDERID, sum(ODM.EXECQTTY) EXECQTTY, sum(decode(ISVSD,'Y',ODM.AAMT,0)) AAMT, sum(decode(ISVSD,'Y',ODM.FAMT,0)) FAMT
            FROM ODMAPEXT ODM WHERE DELTD <> 'Y' GROUP BY ORDERID
        ) DFVSD

    WHERE STS.ORGORDERID=MST.ORDERID AND STS.CODEID=SB.CODEID AND MST.ACTYPE = ODT.ACTYPE
        AND STS.DELTD <> 'Y' AND STS.STATUS='N' AND STS.DUETYPE='RM'
        AND SY0.VARNAME = 'ADVSELLDUTY' AND SY0.GRNAME = 'SYSTEM'
        and mst.grporder<>'Y'
        AND MST.errod = 'N'
        AND MST.ORDERID =DFVSD.ORDERID (+)
        AND MST.ORDERID = DF.ORDERID (+)
        --AND MST.ADVVSD <> 'Y' -- KHONG LAY CAM CO VSD
    GROUP BY STS.AFACCTNO, STS.CLEARDATE, STS.TXDATE,NVL(ISVSD,'N')

) RF
WHERE RF.AFACCTNO=AF.ACCTNO (+) AND CI.AFACCTNO=AF.ACCTNO AND AF.CUSTID=CF.CUSTID AND CF.CUSTATCOM='Y' --LOAI DI NHUNG TAI KHOAN LUU KY BEN NGOAI
    --AND CI.COREBANK <> 'Y'  --Khong cho UTTB loai tai khoan Corebank
    AND SY1.VARNAME='CURRDATE' AND SY1.GRNAME='SYSTEM'
    AND AF.ACTYPE=TYP.ACTYPE
)
;

