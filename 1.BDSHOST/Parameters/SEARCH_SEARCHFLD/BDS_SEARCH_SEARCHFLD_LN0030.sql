--
--
/
DELETE search WHERE searchcode = 'LN0030';
insert into search (SEARCHCODE, SEARCHTITLE, EN_SEARCHTITLE, SEARCHCMDSQL, OBJNAME, FRMNAME, ORDERBYCMDSQL, TLTXCD, CNTRECORD, ROWPERPAGE, AUTOSEARCH, INTERVAL, AUTHCODE, ROWLIMIT, CMDTYPE)
values ('LN0030', 'Danh sách tài khoản vi phạm cấp bảo lãnh', 'List of accounts of guarantee violations', 'SELECT * FROM (
SELECT CF.CUSTODYCD, CF.FULLNAME, AF.ACCTNO AFACCTNO, AF.ADVANCELINE, 
       ROUND(LEAST(NVL((CI.BALANCE - NVL(V_GETBUY.SECUREAMT, 0)) +
                               NVL(ADV.AVLADVANCE, 0) + V_GETSEC.SENAVAMT -
                               (NVL(LN.MARGINAMT, 0) + NVL(LN.T0AMT, 0)),
                               0) * CF.T0LOANRATE / 100,
                           NVL(V_GETSEC.SELIQAMT2, 0))) T0CAL,
       RE.REFULLNAME, GRP.GRPID || ''-'' || GRP.GRPNAME CAREBY
FROM CFMAST CF, AFMAST AF, CIMAST CI, V_GETBUYORDERINFO V_GETBUY, V_GETSECMARGININFO_ALL V_GETSEC, (
   SELECT SUM(AAMT) AAMT, SUM(DEPOAMT) AVLADVANCE,
          SUM(PAIDAMT) PAIDAMT, SUM(ADVAMT) ADVANCEAMOUNT,
          AFACCTNO       
   FROM V_GETACCOUNTAVLADVANCE GROUP BY AFACCTNO
) ADV, (
   SELECT TRUNC(SUM(PRINNML + PRINOVD + INTNMLACR + INTDUE + INTOVDACR + INTNMLOVD + FEEINTNMLACR + FEEINTDUE + FEEINTOVDACR + FEEINTNMLOVD), 0) MARGINAMT,
          TRUNC(SUM(OPRINNML + OPRINOVD + OINTNMLACR + OINTDUE + OINTOVDACR + OINTNMLOVD), 0) T0AMT,
          TRUNC(SUM(PRINOVD + INTOVDACR + INTNMLOVD + FEEINTOVDACR + FEEINTNMLOVD + NVL(LS.DUEAMT, 0) + INTDUE + FEEINTDUE), 0) MARGINOVDAMT,
          TRUNC(SUM(OPRINOVD + OINTOVDACR + OINTNMLOVD), 0) T0OVDAMT, TRFACCTNO
   FROM LNMAST LN, LNTYPE LNT, (
      SELECT ACCTNO, SUM(NML) DUEAMT
      FROM LNSCHD, (SELECT * FROM SYSVAR WHERE VARNAME = ''CURRDATE'' AND GRNAME = ''SYSTEM'') SY
      WHERE REFTYPE = ''P''
        AND OVERDUEDATE = TO_DATE(VARVALUE, ''DD/MM/RRRR'')
      GROUP BY ACCTNO
   ) LS
   WHERE FTYPE = ''AF''
     AND LN.ACTYPE = LNT.ACTYPE
     AND LN.ACCTNO = LS.ACCTNO(+)
   GROUP BY LN.TRFACCTNO
) LN, (
   SELECT RE.AFACCTNO, MAX(CF.FULLNAME) REFULLNAME
   FROM REAFLNK RE, SYSVAR SYS, CFMAST CF, RETYPE
   WHERE TO_DATE(VARVALUE, ''DD/MM/RRRR'') BETWEEN RE.FRDATE AND RE.TODATE
     AND SUBSTR(RE.REACCTNO, 0, 10) = CF.CUSTID
     AND VARNAME = ''CURRDATE''
     AND GRNAME = ''SYSTEM''
     AND RE.STATUS <> ''C''
     AND RE.DELTD <> ''Y''
     AND SUBSTR(RE.REACCTNO, 11) = RETYPE.ACTYPE
     AND REROLE IN (''RM'', ''BM'')
   GROUP BY AFACCTNO
) RE, TLGROUPS GRP
WHERE CF.CUSTID = AF.CUSTID
  AND AF.ACCTNO = CI.AFACCTNO
  AND AF.ACCTNO = V_GETBUY.AFACCTNO(+)
  AND AF.ACCTNO = V_GETSEC.AFACCTNO(+)
  AND AF.ACCTNO = ADV.AFACCTNO(+)
  AND AF.ACCTNO = LN.TRFACCTNO(+)
  AND AF.ACCTNO = RE.AFACCTNO(+)
  AND AF.CAREBY = GRP.GRPID
  AND AF.ADVANCELINE > 0
  AND AF.CAREBY IN (SELECT GRPID FROM TLGRPUSERS WHERE TLID = ''<$TELLERID>'')
) WHERE ADVANCELINE > T0CAL', 'LN0030', NULL, 'CUSTODYCD', null, null, 50, 'N', 30, 'NNNNYYYNNN', 'Y', 'T');
COMMIT;
/
--
--
/
DELETE searchfld WHERE searchcode = 'LN0030';
INSERT into searchfld (POSITION, FIELDCODE, FIELDNAME, FIELDTYPE, SEARCHCODE, FIELDSIZE, MASK, OPERATOR, FORMAT, DISPLAY, SRCH, KEY, WIDTH, LOOKUPCMDSQL, EN_FIELDNAME, REFVALUE, FLDCD, DEFVALUE, MULTILANG, ACDTYPE, ACDNAME, FIELDCMP, FIELDCMPKEY)
values (1, 'CUSTODYCD', 'Số tài khoản lưu ký', 'C', 'LN0030', 10, 'ccc.c.cccccc', 'LIKE,=', '_', 'Y', 'Y', 'N', 100, null, 'Custody code', 'N', null, null, 'N', null, null, null, 'N');
INSERT into searchfld (POSITION, FIELDCODE, FIELDNAME, FIELDTYPE, SEARCHCODE, FIELDSIZE, MASK, OPERATOR, FORMAT, DISPLAY, SRCH, KEY, WIDTH, LOOKUPCMDSQL, EN_FIELDNAME, REFVALUE, FLDCD, DEFVALUE, MULTILANG, ACDTYPE, ACDNAME, FIELDCMP, FIELDCMPKEY)
values (3, 'FULLNAME', 'Họ tên', 'C', 'LN0030', 100, null, 'LIKE,=', null, 'Y', 'Y', 'N', 150, null, 'Customer name', 'N', null, null, 'N', null, null, null, 'N');
INSERT into searchfld (POSITION, FIELDCODE, FIELDNAME, FIELDTYPE, SEARCHCODE, FIELDSIZE, MASK, OPERATOR, FORMAT, DISPLAY, SRCH, KEY, WIDTH, LOOKUPCMDSQL, EN_FIELDNAME, REFVALUE, FLDCD, DEFVALUE, MULTILANG, ACDTYPE, ACDNAME, FIELDCMP, FIELDCMPKEY)
values (5, 'AFACCTNO', 'Số tiểu khoản', 'C', 'LN0030', 10, 'cccccccccc', 'LIKE,=', '_', 'Y', 'Y', 'N', 100, null, 'Custody code', 'N', null, null, 'N', null, null, null, 'N');
INSERT into searchfld (POSITION, FIELDCODE, FIELDNAME, FIELDTYPE, SEARCHCODE, FIELDSIZE, MASK, OPERATOR, FORMAT, DISPLAY, SRCH, KEY, WIDTH, LOOKUPCMDSQL, EN_FIELDNAME, REFVALUE, FLDCD, DEFVALUE, MULTILANG, ACDTYPE, ACDNAME, FIELDCMP, FIELDCMPKEY)
values (7, 'ADVANCELINE', 'Bảo lãnh đã cấp', 'N', 'LN0030', 100, null, '<,<=,=,>=,>', '#,##0', 'Y', 'Y', 'N', 120, null, 'Advanceline', 'N', null, null, 'N', null, null, null, 'N');
INSERT into searchfld (POSITION, FIELDCODE, FIELDNAME, FIELDTYPE, SEARCHCODE, FIELDSIZE, MASK, OPERATOR, FORMAT, DISPLAY, SRCH, KEY, WIDTH, LOOKUPCMDSQL, EN_FIELDNAME, REFVALUE, FLDCD, DEFVALUE, MULTILANG, ACDTYPE, ACDNAME, FIELDCMP, FIELDCMPKEY)
values (9, 'T0CAL', 'Bảo lãnh hiện tại', 'N', 'LN0030', 100, null, '<,<=,=,>=,>', '#,##0', 'Y', 'Y', 'N', 120, null, 'T0cal', 'N', null, null, 'N', null, null, null, 'N');
INSERT into searchfld (POSITION, FIELDCODE, FIELDNAME, FIELDTYPE, SEARCHCODE, FIELDSIZE, MASK, OPERATOR, FORMAT, DISPLAY, SRCH, KEY, WIDTH, LOOKUPCMDSQL, EN_FIELDNAME, REFVALUE, FLDCD, DEFVALUE, MULTILANG, ACDTYPE, ACDNAME, FIELDCMP, FIELDCMPKEY)
values (11, 'REFULLNAME', 'BR quản lý', 'C', 'LN0030', 100, null, 'LIKE,=', null, 'Y', 'Y', 'N', 150, null, ' Re name', 'N', null, null, 'N', null, null, null, 'N');
INSERT into searchfld (POSITION, FIELDCODE, FIELDNAME, FIELDTYPE, SEARCHCODE, FIELDSIZE, MASK, OPERATOR, FORMAT, DISPLAY, SRCH, KEY, WIDTH, LOOKUPCMDSQL, EN_FIELDNAME, REFVALUE, FLDCD, DEFVALUE, MULTILANG, ACDTYPE, ACDNAME, FIELDCMP, FIELDCMPKEY)
values (13, 'CAREBY', 'Careby', 'C', 'LN0030', 200, null, '=,LIKE', null, 'Y', 'Y', 'N', 150, null, 'Remiser name', 'N', null, null, 'N', null, null, null, 'N');
COMMIT;
/
